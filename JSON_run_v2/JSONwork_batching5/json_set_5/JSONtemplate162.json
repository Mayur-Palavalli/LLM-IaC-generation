{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Template for one Linux and three Windows EC2 instances joined to Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document.", "Parameters": {"ADDirectoryId": {"Description": "The ID of the Active Directory to join.", "Type": "String"}, "InstanceType": {"Description": "EC2 Instance Type", "Type": "String", "Default": "t2.micro", "AllowedValues": ["t2.micro", "t2.small", "t2.medium"], "ConstraintDescription": "must be a valid EC2 instance type."}, "DNSServers": {"Description": "Optional: Comma-separated list of DNS servers (e.g., '8.8.8.8,8.8.4.4')", "Type": "CommaDelimitedList", "Default": ""}, "SSMRoleName": {"Description": "The name of the IAM Role for SSM.", "Type": "String"}}, "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-0ac80df6eff0e70b5", "IamInstanceProfile": {"Ref": "SSMRoleName"}, "Tags": [{"Key": "Name", "Value": "LinuxEC2Instance"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-09e67e426f25ce0d7", "IamInstanceProfile": {"Ref": "SSMRoleName"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance1"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-09e67e426f25ce0d7", "IamInstanceProfile": {"Ref": "SSMRoleName"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance2"}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-09e67e426f25ce0d7", "IamInstanceProfile": {"Ref": "SSMRoleName"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance3"}]}}, "LinuxSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxEC2Instance"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DNSServers"}]}]}}}, "WindowsSSMAssociation1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DNSServers"}]}]}}}, "WindowsSSMAssociation2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsEC2Instance2"}, {"Ref": "WindowsEC2Instance3"}]}], "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DNSServers"}]}]}}}, "TaggedWindowsSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsEC2Instance1"]}], "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DNSServers"}]}]}}}}}