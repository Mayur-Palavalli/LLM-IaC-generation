{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create an AD Connector to connect to an on-premises directory.", "Parameters": {"ADConnectorName": {"Type": "String", "Description": "The name of the AD Connector."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The list of subnet IDs for the AD Connector."}, "DomainControllers": {"Type": "CommaDelimitedList", "Description": "IP addresses of the Domain Controllers"}, "VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "The ID of the VPC."}, "CreateSecurityGroup": {"Type": "String", "AllowedValues": ["true", "false"], "Description": "Flag to create security group or not."}, "CreateDHCPOptions": {"Type": "String", "AllowedValues": ["true", "false"], "Description": "Flag to create DHCP options set or not."}, "EC2InstanceRole": {"Type": "String", "Description": "The IAM role for EC2 instance."}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "ADConnectorName"}, "Password": {"Fn::Sub": "{{resolve:ssm-secure:my-ad-password}}"}, "Edition": "Standard", "VpcSettings": {"SubnetIds": {"Ref": "SubnetIds"}, "VpcId": {"Ref": "VPCId"}}}}, "SeamlessDomainJoinManagementPolicy": {"Type": "AWS::IAM::Policy", "Properties": {"PolicyName": "SeamlessDomainJoinManagementPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:CreateComputer", "ds:DescribeDirectories"], "Resource": "*"}]}, "Roles": [{"Ref": "EC2InstanceRole"}]}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Condition": "CreateDomainMembersSecurityGroup", "Properties": {"GroupDescription": "Security group for domain members allowing all inbound PrivateIP communication.", "VpcId": {"Ref": "VPCId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "10.0.0.0/8"}]}}, "DHCPOptionsSet": {"Type": "AWS::EC2::DHCPOptions", "Condition": "CreateDHCPOptionsSet", "Properties": {"DomainNameServers": {"Ref": "DomainControllers"}, "NetbiosNodeType": 2}}, "DHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Condition": "CreateDHCPOptionsSet", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionsSet"}, "VpcId": {"Ref": "VPCId"}}}}, "Conditions": {"CreateDomainMembersSecurityGroup": {"Fn::Equals": [{"Ref": "CreateSecurityGroup"}, "true"]}, "CreateDHCPOptionsSet": {"Fn::Equals": [{"Ref": "CreateDHCPOptions"}, "true"]}}}