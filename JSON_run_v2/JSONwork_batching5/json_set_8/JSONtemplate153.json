{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create an AD Connector and related resources.", "Parameters": {"DirectoryName": {"Description": "The fully qualified name of the on-premises directory.", "Type": "String"}, "DnsIpAddresses": {"Description": "A list of DNS server IP addresses.", "Type": "List<String>"}, "SubnetIds": {"Description": "A list of Subnet IDs for the AD Connector.", "Type": "List<String>"}, "VPCId": {"Description": "The VPC to launch the AD Connector in.", "Type": "AWS::EC2::VPC::Id"}, "CreateSeamlessDomainJoin": {"Description": "Option to create seamless domain join resources.", "Type": "String", "AllowedValues": ["true", "false"], "Default": "false"}, "CreateDomainMembersSecurityGroup": {"Description": "Option to create a domain members security group.", "Type": "String", "AllowedValues": ["true", "false"], "Default": "false"}, "CreateDHCPOptionSet": {"Description": "Option to create DHCP Option Set.", "Type": "String", "AllowedValues": ["true", "false"], "Default": "false"}, "SecretIdName": {"Description": "The ID of the secret in Secrets Manager.", "Type": "String"}, "SecretKey": {"Description": "The key of the secret in Secrets Manager.", "Type": "String"}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::SimpleAD", "Properties": {"Name": {"Ref": "DirectoryName"}, "Password": {"Fn::Sub": "{{resolve:secretsmanager:${SecretIdName}:SecretString:${SecretKey}}}"}, "Size": "Small", "VpcSettings": {"SubnetIds": {"Ref": "SubnetIds"}, "VpcId": {"Ref": "VPCId"}}}}, "SeamlessDomainJoinEC2Role": {"Condition": "CreateSeamlessDomainJoinCondition", "Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "Policies": [{"PolicyName": "DomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:CreateComputer", "ds:DescribeDirectories"], "Resource": "*"}]}}]}}, "DomainMembersSecurityGroup": {"Condition": "CreateDomainMembersSecurityGroupCondition", "Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for domain members allowing Private IP communications", "VpcId": {"Ref": "VPCId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "SourceSecurityGroupId": "sg-12345678"}]}}, "DHCPOptionSet": {"Condition": "CreateDHCPOptionSetCondition", "Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainName": {"Ref": "DirectoryName"}, "DomainNameServers": {"Ref": "DnsIpAddresses"}}}, "DHCPOptionSetAssociation": {"Condition": "CreateDHCPOptionSetCondition", "Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionSet"}, "VpcId": {"Ref": "VPCId"}}}}, "Conditions": {"CreateSeamlessDomainJoinCondition": {"Fn::Equals": [{"Ref": "CreateSeamlessDomainJoin"}, "true"]}, "CreateDomainMembersSecurityGroupCondition": {"Fn::Equals": [{"Ref": "CreateDomainMembersSecurityGroup"}, "true"]}, "CreateDHCPOptionSetCondition": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "true"]}}}