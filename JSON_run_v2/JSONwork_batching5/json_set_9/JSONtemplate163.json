{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Template to create one Linux and three Windows EC2 instances and join them to an Active Directory using SSM.", "Resources": {"DirectoryService": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": "example.com", "Password": {"Fn::Sub": "{{resolve:ssm-secure:DirectoryServicePassword:1}}"}, "Edition": "Standard", "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": [{"Ref": "SubnetId1"}, {"Ref": "SubnetId2"}]}}}, "LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-xxxxxxxx", "InstanceType": "t2.micro", "KeyName": "your-key-name", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "SubnetId": {"Ref": "SubnetId1"}, "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}], "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-xxxxxxxx", "InstanceType": "t2.micro", "KeyName": "your-key-name", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "SubnetId": {"Ref": "SubnetId2"}, "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}], "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-xxxxxxxx", "InstanceType": "t2.micro", "KeyName": "your-key-name", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "SubnetId": {"Ref": "SubnetId1"}, "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}], "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-xxxxxxxx", "InstanceType": "t2.micro", "KeyName": "your-key-name", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "SubnetId": {"Ref": "SubnetId2"}, "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}], "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "SSMRole"}]}}, "SSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "Policies": [{"PolicyName": "SSMPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:SendCommand", "ssm:ListCommands", "ssm:ListCommandInvocations"], "Resource": "*"}]}}]}}, "SSMAssociationLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxEC2Instance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryService"}], "directoryName": ["example.com"]}}}, "SSMAssociationWindowsInstance1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryService"}], "directoryName": ["example.com"]}}}, "SSMAssociationWindowsInstance2And3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsEC2Instance2"}, {"Ref": "WindowsEC2Instance3"}]}], "Parameters": {"directoryId": [{"Ref": "DirectoryService"}], "directoryName": ["example.com"]}}}, "InstanceSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VpcId"}, "GroupDescription": "Security group for instances joining Active Directory"}}}, "Parameters": {"VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC Id"}, "SubnetId1": {"Type": "AWS::EC2::Subnet::Id", "Description": "The Subnet Id 1"}, "SubnetId2": {"Type": "AWS::EC2::Subnet::Id", "Description": "The Subnet Id 2"}}}