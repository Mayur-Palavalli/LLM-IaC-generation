{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Sample AWS CloudFormation Template to create an EKS Cluster on EC2", "Resources": {"EKSClusterRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "eks.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"]}}, "EKSNodeInstanceRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy", "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy", "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"]}}, "EKSCluster": {"Type": "AWS::EKS::Cluster", "Properties": {"Name": "MyEKSCluster", "RoleArn": {"Fn::GetAtt": ["EKSClusterRole", "Arn"]}, "ResourcesVpcConfig": {"SubnetIds": [{"Ref": "Subnet1"}, {"Ref": "Subnet2"}], "SecurityGroupIds": [{"Fn::GetAtt": ["EKSSecurityGroup", "GroupId"]}]}}}, "EKSSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for EKS Cluster", "VpcId": {"Ref": "VPC"}}}, "EKSLaunchTemplate": {"Type": "AWS::EC2::LaunchTemplate", "Properties": {"LaunchTemplateData": {"IamInstanceProfile": {"Arn": {"Ref": "NodeInstanceProfile"}}, "ImageId": {"Ref": "NodeImageId"}, "InstanceType": {"Ref": "NodeInstanceType"}, "SecurityGroupIds": [{"Fn::GetAtt": ["EKSSecurityGroup", "GroupId"]}], "KeyName": {"Ref": "KeyName"}}}}, "NodeInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "EKSNodeInstanceRole"}]}}, "NodeGroup": {"Type": "AWS::EKS::Nodegroup", "Properties": {"ClusterName": {"Ref": "EKSCluster"}, "NodeRole": {"Ref": "EKSNodeInstanceRole"}, "Subnets": [{"Ref": "Subnet1"}, {"Ref": "Subnet2"}], "ScalingConfig": {"DesiredSize": 2, "MaxSize": 4, "MinSize": 1}, "AmiType": "AL2_x86_64", "InstanceTypes": [{"Ref": "NodeInstanceType"}], "LaunchTemplate": {"Id": {"Ref": "EKSLaunchTemplate"}, "Version": "1"}}}}, "Parameters": {"VPC": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id"}, "Subnet1": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet Id 1"}, "Subnet2": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet Id 2"}, "NodeInstanceType": {"Type": "String", "Description": "EC2 instance type for the EKS nodes", "Default": "t3.medium"}, "NodeImageId": {"Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>", "Description": "AMI Id for the worker nodes", "Default": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Key pair name to access EKS nodes"}}, "Outputs": {"EKSClusterName": {"Description": "Name of the EKS Cluster", "Value": {"Ref": "EKSCluster"}}, "EKSNodeGroupName": {"Description": "Name of the EKS Node Group", "Value": {"Ref": "NodeGroup"}}}}