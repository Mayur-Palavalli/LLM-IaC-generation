{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create EC2 instances and join them to Active Directory using AWS-JoinDirectoryServiceDomain SSM document", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the AWS Directory Service to domain join."}, "LinuxInstanceType": {"Type": "String", "Default": "t2.micro", "Description": "EC2 instance type for the Linux instance."}, "WindowsInstanceType": {"Type": "String", "Default": "t2.micro", "Description": "EC2 instance type for the Windows instances."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "The EC2 Key Pair to allow SSH/RDP access to the instances."}, "DnsServers": {"Type": "CommaDelimitedList", "Description": "Optional DNS servers for the EC2 instances to use.", "Default": ""}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "The Subnet ID for the EC2 instances."}}, "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "LinuxInstanceType"}, "ImageId": {"Fn::FindInMap": ["AWSRegionArch2AMI", {"Ref": "AWS::Region"}, "Linux"]}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "InstanceProfile"}, "NetworkInterfaces": [{"AssociatePublicIpAddress": "true", "DeviceIndex": "0", "SubnetId": {"Ref": "SubnetId"}}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": {"Fn::FindInMap": ["AWSRegionArch2AMI", {"Ref": "AWS::Region"}, "Windows"]}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "InstanceProfile"}, "NetworkInterfaces": [{"AssociatePublicIpAddress": "true", "DeviceIndex": "0", "SubnetId": {"Ref": "SubnetId"}}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": {"Fn::FindInMap": ["AWSRegionArch2AMI", {"Ref": "AWS::Region"}, "Windows"]}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "InstanceProfile"}, "NetworkInterfaces": [{"AssociatePublicIpAddress": "true", "DeviceIndex": "0", "SubnetId": {"Ref": "SubnetId"}}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": {"Fn::FindInMap": ["AWSRegionArch2AMI", {"Ref": "AWS::Region"}, "Windows"]}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "InstanceProfile"}, "NetworkInterfaces": [{"AssociatePublicIpAddress": "true", "DeviceIndex": "0", "SubnetId": {"Ref": "SubnetId"}}]}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "EC2Role"}]}}, "EC2Role": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "SSMPermissions", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:SendCommand", "ssm:ListCommands", "ssm:ListCommandInvocations", "ec2:DescribeInstances", "ec2:DescribeTags"], "Resource": "*"}]}}]}}, "LinuxEC2SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxEC2Instance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}]}}}, "WindowsEC2SSMAssociation1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}]}}}, "WindowsEC2SSMAssociation2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance2"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}]}}}, "WindowsEC2SSMAssociation3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance3"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}]}}}}, "Mappings": {"AWSRegionArch2AMI": {"us-east-1": {"Linux": "ami-0c55b159cbfafe1f0", "Windows": "ami-0b69ea66ff7391e80"}, "us-west-2": {"Linux": "ami-0bb6af715826253bf", "Windows": "ami-0916bcb5fa77e4892"}}}, "Outputs": {"LinuxInstanceId": {"Description": "ID of the Linux EC2 instance", "Value": {"Ref": "LinuxEC2Instance"}}, "WindowsInstanceId1": {"Description": "ID of the first Windows EC2 instance", "Value": {"Ref": "WindowsEC2Instance1"}}, "WindowsInstanceId2": {"Description": "ID of the second Windows EC2 instance", "Value": {"Ref": "WindowsEC2Instance2"}}, "WindowsInstanceId3": {"Description": "ID of the third Windows EC2 instance", "Value": {"Ref": "WindowsEC2Instance3"}}}}