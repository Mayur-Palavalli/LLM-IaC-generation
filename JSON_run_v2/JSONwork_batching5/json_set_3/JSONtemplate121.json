{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to provision an AWS Neptune Graph Database with CI/CD using AWS CodePipeline, AWS CloudWatch, and AWS SNS.", "Resources": {"NeptuneDBClusterParameterGroup": {"Type": "AWS::Neptune::DBClusterParameterGroup", "Properties": {"Description": "Neptune DB Cluster Parameter Group", "Family": "neptune1", "Parameters": {"neptune_enable_audit_log": "1"}}}, "NeptuneDBCluster": {"Type": "AWS::Neptune::DBCluster", "Properties": {"DBClusterIdentifier": "my-neptune-cluster", "DBClusterParameterGroupName": {"Ref": "NeptuneDBClusterParameterGroup"}, "EngineVersion": "1.0.4.0", "BackupRetentionPeriod": 1, "PreferredBackupWindow": "00:00-01:00", "PreferredMaintenanceWindow": "sun:23:45-mon:00:15", "StorageEncrypted": true}}, "NeptuneDBInstance": {"Type": "AWS::Neptune::DBInstance", "Properties": {"DBInstanceClass": "db.r5.large", "DBClusterIdentifier": {"Ref": "NeptuneDBCluster"}, "AvailabilityZone": "us-west-2a"}}, "NeptuneClusterRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "neptune.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "NeptuneCloudWatchPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["cloudwatch:PutMetricData"], "Resource": ["*"]}]}}], "Path": "/"}}, "CodePipelineRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "codepipeline.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "CodePipelinePolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["*"], "Resource": ["*"]}]}}], "Path": "/"}}, "PipelineSNS": {"Type": "AWS::SNS::Topic", "Properties": {"DisplayName": "CodePipeline Alerts"}}, "CloudWatchAlarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"AlarmDescription": "Alarm if Neptune CPU exceeds 80%", "Namespace": "AWS/Neptune", "MetricName": "CPUUtilization", "Statistic": "Average", "Period": 300, "EvaluationPeriods": 1, "Threshold": 80, "ComparisonOperator": "GreaterThanThreshold", "AlarmActions": [{"Ref": "PipelineSNS"}]}}}, "Outputs": {"NeptuneEndpoint": {"Description": "Endpoint of the Neptune Cluster", "Value": {"Fn::GetAtt": ["NeptuneDBCluster", "Endpoint"]}}}}