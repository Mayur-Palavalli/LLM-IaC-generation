{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Template to create one Linux and three Windows EC2 instances and join them to an Active Directory using SSM.", "Resources": {"DirectoryService": {"Type": "AWS::DirectoryService::Directory", "Properties": {"Name": "example.com", "Password": "SuperSecretPassword!", "Size": "Small", "VpcSettings": {"VpcId": "vpc-xxxxxxxx", "SubnetIds": ["subnet-xxxxxxxx", "subnet-xxxxxxxx"]}}}, "LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-xxxxxxxx", "InstanceType": "t2.micro", "KeyName": "your-key-name", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "SubnetId": "subnet-xxxxxxxx", "SecurityGroupIds": ["sg-xxxxxxxx"], "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-xxxxxxxx", "InstanceType": "t2.micro", "KeyName": "your-key-name", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "SubnetId": "subnet-xxxxxxxx", "SecurityGroupIds": ["sg-xxxxxxxx"], "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-xxxxxxxx", "InstanceType": "t2.micro", "KeyName": "your-key-name", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "SubnetId": "subnet-xxxxxxxx", "SecurityGroupIds": ["sg-xxxxxxxx"], "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-xxxxxxxx", "InstanceType": "t2.micro", "KeyName": "your-key-name", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "SubnetId": "subnet-xxxxxxxx", "SecurityGroupIds": ["sg-xxxxxxxx"], "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "SSMRole"}]}}, "SSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "Policies": [{"PolicyName": "SSMPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:SendCommand", "ssm:ListCommands", "ssm:ListCommandInvocations"], "Resource": "*"}]}}]}}, "SSMAssociationLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxEC2Instance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryService"}], "directoryName": ["example.com"]}}}, "SSMAssociationWindowsInstance1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryService"}], "directoryName": ["example.com"]}}}, "SSMAssociationWindowsInstance2_And_3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsEC2Instance2"}, {"Ref": "WindowsEC2Instance3"}]}], "Parameters": {"directoryId": [{"Ref": "DirectoryService"}], "directoryName": ["example.com"]}}}}}