{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation Template to provision AWS Neptune Graph Database with CI/CD through AWS CodePipeline, monitoring with CloudWatch, and notifications via SNS.", "Resources": {"NeptuneDBCluster": {"Type": "AWS::Neptune::DBCluster", "Properties": {"BackupRetentionPeriod": 7, "DBClusterIdentifier": "neptune-cluster", "Port": 8182, "MasterUsername": {"Ref": "DBMasterUser"}, "MasterUserPassword": {"Ref": "DBMasterPassword"}, "DBSubnetGroupName": {"Ref": "NeptuneSubnetGroup"}, "VpcSecurityGroupIds": [{"Fn::GetAtt": ["NeptuneSecurityGroup", "GroupId"]}]}}, "NeptuneDBInstance": {"Type": "AWS::Neptune::DBInstance", "Properties": {"DBInstanceClass": "db.r5.large", "DBClusterIdentifier": {"Ref": "NeptuneDBCluster"}}}, "NeptuneSubnetGroup": {"Type": "AWS::Neptune::DBSubnetGroup", "Properties": {"DBSubnetGroupDescription": "Subnet group for Neptune DB cluster", "SubnetIds": {"Ref": "Subnets"}}}, "NeptuneSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security Group for Neptune DB Cluster", "VpcId": {"Ref": "VpcId"}}}, "CodeCommitRepository": {"Type": "AWS::CodeCommit::Repository", "Properties": {"RepositoryName": "neptune-code-repo", "RepositoryDescription": "Code repository for Neptune DB CI/CD"}}, "CodePipeline": {"Type": "AWS::CodePipeline::Pipeline", "Properties": {"RoleArn": {"Fn::GetAtt": ["CodePipelineRole", "Arn"]}, "Stages": [{"Name": "Source", "Actions": [{"Name": "SourceAction", "ActionTypeId": {"Category": "Source", "Owner": "AWS", "Provider": "CodeCommit", "Version": "1"}, "OutputArtifacts": [{"Name": "SourceOutput"}], "Configuration": {"BranchName": "main", "RepositoryName": {"Ref": "CodeCommitRepository"}}}]}, {"Name": "Deploy", "Actions": [{"Name": "DeployAction", "ActionTypeId": {"Category": "Deploy", "Owner": "AWS", "Provider": "CloudFormation", "Version": "1"}, "InputArtifacts": [{"Name": "SourceOutput"}], "Configuration": {"StackName": "NeptuneGraphDBStack", "Capabilities": "CAPABILITY_NAMED_IAM", "ActionMode": "CREATE_UPDATE", "RoleArn": {"Fn::GetAtt": ["CloudFormationRole", "Arn"]}, "TemplatePath": "SourceOutput::template.yaml"}}]}], "ArtifactStore": {"Type": "S3", "Location": {"Ref": "ArtifactBucket"}}}}, "ArtifactBucket": {"Type": "AWS::S3::Bucket", "Properties": {"BucketName": "neptune-artifact-bucket"}}, "CodePipelineRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "codepipeline.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "CodePipelinePolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["s3:*", "codecommit:*", "cloudformation:*", "iam:PassRole"], "Resource": "*"}]}}]}}, "CloudFormationRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "cloudformation.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "CloudFormationPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["neptune:*", "s3:*", "ec2:*"], "Resource": "*"}]}}]}}, "NeptuneClusterAlarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"AlarmName": "NeptuneClusterAlarm", "AlarmDescription": "Alarm for Neptune DB Cluster", "MetricName": "CPUUtilization", "Namespace": "AWS/Neptune", "Statistic": "Average", "Period": "60", "EvaluationPeriods": "3", "Threshold": "80", "ComparisonOperator": "GreaterThanThreshold", "Dimensions": [{"Name": "DBClusterIdentifier", "Value": {"Ref": "NeptuneDBCluster"}}], "AlarmActions": [{"Ref": "SNSAlarmTopic"}]}}, "SNSAlarmTopic": {"Type": "AWS::SNS::Topic", "Properties": {"TopicName": "NeptuneClusterAlarms", "Subscription": [{"Endpoint": {"Ref": "AlarmEmail"}, "Protocol": "email"}]}}}, "Parameters": {"VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC ID for the Neptune DB Cluster"}, "Subnets": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "Subnet IDs for the Neptune DB Cluster"}, "DBMasterUser": {"Type": "String", "Description": "The master username for the Neptune DB", "MinLength": "1", "MaxLength": "16", "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*", "ConstraintDescription": "The master username must begin with a letter and contain only alphanumeric characters."}, "DBMasterPassword": {"Type": "String", "Description": "The master password for the Neptune DB", "MinLength": "8", "MaxLength": "41", "NoEcho": true}, "AlarmEmail": {"Type": "String", "Description": "Email address to notify if there are alarm state changes"}}}