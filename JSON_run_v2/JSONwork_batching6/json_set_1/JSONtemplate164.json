{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document.", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the Directory Service instance to which the instances will be joined."}, "DNS1": {"Type": "String", "Default": "", "Description": "Primary DNS server. Leave blank if using default DNS settings."}, "DNS2": {"Type": "String", "Default": "", "Description": "Secondary DNS server. Leave blank if using default DNS settings."}}, "Mappings": {"RegionMap": {"us-east-1": {"AMI": "ami-0c2b8ca1dad447f8a"}, "us-west-2": {"AMI": "ami-0d6621c01e8c2de2c"}}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.micro", "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "AMI"]}, "KeyName": "my-key-pair"}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.micro", "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "AMI"]}, "KeyName": "my-key-pair"}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.micro", "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "AMI"]}, "KeyName": "my-key-pair"}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.micro", "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "AMI"]}, "KeyName": "my-key-pair", "Tags": [{"Key": "DomainJoin", "Value": "true"}]}}, "SSMAssociation1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "SSMAssociation2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "LinuxInstance"}, {"Ref": "WindowsInstance2"}]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "SSMAssociation3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:DomainJoin", "Values": ["true"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}}, "Outputs": {"LinuxInstanceId": {"Description": "The InstanceId of the Linux EC2 instance", "Value": {"Ref": "LinuxInstance"}}, "WindowsInstanceId1": {"Description": "The InstanceId of the first Windows EC2 instance", "Value": {"Ref": "WindowsInstance1"}}, "WindowsInstanceId2": {"Description": "The InstanceId of the second Windows EC2 instance", "Value": {"Ref": "WindowsInstance2"}}, "WindowsInstanceId3": {"Description": "The InstanceId of the third Windows EC2 instance", "Value": {"Ref": "WindowsInstance3"}}}}