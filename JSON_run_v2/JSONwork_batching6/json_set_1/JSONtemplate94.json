{"AWSTemplateFormatVersion": "2010-09-09", "Resources": {"WebAppLoadBalancer": {"Type": "AWS::ElasticLoadBalancingV2::LoadBalancer", "Properties": {"Name": "WebAppLoadBalancer", "Subnets": {"Fn::If": ["HasSingleAZ", [{"Ref": "SubnetA"}], [{"Ref": "SubnetA"}, {"Ref": "SubnetB"}]]}}}, "LoadBalancerListener": {"Type": "AWS::ElasticLoadBalancingV2::Listener", "Properties": {"DefaultActions": [{"Type": "forward", "TargetGroupArn": {"Ref": "WebAppTargetGroup"}}], "LoadBalancerArn": {"Ref": "WebAppLoadBalancer"}, "Port": 80, "Protocol": "HTTP"}}, "WebAppTargetGroup": {"Type": "AWS::ElasticLoadBalancingV2::TargetGroup", "Properties": {"Name": "WebAppTargetGroup", "Port": 8888, "Protocol": "HTTP", "VpcId": {"Ref": "VpcId"}, "HealthCheckEnabled": true, "HealthCheckPath": "/", "HealthCheckPort": "traffic-port", "HealthCheckProtocol": "HTTP", "Matcher": {"HttpCode": "200-299"}}}, "EC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0example", "InstanceType": "t2.micro", "SubnetId": {"Fn::If": ["HasSingleAZ", {"Ref": "SubnetA"}, {"Ref": "SubnetA"}]}, "SecurityGroupIds": [{"Ref": "WebAppSecurityGroup"}]}}, "EC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0example", "InstanceType": "t2.micro", "SubnetId": {"Fn::If": ["HasSingleAZ", {"Ref": "SubnetA"}, {"Ref": "SubnetB"}]}, "SecurityGroupIds": [{"Ref": "WebAppSecurityGroup"}]}}, "WebAppSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Enable access to the web instances", "VpcId": {"Ref": "VpcId"}, "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 8888, "ToPort": 8888, "CidrIp": "0.0.0.0/0"}]}}}, "Parameters": {"VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC ID"}, "SubnetA": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet A ID"}, "SubnetB": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet B ID", "Default": "", "Condition": "HasMultipleAZs"}}, "Conditions": {"HasSingleAZ": {"Fn::Equals": [{"Ref": "SubnetB"}, ""]}, "HasMultipleAZs": {"Fn::Not": [{"Condition": "HasSingleAZ"}]}}, "Outputs": {"LoadBalancerDNSName": {"Value": {"Fn::GetAtt": ["WebAppLoadBalancer", "DNSName"]}}}}