{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for Linux and Windows EC2 instances that join an Active Directory using AWS Systems Manager (SSM).", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the AWS Managed AD or AD Connector."}, "DomainName": {"Type": "String", "Description": "The fully qualified name of the Active Directory domain."}, "InstanceType": {"Type": "String", "Default": "t2.micro", "AllowedValues": ["t2.micro", "t2.small", "t2.medium"], "Description": "EC2 instance type."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances."}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet Id within the VPC."}, "DNSAddresses": {"Type": "CommaDelimitedList", "Description": "Optional list of DNS server IP addresses."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "AMI"]}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "LinuxInstance"}, {"Key": "SSMAssociation", "Value": "Linux"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}, {"Key": "SSMAssociation", "Value": "Windows"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}, {"Key": "SSMAssociation", "Value": "Windows"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}, {"Key": "SSMAssociation", "Value": "Windows"}]}}, "SSMAssociationLinuxInstance": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": [{"Fn::If": ["UseCustomDNS", {"Fn::Join": [",", {"Ref": "DNSAddresses"}]}, {"Ref": "AWS::NoValue"}]}]}}}, "SSMAssociationWindowsInstance1Inline": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": [{"Fn::If": ["UseCustomDNS", {"Fn::Join": [",", {"Ref": "DNSAddresses"}]}, {"Ref": "AWS::NoValue"}]}]}}}, "SSMAssociationWindowsInstancesByTags": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:SSMAssociation", "Values": ["Windows"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": [{"Fn::If": ["UseCustomDNS", {"Fn::Join": [",", {"Ref": "DNSAddresses"}]}, {"Ref": "AWS::NoValue"}]}]}}}}, "Mappings": {"RegionMap": {"us-east-1": {"AMI": "ami-0c55b159cbfafe1f0", "WindowsAMI": "ami-0f3aad7d8af36a944"}, "us-west-2": {"AMI": "ami-0dd655843c87b6930", "WindowsAMI": "ami-0c28dbb16db779a1b"}}}, "Conditions": {"UseCustomDNS": {"Fn::Not": [{"Fn::Equals": [{"Fn::Join": ["", {"Ref": "DNSAddresses"}]}, ""]}]}}}