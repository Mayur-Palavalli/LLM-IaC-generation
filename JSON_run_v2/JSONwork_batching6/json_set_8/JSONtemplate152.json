{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Template for setting up an AD Connector to connect to an on-premises directory.", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the on-premises directory to connect to."}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC ID for the AD Connector."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The subnets for the AD Connector."}, "DnsIpAddresses": {"Type": "List<String>", "Description": "The IP addresses of the DNS servers for the DHCP Option Set."}, "ADConnectorPassword": {"Type": "String", "Description": "The password for the AD Connector.", "NoEcho": true}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::SimpleAD", "Properties": {"Name": "onprem-ad-connector", "Password": {"Fn::Sub": "{{resolve:secretsmanager:${ADConnectorPassword}}}"}, "Size": "Small", "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Ref": "SubnetIds"}}, "ShortName": "ad", "EnableSso": true, "Description": "An AD Connector for connecting to on-premises directory"}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for domain members allowing all PrivateIP communication", "VpcId": {"Ref": "VpcId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "SourceSecurityGroupId": {"Ref": "VpcId"}}]}}, "DHCPOptionsSet": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Ref": "DnsIpAddresses"}, "DomainName": "domain.local"}}, "DHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"VpcId": {"Ref": "VpcId"}, "DhcpOptionsId": {"Ref": "DHCPOptionsSet"}}}, "SeamlessDomainJoinRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "Policies": [{"PolicyName": "SeamlessDomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:DescribeDirectories", "ds:CreateComputer"], "Resource": "*"}]}}]}}, "DirectoryServiceInstance": {"Type": "AWS::DirectoryService::SimpleAD", "Properties": {"Name": "onprem-directory", "Password": {"Fn::Sub": "{{resolve:secretsmanager:${ADConnectorPassword}}}"}, "Size": "Small", "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Ref": "SubnetIds"}}, "Type": "ADConnector", "ConnectSettings": {"CustomerDnsIps": {"Ref": "DnsIpAddresses"}, "CustomerUserName": "Admin", "CustomerPassword": {"Ref": "ADConnectorPassword"}, "ConnectIps": {"Ref": "DirectoryId"}}}}}, "Outputs": {"ADConnectorId": {"Value": {"Ref": "ADConnector"}, "Description": "The ID of the created AD Connector."}, "SecurityGroupId": {"Value": {"Ref": "DomainMembersSecurityGroup"}, "Description": "The Security Group ID for domain members."}, "DHCPOptionsSetId": {"Value": {"Ref": "DHCPOptionsSet"}, "Description": "The ID of the created DHCP Option Set."}, "DirectoryServiceInstanceId": {"Value": {"Ref": "DirectoryServiceInstance"}, "Description": "The ID of the created Directory Service Instance."}}}