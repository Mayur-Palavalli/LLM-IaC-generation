{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template for setting up an AD Connector to connect to an on-premises directory, with optional resources for seamless domain join, security group, and DHCP Option Set.", "Parameters": {"DomainName": {"Type": "String", "Description": "The fully qualified name of the on-premises domain."}, "DnsIpAddresses": {"Type": "CommaDelimitedList", "Description": "A list of IP addresses of DNS servers for the on-premises domain."}, "Subnets": {"Type": "CommaDelimitedList", "Description": "Subnets in which the AD Connector will be created."}, "VPC": {"Type": "String", "Description": "The ID of the VPC where the resources are created."}, "CreateSeamlessDomainJoin": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Whether to create seamless domain join resources for Windows & Linux EC2 instances."}, "CreateDomainMembersSG": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Whether to create a domain members security group that allows all PrivateIP communications inbound."}, "CreateDHCPOptionSet": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Whether to create a DHCPOptionSet pointing to the Domain DNS servers."}}, "Resources": {"SeamlessDomainJoinRole": {"Type": "AWS::IAM::Role", "Condition": "CreateSeamlessDomainJoinResources", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ssm.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "SeamlessDomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:DescribeDirectories", "ds:CreateComputer", "ds:DeleteComputer"], "Resource": "*"}]}}]}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Condition": "CreateDomainMembersSGResource", "Properties": {"GroupDescription": "Security group for domain members allowing all private IP communication.", "VpcId": {"Ref": "VPC"}, "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 0, "ToPort": 65535, "CidrIp": "10.0.0.0/8"}, {"IpProtocol": "udp", "FromPort": 0, "ToPort": 65535, "CidrIp": "10.0.0.0/8"}]}}, "DHCPOptionSet": {"Type": "AWS::EC2::DHCPOptions", "Condition": "CreateDHCPOptionSetResource", "Properties": {"DomainName": {"Ref": "DomainName"}, "DomainNameServers": {"Ref": "DnsIpAddresses"}}}, "VPCDHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Condition": "CreateDHCPOptionSetResource", "Properties": {"VpcId": {"Ref": "VPC"}, "DhcpOptionsId": {"Ref": "DHCPOptionSet"}}}, "ADConnector": {"Type": "AWS::DirectoryService::SimpleAD", "Properties": {"Name": {"Ref": "DomainName"}, "Password": {"Fn::Sub": "{{resolve:ssm-secure:/adconnector/password:1}}"}, "Size": "Small", "VpcSettings": {"VpcId": {"Ref": "VPC"}, "SubnetIds": {"Ref": "Subnets"}}}}}, "Conditions": {"CreateSeamlessDomainJoinResources": {"Fn::Equals": [{"Ref": "CreateSeamlessDomainJoin"}, "true"]}, "CreateDomainMembersSGResource": {"Fn::Equals": [{"Ref": "CreateDomainMembersSG"}, "true"]}, "CreateDHCPOptionSetResource": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "true"]}}, "Outputs": {"SeamlessDomainJoinRole": {"Condition": "CreateSeamlessDomainJoinResources", "Value": {"Ref": "SeamlessDomainJoinRole"}, "Description": "IAM Role for Seamless Domain Join."}, "DomainMembersSecurityGroup": {"Condition": "CreateDomainMembersSGResource", "Value": {"Ref": "DomainMembersSecurityGroup"}, "Description": "Security Group for Domain Members."}, "DHCPOptionSet": {"Condition": "CreateDHCPOptionSetResource", "Value": {"Ref": "DHCPOptionSet"}, "Description": "DHCP Option Set for Domain DNS servers."}}}