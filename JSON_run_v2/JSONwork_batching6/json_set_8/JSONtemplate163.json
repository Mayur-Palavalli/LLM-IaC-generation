{"AWSTemplateFormatVersion": "2010-09-09", "Resources": {"ADDirectory": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": "example.com", "Password": {"Ref": "ADPassword"}, "VpcSettings": {"VpcId": "vpc-12345678", "SubnetIds": ["subnet-12345678", "subnet-87654321"]}}}, "ADPassword": {"Type": "AWS::SecretsManager::Secret", "Description": "Password for AD Directory"}, "LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.medium", "ImageId": "ami-0abcdef1234567890", "KeyName": "my-key-pair", "SubnetId": "subnet-12345678", "SecurityGroupIds": ["sg-12345678"], "IamInstanceProfile": {"Ref": "SSMInstanceProfile"}, "Tags": [{"Key": "Role", "Value": "Linux"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.medium", "ImageId": "ami-0abcdef1234567891", "KeyName": "my-key-pair", "SubnetId": "subnet-12345678", "SecurityGroupIds": ["sg-12345678"], "IamInstanceProfile": {"Ref": "SSMInstanceProfile"}, "Tags": [{"Key": "Role", "Value": "Windows1"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.medium", "ImageId": "ami-0abcdef1234567891", "KeyName": "my-key-pair", "SubnetId": "subnet-87654321", "SecurityGroupIds": ["sg-12345678"], "IamInstanceProfile": {"Ref": "SSMInstanceProfile"}, "Tags": [{"Key": "Role", "Value": "Windows2"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.medium", "ImageId": "ami-0abcdef1234567891", "KeyName": "my-key-pair", "SubnetId": "subnet-87654321", "SecurityGroupIds": ["sg-12345678"], "IamInstanceProfile": {"Ref": "SSMInstanceProfile"}, "Tags": [{"Key": "Role", "Value": "Windows3"}]}}, "SSMInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Path": "/", "Roles": [{"Ref": "SSMRole"}]}}, "SSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "Policies": [{"PolicyName": "SSMPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:DescribeAssociation", "ssm:GetDeployablePatchSnapshotForInstance", "ssm:GetDocument", "ssm:DescribeDocument", "ssm:GetParameter", "ssm:GetParameters", "ssm:ListAssociations", "ssm:ListInstanceAssociations", "ssm:PutInventory", "ssm:PutComplianceItems", "ssm:PutConfigurePackageResult", "ssm:UpdateAssociationStatus", "ssm:UpdateInstanceAssociationStatus", "ssm:UpdateInstanceInformation"], "Resource": "*"}]}}]}}, "JoinDomainAssociation1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "ADDirectory"}], "directoryName": ["example.com"]}}}, "JoinDomainAssociation2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "LinuxInstance"}, {"Ref": "WindowsInstance2"}]}], "Parameters": {"directoryId": [{"Ref": "ADDirectory"}], "directoryName": ["example.com"]}}}, "JoinDomainAssociation3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Role", "Values": ["Windows3"]}], "Parameters": {"directoryId": [{"Ref": "ADDirectory"}], "directoryName": ["example.com"]}}}}}