{"AWSTemplateFormatVersion": "2010-09-09", "Resources": {"VPC": {"Type": "AWS::EC2::VPC", "Properties": {"CidrBlock": "10.0.0.0/16", "EnableDnsSupport": true, "EnableDnsHostnames": true, "Tags": [{"Key": "Name", "Value": "AuroraVPC"}]}}, "Subnet1": {"Type": "AWS::EC2::Subnet", "Properties": {"VpcId": {"Ref": "VPC"}, "CidrBlock": "10.0.1.0/24", "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]}, "Tags": [{"Key": "Name", "Value": "Subnet1"}]}}, "Subnet2": {"Type": "AWS::EC2::Subnet", "Properties": {"VpcId": {"Ref": "VPC"}, "CidrBlock": "10.0.2.0/24", "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]}, "Tags": [{"Key": "Name", "Value": "Subnet2"}]}}, "DBCluster": {"Type": "AWS::RDS::DBCluster", "Properties": {"Engine": "aurora-mysql", "MasterUsername": "admin", "MasterUserPassword": {"Ref": "DBClusterPassword"}, "DBSubnetGroupName": {"Ref": "DBSubnetGroup"}, "VpcSecurityGroupIds": [{"Ref": "DBSecurityGroup"}]}}, "DBInstance": {"Type": "AWS::RDS::DBInstance", "Properties": {"DBClusterIdentifier": {"Ref": "DBCluster"}, "DBInstanceClass": "db.r5.large", "Engine": "aurora-mysql"}}, "DBSubnetGroup": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"DBSubnetGroupDescription": "Aurora subnet group", "SubnetIds": [{"Ref": "Subnet1"}, {"Ref": "Subnet2"}]}}, "DBSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPC"}, "GroupDescription": "RDS security group", "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": "3306", "ToPort": "3306", "CidrIp": "0.0.0.0/0"}]}}, "S3Bucket": {"Type": "AWS::S3::Bucket", "Properties": {"BucketName": "my-dms-target-bucket"}}, "DMSSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPC"}, "GroupDescription": "DMS security group", "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": "3306", "ToPort": "3306", "SourceSecurityGroupId": {"Ref": "DBSecurityGroup"}}]}}, "DMSSubnetGroup": {"Type": "AWS::DMS::ReplicationSubnetGroup", "Properties": {"ReplicationSubnetGroupIdentifier": "dms-subnet-group", "ReplicationSubnetGroupDescription": "Subnet group for DMS replication instance", "SubnetIds": [{"Ref": "Subnet1"}, {"Ref": "Subnet2"}]}}, "DMSReplicationInstance": {"Type": "AWS::DMS::ReplicationInstance", "Properties": {"ReplicationInstanceClass": "dms.r5.large", "VpcSecurityGroupIds": [{"Ref": "DMSSecurityGroup"}], "ReplicationSubnetGroupIdentifier": {"Ref": "DMSSubnetGroup"}}}, "DMSSourceEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointIdentifier": "aurora-source-endpoint", "EndpointType": "source", "EngineName": "aurora-mysql", "Username": "admin", "Password": {"Ref": "DMSSourceEndpointPassword"}, "DatabaseName": "yourdatabase", "ServerName": {"Fn::GetAtt": ["DBCluster", "Endpoint.Address"]}, "Port": 3306}}, "DMSTargetEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointIdentifier": "s3-target-endpoint", "EndpointType": "target", "EngineName": "s3", "S3Settings": {"BucketName": {"Ref": "S3Bucket"}, "BucketFolder": "migrations", "CompressionType": "NONE"}}}, "DMSReplicationTask": {"Type": "AWS::DMS::ReplicationTask", "Properties": {"MigrationType": "full-load-and-cdc", "ReplicationTaskIdentifier": "aurora-to-s3-task", "SourceEndpointArn": {"Fn::GetAtt": ["DMSSourceEndpoint", "Id"]}, "TargetEndpointArn": {"Fn::GetAtt": ["DMSTargetEndpoint", "Id"]}, "ReplicationInstanceArn": {"Fn::GetAtt": ["DMSReplicationInstance", "Id"]}, "TableMappings": "{ \"rules\": [{ \"rule-type\": \"selection\", \"rule-id\": \"1\", \"rule-name\": \"1\", \"object-locator\": { \"schema-name\": \"%\", \"table-name\": \"%\" }, \"rule-action\": \"include\" }]}"}}}, "Parameters": {"DBClusterPassword": {"Type": "String", "NoEcho": true, "Description": "Password for the RDS DBCluster"}, "DMSSourceEndpointPassword": {"Type": "String", "NoEcho": true, "Description": "Password for the DMS source endpoint"}}}