{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for one Linux and three Windows EC2 instances joined to Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document.", "Parameters": {"InstanceType": {"Type": "String", "Description": "EC2 instance type", "Default": "t2.micro", "AllowedValues": ["t2.micro", "t2.small", "t2.medium", "t2.large"], "ConstraintDescription": "must be a valid EC2 instance type."}, "ADDomainName": {"Type": "String", "Description": "The domain name of the Active Directory."}, "ADDomainId": {"Type": "String", "Description": "The Directory ID of the AWS Managed AD or AD Connector."}, "DNS1": {"Type": "String", "Description": "Primary DNS server for AD domain (optional, leave empty for default).", "Default": ""}, "DNS2": {"Type": "String", "Description": "Secondary DNS server for AD domain (optional, leave empty for default).", "Default": ""}}, "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-0abcdef12345abcde", "KeyName": "your-key-name", "SecurityGroupIds": ["sg-0123456789abcdef0"], "SubnetId": "subnet-0123456789abcdef0", "IamInstanceProfile": "your-iam-instance-profile", "Tags": [{"Key": "Name", "Value": "Linux-EC2Instance"}, {"Key": "DomainJoin", "Value": "true"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-0abcdef12345abcde", "KeyName": "your-key-name", "SecurityGroupIds": ["sg-0123456789abcdef0"], "SubnetId": "subnet-0123456789abcdef0", "IamInstanceProfile": "your-iam-instance-profile", "Tags": [{"Key": "Name", "Value": "Windows-EC2Instance1"}, {"Key": "DomainJoin", "Value": "true"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-0abcdef12345abcde", "KeyName": "your-key-name", "SecurityGroupIds": ["sg-0123456789abcdef0"], "SubnetId": "subnet-0123456789abcdef0", "IamInstanceProfile": "your-iam-instance-profile", "Tags": [{"Key": "Name", "Value": "Windows-EC2Instance2"}, {"Key": "DomainJoin", "Value": "true"}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-0abcdef12345abcde", "KeyName": "your-key-name", "SecurityGroupIds": ["sg-0123456789abcdef0"], "SubnetId": "subnet-0123456789abcdef0", "IamInstanceProfile": "your-iam-instance-profile", "Tags": [{"Key": "Name", "Value": "Windows-EC2Instance3"}, {"Key": "DomainJoin", "Value": "true"}]}}, "SSMAssociationInline": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "ADDomainId"}], "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Ref": "DNS1"}, {"Ref": "DNS2"}]}}}, "SSMAssociationInstanceIDs": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "LinuxEC2Instance"}, {"Ref": "WindowsEC2Instance2"}, {"Ref": "WindowsEC2Instance3"}]}], "Parameters": {"directoryId": [{"Ref": "ADDomainId"}], "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Ref": "DNS1"}, {"Ref": "DNS2"}]}}}, "SSMAssociationTags": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:DomainJoin", "Values": ["true"]}], "Parameters": {"directoryId": [{"Ref": "ADDomainId"}], "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Ref": "DNS1"}, {"Ref": "DNS2"}]}}}}, "Outputs": {"LinuxInstanceId": {"Description": "The instance ID of the Linux EC2 instance", "Value": {"Ref": "LinuxEC2Instance"}}, "WindowsInstance1Id": {"Description": "The instance ID of the first Windows EC2 instance", "Value": {"Ref": "WindowsEC2Instance1"}}, "WindowsInstance2Id": {"Description": "The instance ID of the second Windows EC2 instance", "Value": {"Ref": "WindowsEC2Instance2"}}, "WindowsInstance3Id": {"Description": "The instance ID of the third Windows EC2 instance", "Value": {"Ref": "WindowsEC2Instance3"}}}}