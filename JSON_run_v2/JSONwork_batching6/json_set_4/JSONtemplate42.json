{"AWSTemplateFormatVersion": "2010-09-09", "Resources": {"AuroraCluster": {"Type": "AWS::RDS::DBCluster", "Properties": {"Engine": "aurora-mysql", "MasterUsername": "{{resolve:ssm:DBMasterUsername}}", "MasterUserPassword": "{{resolve:ssm-secure:DBMasterUserPassword}}", "DBClusterIdentifier": "aurora-cluster", "VpcSecurityGroupIds": [{"Ref": "DMSSecurityGroup"}], "DBSubnetGroupName": {"Ref": "DMSSubnetGroup"}}}, "AuroraInstance": {"Type": "AWS::RDS::DBInstance", "Properties": {"DBClusterIdentifier": {"Ref": "AuroraCluster"}, "DBInstanceClass": "db.t3.medium", "Engine": "aurora-mysql"}}, "S3Bucket": {"Type": "AWS::S3::Bucket", "Properties": {"BucketName": "dms-target-bucket"}}, "DMSSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for DMS", "VpcId": {"Ref": "VpcId"}}}, "DMSSubnetGroup": {"Type": "AWS::DMS::ReplicationSubnetGroup", "Properties": {"ReplicationSubnetGroupDescription": "DMS Subnet Group", "SubnetIds": {"Ref": "SubnetIds"}}}, "DMSSourceEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointIdentifier": "source-endpoint", "EndpointType": "source", "EngineName": "aurora", "Username": "{{resolve:ssm:DBMasterUsername}}", "Password": "{{resolve:ssm-secure:DBMasterUserPassword}}", "ServerName": {"Fn::GetAtt": ["AuroraCluster", "Endpoint.Address"]}, "Port": 3306, "DatabaseName": {"Ref": "DBName"}}}, "DMSTargetEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointIdentifier": "target-endpoint", "EndpointType": "target", "EngineName": "s3", "S3Settings": {"BucketName": {"Ref": "S3Bucket"}, "ServiceAccessRoleArn": {"Ref": "DMSServiceRole"}}}}, "DMSReplicationInstance": {"Type": "AWS::DMS::ReplicationInstance", "Properties": {"ReplicationInstanceClass": "dms.t3.medium", "VpcSecurityGroupIds": [{"Ref": "DMSSecurityGroup"}], "ReplicationSubnetGroupIdentifier": {"Ref": "DMSSubnetGroup"}}}, "DMSTask": {"Type": "AWS::DMS::ReplicationTask", "Properties": {"MigrationType": "full-load-and-cdc", "ReplicationInstanceArn": {"Ref": "DMSReplicationInstance"}, "SourceEndpointArn": {"Ref": "DMSSourceEndpoint"}, "TargetEndpointArn": {"Ref": "DMSTargetEndpoint"}, "TableMappings": "{}"}}, "DMSServiceRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "dms.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "DMSAccessPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["s3:*"], "Resource": [{"Fn::Sub": "arn:aws:s3:::${S3Bucket}/*"}, {"Fn::Sub": "arn:aws:s3:::${S3Bucket}"}]}]}}]}}}, "Parameters": {"DBMasterUsername": {"Type": "AWS::SSM::Parameter::Value<String>", "Description": "The database admin account username"}, "DBMasterUserPassword": {"Type": "AWS::SSM::Parameter::Value<SecureString>", "Description": "The database admin account password"}, "DBName": {"Type": "String", "Description": "The initial database name"}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id"}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "Subnet Ids"}}}