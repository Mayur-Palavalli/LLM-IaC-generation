{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"MasterUserPassword": {"Type": "String", "NoEcho": "true", "Description": "The password for the master database user"}, "DMSAuroraPassword": {"Type": "String", "NoEcho": "true", "Description": "The password for the DMS Aurora endpoint"}}, "Resources": {"VPC": {"Type": "AWS::EC2::VPC", "Properties": {"CidrBlock": "10.0.0.0/16", "EnableDnsSupport": true, "EnableDnsHostnames": true, "Tags": [{"Key": "Name", "Value": "DMSVPC"}]}}, "Subnet1": {"Type": "AWS::EC2::Subnet", "Properties": {"VpcId": {"Ref": "VPC"}, "CidrBlock": "10.0.1.0/24", "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]}, "Tags": [{"Key": "Name", "Value": "Subnet1"}]}}, "DBSubnetGroup": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"DBSubnetGroupDescription": "Subnet group for Aurora RDS", "SubnetIds": [{"Ref": "Subnet1"}]}}, "AuroraCluster": {"Type": "AWS::RDS::DBCluster", "Properties": {"Engine": "aurora-mysql", "MasterUsername": "admin", "MasterUserPassword": {"Fn::Sub": "{{resolve:secretsmanager:${MasterUserPassword}:SecretString:password}}"}, "DBSubnetGroupName": {"Ref": "DBSubnetGroup"}, "VpcSecurityGroupIds": [{"Ref": "DBSecurityGroup"}]}}, "AuroraInstance": {"Type": "AWS::RDS::DBInstance", "Properties": {"DBClusterIdentifier": {"Ref": "AuroraCluster"}, "DBInstanceClass": "db.t3.medium"}}, "DBSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Database security group", "VpcId": {"Ref": "VPC"}, "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 3306, "ToPort": 3306, "CidrIp": "0.0.0.0/0"}]}}, "DMSSubnetGroup": {"Type": "AWS::DMS::ReplicationSubnetGroup", "Properties": {"ReplicationSubnetGroupDescription": "Subnet group for DMS", "SubnetIds": [{"Ref": "Subnet1"}]}}, "DMSTaskSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "DMS task security group", "VpcId": {"Ref": "VPC"}, "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 3306, "ToPort": 3306, "SourceSecurityGroupId": {"Ref": "DBSecurityGroup"}}]}}, "DMSInstance": {"Type": "AWS::DMS::ReplicationInstance", "Properties": {"ReplicationInstanceClass": "dms.c4.large", "ReplicationSubnetGroupIdentifier": {"Ref": "DMSSubnetGroup"}}}, "DMSAuroraEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointIdentifier": "aurora-source-endpoint", "EndpointType": "source", "EngineName": "aurora-mysql", "Username": "admin", "Password": {"Fn::Sub": "{{resolve:secretsmanager:${DMSAuroraPassword}:SecretString:password}}"}, "ServerName": {"Fn::GetAtt": ["AuroraCluster", "Endpoint.Address"]}, "Port": 3306, "DatabaseName": "yourdatabasename"}}, "DMSSEndPoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointIdentifier": "s3-target-endpoint", "EndpointType": "target", "EngineName": "s3", "S3Settings": {"BucketName": {"Ref": "DMSBucket"}, "ServiceAccessRoleArn": {"Fn::GetAtt": ["DMSTargetRole", "Arn"]}}}}, "DMSBucket": {"Type": "AWS::S3::Bucket", "Properties": {"BucketName": "your-dms-bucket-unique"}}, "DMSTask": {"Type": "AWS::DMS::ReplicationTask", "Properties": {"MigrationType": "full-load-and-cdc", "SourceEndpointArn": {"Ref": "DMSAuroraEndpoint"}, "TargetEndpointArn": {"Ref": "DMSSEndPoint"}, "ReplicationInstanceArn": {"Ref": "DMSInstance"}, "TableMappings": "{\"rules\": [{\"rule-type\": \"selection\", \"rule-id\": \"1\", \"rule-name\": \"1\", \"object-locator\": {\"schema-name\": \"%\", \"table-name\": \"%\"}, \"rule-action\": \"include\"}]}"}}, "DMSTargetRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "dms.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "DMSAccessPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["s3:PutObject", "s3:GetObject", "s3:ListBucket"], "Resource": [{"Fn::Sub": "arn:aws:s3:::${DMSBucket}/*"}, {"Fn::Sub": "arn:aws:s3:::${DMSBucket}"}]}]}}]}}}}