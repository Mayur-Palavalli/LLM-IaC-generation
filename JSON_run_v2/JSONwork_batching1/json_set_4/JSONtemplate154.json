{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create an AD Connector to connect to an on-premises directory, with options for seamless domain join, domain members security group, and DHCP Option Set.", "Parameters": {"DirectoryDnsIPs": {"Type": "CommaDelimitedList", "Description": "Comma-separated list of IP addresses of the DNS servers for the on-premises directory."}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC ID where the AD Connector and other resources will be created."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "List of Subnet IDs in your VPC for the AD Connector."}, "EnableSeamlessDomainJoin": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Option to create seamless domain join resources for Windows & Linux EC2 instances."}, "CreateDomainSecurityGroup": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Option to create a domain members security group that allows all PrivateIP communications inbound."}, "CreateDHCPOptionSet": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Option to create DHCPOptionSet pointing to Domain DNS servers."}, "ADConnectorPassword": {"Type": "AWS::SSM::Parameter::Value<String>", "Description": "Password for the AD Connector.", "NoEcho": true}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": "corp.example.com", "Password": {"Ref": "ADConnectorPassword"}, "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Ref": "SubnetIds"}}}}, "SeamlessDomainJoinRole": {"Condition": "CreateSeamlessDomainJoin", "Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "SeamlessDomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:CreateComputer", "ds:DescribeDirectories"], "Resource": "*"}]}}]}}, "DomainMembersSecurityGroup": {"Condition": "CreateDomainSecurityGroup", "Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for domain member instances", "VpcId": {"Ref": "VpcId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": {"Fn::Sub": "${AWS::StackName}-subnet-ip-prefix"}}]}}, "DHCPOptionSet": {"Condition": "CreateDHCPOptionSet", "Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Ref": "DirectoryDnsIPs"}, "DomainName": "corp.example.com"}}, "DHCPOptionSetAssociation": {"Condition": "CreateDHCPOptionSet", "Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionSet"}, "VpcId": {"Ref": "VpcId"}}}}, "Conditions": {"CreateSeamlessDomainJoin": {"Fn::Equals": [{"Ref": "EnableSeamlessDomainJoin"}, "true"]}, "CreateDomainSecurityGroup": {"Fn::Equals": [{"Ref": "CreateDomainSecurityGroup"}, "true"]}, "CreateDHCPOptionSet": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "true"]}}}