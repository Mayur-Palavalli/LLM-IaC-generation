{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for EC2 instances joined to Active Directory using various SSM association methods.", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the AWS Managed AD or AD Connector."}, "UseCustomDNS": {"Type": "String", "AllowedValues": ["true", "false"], "Description": "Set if you want to use custom DNS settings. Default is false.", "Default": "false"}, "DNSServers": {"Type": "CommaDelimitedList", "Description": "List of custom DNS servers. Only used if UseCustomDNS is true."}}, "Conditions": {"UseCustomDNSCondition": {"Fn::Equals": [{"Ref": "UseCustomDNS"}, "true"]}}, "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0a9d27a9f4f5c0efc", "InstanceType": "t2.micro", "KeyName": "your-key-pair", "SecurityGroupIds": ["sg-0123456789abcdef0"], "SubnetId": "subnet-0123456789abcdef0", "UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/bin/bash\n", "yum update -y\n"]]}}, "Tags": [{"Key": "Platform", "Value": "Linux"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0d8f6eb4f641ef691", "InstanceType": "t2.micro", "KeyName": "your-key-pair", "SecurityGroupIds": ["sg-0123456789abcdef0"], "SubnetId": "subnet-0123456789abcdef0", "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "Add-WindowsFeature RSAT-AD-PowerShell\n", "</powershell>"]]}}, "Tags": [{"Key": "Platform", "Value": "Windows"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0d8f6eb4f641ef691", "InstanceType": "t2.micro", "KeyName": "your-key-pair", "SecurityGroupIds": ["sg-0123456789abcdef0"], "SubnetId": "subnet-0123456789abcdef0", "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "Add-WindowsFeature RSAT-AD-PowerShell\n", "</powershell>"]]}}, "Tags": [{"Key": "Platform", "Value": "Windows"}]}}, "WindowsJoinAssociation1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "WindowsJoinAssociation2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance2"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "WindowsJoinAssociation3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Platform", "Values": ["Windows"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "CustomDNSOption1": {"Type": "AWS::EC2::Instance", "Condition": "UseCustomDNSCondition", "Properties": {"PrivateDnsNameOptions": {"HostnameType": "ip-name", "EnableResourceNameDnsAAAARecord": false, "EnableResourceNameDnsARecord": true}, "PrivateIpAddress": {"Fn::Select": [0, {"Fn::Split": [",", {"Fn::Join": [",", {"Ref": "DNSServers"}]}]}]}}}, "CustomDNSOption2": {"Type": "AWS::EC2::Instance", "Condition": "UseCustomDNSCondition", "Properties": {"PrivateDnsNameOptions": {"HostnameType": "ip-name", "EnableResourceNameDnsAAAARecord": false, "EnableResourceNameDnsARecord": true}, "PrivateIpAddress": {"Fn::Select": [1, {"Fn::Split": [",", {"Fn::Join": [",", {"Ref": "DNSServers"}]}]}]}}}}}