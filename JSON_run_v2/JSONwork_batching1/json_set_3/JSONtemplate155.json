{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Template to create an AD Connector to connect to an on-premises directory.", "Parameters": {"VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "The ID of the VPC"}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The subnet IDs for the AD Connector"}, "DomainDnsIpAddresses": {"Type": "List<String>", "Description": "IP addresses of the DNS servers for the on-premises directory"}, "DomainName": {"Type": "String", "Description": "Fully qualified domain name of the on-premises directory"}, "ConnectorName": {"Type": "String", "Description": "Name of the AD Connector"}, "ServiceAccountUsername": {"Type": "String", "Description": "Username for the service account"}, "ServiceAccountPassword": {"Type": "String", "Description": "Password for the service account", "NoEcho": true}, "ExistingSecurityGroupId": {"Type": "AWS::EC2::SecurityGroup::Id", "Description": "ID of an existing Security Group"}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "DomainName"}, "Password": {"Ref": "ServiceAccountPassword"}, "VpcSettings": {"VpcId": {"Ref": "VPCId"}, "SubnetIds": {"Ref": "SubnetIds"}}}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for domain members, allowing private IP communication only", "VpcId": {"Ref": "VPCId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "SourceSecurityGroupId": {"Ref": "ExistingSecurityGroupId"}}]}}, "DHCPOptionsSet": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Ref": "DomainDnsIpAddresses"}}}, "VPCDHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionsSet"}, "VpcId": {"Ref": "VPCId"}}}, "LinuxSeamlessDomainJoin": {"Type": "AWS::SSM::Document", "Properties": {"DocumentType": "Command", "Content": {"schemaVersion": "2.2", "description": "Seamlessly join Linux instances to the domain.", "mainSteps": [{"action": "aws:runShellScript", "name": "joinLinuxInstance", "inputs": {"runCommand": ["yum install -y sssd realmd", {"Fn::Sub": "realm join --user=${ServiceAccountUsername} ${DomainName}"}]}}]}}}, "WindowsSeamlessDomainJoin": {"Type": "AWS::SSM::Document", "Properties": {"DocumentType": "Command", "Content": {"schemaVersion": "2.2", "description": "Seamlessly join Windows instances to the domain.", "mainSteps": [{"action": "aws:runPowerShellScript", "name": "joinWindowsInstance", "inputs": {"runCommand": [{"Fn::Sub": "$password = ConvertTo-SecureString ${ServiceAccountPassword} -AsPlainText -Force"}, {"Fn::Sub": "$credential = New-Object System.Management.Automation.PSCredential ('${ServiceAccountUsername}', $password)"}, {"Fn::Sub": "Add-Computer -DomainName ${DomainName} -Credential $credential -Restart"}]}}]}}}}, "Outputs": {"ADConnectorId": {"Description": "ID of the created AD Connector", "Value": {"Ref": "ADConnector"}}, "DomainMembersSecurityGroupId": {"Description": "Security Group ID for domain members", "Value": {"Ref": "DomainMembersSecurityGroup"}}}}