{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using AWS Systems Manager", "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0abcdef1234567890", "InstanceType": "t2.micro", "IamInstanceProfile": {"Ref": "EC2InstanceProfile"}, "KeyName": "<YourKeyPairName>", "SubnetId": "<YourSubnetId>", "SecurityGroupIds": ["sg-0123456789abcdef0"], "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0abcdef1234567890", "InstanceType": "t2.micro", "IamInstanceProfile": {"Ref": "EC2InstanceProfile"}, "KeyName": "<YourKeyPairName>", "SubnetId": "<YourSubnetId>", "SecurityGroupIds": ["sg-0123456789abcdef0"], "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0abcdef1234567890", "InstanceType": "t2.micro", "IamInstanceProfile": {"Ref": "EC2InstanceProfile"}, "KeyName": "<YourKeyPairName>", "SubnetId": "<YourSubnetId>", "SecurityGroupIds": ["sg-0123456789abcdef0"], "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0abcdef1234567890", "InstanceType": "t2.micro", "IamInstanceProfile": {"Ref": "EC2InstanceProfile"}, "KeyName": "<YourKeyPairName>", "SubnetId": "<YourSubnetId>", "SecurityGroupIds": ["sg-0123456789abcdef0"], "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "EC2InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Path": "/", "Roles": [{"Ref": "EC2Role"}]}}, "EC2Role": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "SSMManagedPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:DescribeInstanceInformation", "ssm:GetCommandInvocation", "ssm:ListCommands", "ssm:SendCommand"], "Resource": "*"}]}}]}}, "SSMAssociationforLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxEC2Instance"}, "Parameters": {"directoryId": ["<YourDirectoryId>"]}}}, "SSMAssociationforWindowsInstance2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance2"}, "Parameters": {"directoryId": ["<YourDirectoryId>"]}}}, "SSMAssociationforWindowsInstance3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance3"]}], "Parameters": {"directoryId": ["<YourDirectoryId>"]}}}, "SSMDocumentAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": ["<YourDirectoryId>"]}}}}}