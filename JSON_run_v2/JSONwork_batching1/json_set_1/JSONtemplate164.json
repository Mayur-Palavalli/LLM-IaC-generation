{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using AWS-JoinDirectoryServiceDomain SSM document.", "Parameters": {"ADDirectoryId": {"Type": "String", "Description": "The ID of the AWS Directory Service for Active Directory"}, "LinuxInstanceType": {"Type": "String", "Default": "t2.micro", "Description": "The EC2 instance type for the Linux instance"}, "WindowsInstanceType": {"Type": "String", "Default": "t2.micro", "Description": "The EC2 instance type for the Windows instances"}, "KeyPairName": {"Type": "String", "Description": "The name of the EC2 Key Pair to allow SSH/RDP access to the instances"}, "LinuxAMI": {"Type": "String", "Description": "The AMI ID for the Linux instance"}, "WindowsAMI": {"Type": "String", "Description": "The AMI ID for the Windows instances"}, "DNServers": {"Type": "CommaDelimitedList", "Description": "Optional DNS Servers to be set on the EC2 instances"}, "UseCustomDNS": {"Type": "String", "Default": "false", "AllowedValues": ["true", "false"], "Description": "Whether to use custom DNS Servers"}}, "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "LinuxInstanceType"}, "ImageId": {"Ref": "LinuxAMI"}, "KeyName": {"Ref": "KeyPairName"}, "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": {"Ref": "WindowsAMI"}, "KeyName": {"Ref": "KeyPairName"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": {"Ref": "WindowsAMI"}, "KeyName": {"Ref": "KeyPairName"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": {"Ref": "WindowsAMI"}, "KeyName": {"Ref": "KeyPairName"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "SSMDocumentAssociationLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxEC2Instance"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["UseCustomDNS", {"Ref": "DNServers"}, {"Ref": "AWS::NoValue"}]}]}}}, "SSMDocumentAssociationWin1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["UseCustomDNS", {"Ref": "DNServers"}, {"Ref": "AWS::NoValue"}]}]}}}, "SSMDocumentAssociationWin2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance2"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["UseCustomDNS", {"Ref": "DNServers"}, {"Ref": "AWS::NoValue"}]}]}}}, "SSMDocumentAssociationWin3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance3"]}], "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["UseCustomDNS", {"Ref": "DNServers"}, {"Ref": "AWS::NoValue"}]}]}}}}, "Conditions": {"UseCustomDNS": {"Fn::Equals": [{"Ref": "UseCustomDNS"}, "true"]}}}