{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document.", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the AWS Managed AD or AD Connector."}, "DNS1": {"Type": "String", "Description": "Optional DNS server 1", "Default": ""}, "DNS2": {"Type": "String", "Description": "Optional DNS server 2", "Default": ""}, "InstanceType": {"Type": "String", "Description": "EC2 Instance Type", "Default": "t2.micro", "AllowedValues": ["t2.micro", "t2.small", "t2.medium", "t2.large"], "ConstraintDescription": "Must be a valid EC2 instance type."}, "LinuxAMI": {"Type": "String", "Description": "The Linux Amazon Machine Image (AMI) ID."}, "WindowsAMI": {"Type": "String", "Description": "The Windows Amazon Machine Image (AMI) ID."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances"}, "VPC": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC ID"}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "The Subnet ID for the instances"}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Ref": "LinuxAMI"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Ref": "WindowsAMI"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Ref": "WindowsAMI"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Ref": "WindowsAMI"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "JoinDomainDocumentLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "JoinDomainDocumentWindows1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "WindowsDomainJoinTagAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance2", "WindowsInstance3"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}}, "Outputs": {"LinuxInstanceId": {"Description": "Instance ID of the Linux EC2 instance", "Value": {"Ref": "LinuxInstance"}}, "WindowsInstance1Id": {"Description": "Instance ID of the first Windows EC2 instance", "Value": {"Ref": "WindowsInstance1"}}, "WindowsInstance2Id": {"Description": "Instance ID of the second Windows EC2 instance", "Value": {"Ref": "WindowsInstance2"}}, "WindowsInstance3Id": {"Description": "Instance ID of the third Windows EC2 instance", "Value": {"Ref": "WindowsInstance3"}}}}