{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create AD Connector and related resources", "Parameters": {"InstanceVpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC ID for the AD Connector"}, "DomainDnsIpAddresses": {"Type": "List<String>", "Description": "The IP addresses of the DNS servers for the on-premises directory"}, "DomainDnsName": {"Type": "String", "Description": "DNS name of the on-premises directory"}}, "Resources": {"AdConnector": {"Type": "AWS::DirectoryService::SimpleAD", "Properties": {"VpcSettings": {"VpcId": {"Ref": "InstanceVpcId"}, "SubnetIds": [{"Fn::Select": ["0", {"Fn::GetAZs": {"Ref": "AWS::Region"}}]}, {"Fn::Select": ["1", {"Fn::GetAZs": {"Ref": "AWS::Region"}}]}]}, "Name": {"Ref": "DomainDnsName"}, "Password": "{{resolve:secretsmanager:your-secret-id:SecretString:your-secret-key}}", "Size": "Small"}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Condition": "CreateSecurityGroup", "Properties": {"VpcId": {"Ref": "InstanceVpcId"}, "GroupDescription": "Security group for domain member instances", "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}], "SecurityGroupEgress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}]}}, "DHCPOptionSet": {"Type": "AWS::EC2::DHCPOptions", "Condition": "CreateDhcpOptions", "Properties": {"DomainName": {"Ref": "DomainDnsName"}, "DomainNameServers": {"Ref": "DomainDnsIpAddresses"}}}, "VPCDHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Condition": "CreateDhcpOptions", "Properties": {"VpcId": {"Ref": "InstanceVpcId"}, "DhcpOptionsId": {"Ref": "DHCPOptionSet"}}}}, "Conditions": {"CreateSecurityGroup": {"Fn::Not": [{"Fn::Equals": [{"Ref": "DomainMembersSecurityGroup"}, {"Ref": "AWS::NoValue"}]}]}, "CreateDhcpOptions": {"Fn::Not": [{"Fn::Equals": [{"Ref": "DHCPOptionSet"}, {"Ref": "AWS::NoValue"}]}]}}, "Outputs": {"AdConnector": {"Description": "AD Connector ID", "Value": {"Ref": "AdConnector"}}, "DomainMembersSecurityGroup": {"Condition": "CreateSecurityGroup", "Description": "Security Group for domain member instances", "Value": {"Ref": "DomainMembersSecurityGroup"}}, "DHCPOptionSet": {"Condition": "CreateDhcpOptions", "Description": "DHCP Option Set", "Value": {"Ref": "DHCPOptionSet"}}}}