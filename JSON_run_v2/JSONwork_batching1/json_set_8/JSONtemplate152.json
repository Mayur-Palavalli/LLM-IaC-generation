{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for AD Connector to connect to an on-premises directory with options for seamless domain join, security group, and DHCPOptionSet.", "Parameters": {"DirectoryName": {"Description": "Fully qualified domain name (FQDN) of the on-premises directory", "Type": "String"}, "CustomerDnsIps": {"Description": "List of IP addresses of DNS servers for the on-premises directory", "Type": "List<String>"}, "VPCId": {"Description": "VPC ID where the AD Connector and EC2 instances will be deployed", "Type": "AWS::EC2::VPC::Id"}, "SubnetIds": {"Description": "List of subnet IDs for the AD Connector", "Type": "List<AWS::EC2::Subnet::Id>"}, "CreateSeamlessDomainJoin": {"Description": "Option to create seamless domain join resources for Windows & Linux EC2 instances", "Type": "String", "AllowedValues": ["Yes", "No"], "Default": "No"}, "CreateSecurityGroup": {"Description": "Option to create a domain members security group", "Type": "String", "AllowedValues": ["Yes", "No"], "Default": "No"}, "CreateDhcpOptionSet": {"Description": "Option to create a DHCP Option Set pointing to Domain DNS servers", "Type": "String", "AllowedValues": ["Yes", "No"], "Default": "No"}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::SimpleAD", "Properties": {"Name": {"Ref": "DirectoryName"}, "Password": "{{resolve:ssm-secure:/aws/ds/ad/admin/password:1}}", "Size": "Small", "VpcSettings": {"VpcId": {"Ref": "VPCId"}, "SubnetIds": {"Fn::Split": [",", {"Ref": "SubnetIds"}]}}}}, "SeamlessDomainJoinRole": {"Condition": "CreateSeamlessDomainJoin", "Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ssm.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AmazonSSMDirectoryServiceAccess", "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"]}}, "DomainMemberSecurityGroup": {"Condition": "CreateSecurityGroup", "Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPCId"}, "GroupDescription": "Security group for domain member instances", "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}]}}, "DhcpOptions": {"Condition": "CreateDhcpOptionSet", "Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainName": {"Ref": "DirectoryName"}, "DomainNameServers": {"Ref": "CustomerDnsIps"}}}, "DhcpOptionsAssociation": {"Condition": "CreateDhcpOptionSet", "Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"VpcId": {"Ref": "VPCId"}, "DhcpOptionsId": {"Ref": "DhcpOptions"}}}}, "Conditions": {"CreateSeamlessDomainJoin": {"Fn::Equals": [{"Ref": "CreateSeamlessDomainJoin"}, "Yes"]}, "CreateSecurityGroup": {"Fn::Equals": [{"Ref": "CreateSecurityGroup"}, "Yes"]}, "CreateDhcpOptionSet": {"Fn::Equals": [{"Ref": "CreateDhcpOptionSet"}, "Yes"]}}}