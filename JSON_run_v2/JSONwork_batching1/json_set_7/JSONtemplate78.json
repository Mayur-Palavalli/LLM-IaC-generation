{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Sample template to create an Amazon EKS Cluster on EC2.", "Parameters": {"ClusterName": {"Type": "String", "Description": "The name of the EKS Cluster"}, "NodeGroupName": {"Type": "String", "Description": "Name of the EKS Node Group"}, "NodeInstanceType": {"Type": "String", "Description": "EC2 instance type for the EKS nodes", "Default": "t3.medium", "AllowedValues": ["t2.micro", "t2.small", "t2.medium", "t3.medium", "t3.large", "m5.large"], "ConstraintDescription": "must be a valid EC2 instance type."}, "NodeAutoScalingGroupMinSize": {"Type": "Number", "Description": "Minimum size of Node Group Auto Scaling Group", "Default": 1}, "NodeAutoScalingGroupMaxSize": {"Type": "Number", "Description": "Maximum size of Node Group Auto Scaling Group", "Default": 3}, "NodeVolumeSize": {"Type": "Number", "Description": "Size of the EBS volume for the EKS nodes", "Default": 20}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id of your existing VPC"}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The subnets associated with your VPC"}, "ControlPlaneSecurityGroup": {"Type": "AWS::EC2::SecurityGroup::Id", "Description": "Security group for the EKS Control Plane communication with worker nodes"}}, "Resources": {"EKSCluster": {"Type": "AWS::EKS::Cluster", "Properties": {"Name": {"Ref": "ClusterName"}, "ResourcesVpcConfig": {"SecurityGroupIds": [{"Ref": "ControlPlaneSecurityGroup"}], "SubnetIds": {"Ref": "SubnetIds"}}, "RoleArn": {"Fn::GetAtt": ["EKSClusterRole", "Arn"]}}}, "EKSClusterRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "eks.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"]}}, "NodeInstanceRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy", "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy", "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"]}}, "EKSNodeGroup": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"MinSize": {"Ref": "NodeAutoScalingGroupMinSize"}, "MaxSize": {"Ref": "NodeAutoScalingGroupMaxSize"}, "DesiredCapacity": {"Ref": "NodeAutoScalingGroupMinSize"}, "VPCZoneIdentifier": {"Ref": "SubnetIds"}, "LaunchConfigurationName": {"Ref": "NodeLaunchConfig"}, "Tags": [{"Key": "Name", "Value": {"Ref": "NodeGroupName"}, "PropagateAtLaunch": true}]}}, "NodeLaunchConfig": {"Type": "AWS::AutoScaling::LaunchConfiguration", "Properties": {"ImageId": {"Fn::FindInMap": ["AWSRegionToAMI", {"Ref": "AWS::Region"}, "ami"]}, "InstanceType": {"Ref": "NodeInstanceType"}, "IamInstanceProfile": {"Ref": "NodeInstanceProfile"}, "SecurityGroups": [{"Ref": "NodeSecurityGroup"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["#!/bin/bash\nset -o xtrace\n/etc/eks/bootstrap.sh ${ClusterName}", {"ClusterName": {"Ref": "ClusterName"}}]}}, "BlockDeviceMappings": [{"DeviceName": "/dev/xvda", "Ebs": {"VolumeSize": {"Ref": "NodeVolumeSize"}}}]}}, "NodeInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Path": "/", "Roles": [{"Ref": "NodeInstanceRole"}]}}, "NodeSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VpcId"}, "GroupDescription": "Worker nodes security group"}}}, "Mappings": {"AWSRegionToAMI": {"us-east-1": {"ami": "ami-0c24db5d28f0c10e7"}, "us-west-2": {"ami": "ami-0a0a4b673143e32e1"}}}, "Outputs": {"EKSClusterName": {"Description": "Name of the EKS Cluster", "Value": {"Ref": "EKSCluster"}}, "EKSClusterEndpoint": {"Description": "Endpoint URL of the EKS Cluster", "Value": {"Fn::GetAtt": ["EKSCluster", "Endpoint"]}}}}