{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document.", "Parameters": {"ADDomainName": {"Type": "String", "Description": "The name of the Active Directory domain"}, "DirectoryId": {"Type": "String", "Description": "The ID of the AWS Managed Microsoft AD or AD Connector"}, "InstanceType": {"Type": "String", "Default": "t2.micro", "Description": "EC2 instance type"}, "KeyPairName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances"}, "DNSServers": {"Type": "CommaDelimitedList", "Description": "Optional DNS servers for the instances"}}, "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyPairName"}, "ImageId": "ami-0abcdef1234567890", "IamInstanceProfile": {"Ref": "EC2InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "LinuxEC2Instance"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyPairName"}, "ImageId": "ami-0abcdef1234567890", "IamInstanceProfile": {"Ref": "EC2InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance1"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyPairName"}, "ImageId": "ami-0abcdef1234567890", "IamInstanceProfile": {"Ref": "EC2InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance2"}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyPairName"}, "ImageId": "ami-0abcdef1234567890", "IamInstanceProfile": {"Ref": "EC2InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance3"}]}}, "EC2InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "EC2Role"}]}}, "EC2Role": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "SSMEC2Policy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ec2:Describe*", "ssm:SendCommand", "ssm:AssociateOpsItemRelatedItem", "ssm:DescribeAssociation", "ssm:DescribeDocument", "ssm:DescribeInstanceInformation", "ssm:GetDeployablePatchSnapshotForInstance", "ssm:GetDocument", "ssm:GetManifest", "ssm:ListAssociations", "ssm:ListInstanceAssociations", "ssm:PutInventory", "ssm:UpdateAssociationStatus", "ssm:UpdateInstanceInformation"], "Resource": "*"}]}}]}}, "LinuxSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DNSServers"}]}]}, "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "LinuxEC2Instance"}]}]}}, "WindowsSSMAssociation1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DNSServers"}]}]}, "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsEC2Instance1"}]}]}}, "WindowsSSMAssociation2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DNSServers"}]}]}, "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsEC2Instance2"}]}]}}, "WindowsSSMAssociation3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DNSServers"}]}]}, "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsEC2Instance3"}]}]}}}}