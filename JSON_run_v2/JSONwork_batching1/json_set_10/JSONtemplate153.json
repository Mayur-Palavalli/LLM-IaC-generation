{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create an AD Connector to connect to an on-premises directory with optional resources.", "Parameters": {"VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id"}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "Subnet Ids"}, "CustomerDnsIps": {"Type": "List<String>", "Description": "DNS IPs of the on-premise directory"}, "CredentialsBucketName": {"Type": "String", "Description": "S3 bucket name that stores AD credentials"}, "CredentialsFileKey": {"Type": "String", "Description": "S3 file key that stores AD credentials"}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": "corp.example.com", "Password": {"Fn::Sub": "${CredentialsBucketName}/${CredentialsFileKey}"}, "VpcSettings": {"VpcId": {"Ref": "VPCId"}, "SubnetIds": {"Ref": "SubnetIds"}}, "Edition": "Standard", "ShortName": "CORP"}}, "DHCPOptions": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainName": "corp.example.com", "DomainNameServers": {"Fn::Join": [",", {"Ref": "CustomerDnsIps"}]}}}, "DHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptions"}, "VpcId": {"Ref": "VPCId"}}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPCId"}, "GroupDescription": "Security group for domain members that allows all PrivateIP communications inbound", "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "10.0.0.0/8"}], "SecurityGroupEgress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}]}}, "SeamlessDomainJoinRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": ["ec2.amazonaws.com"]}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "AWSDirectoryServiceSeamlessDomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:CreateComputer", "ds:DescribeDirectories"], "Resource": "*"}]}}]}}, "SeamlessDomainJoinInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "SeamlessDomainJoinRole"}]}}}, "Outputs": {"ADConnectorId": {"Value": {"Ref": "ADConnector"}, "Description": "AD Connector ID"}, "DomainMembersSecurityGroupId": {"Value": {"Ref": "DomainMembersSecurityGroup"}, "Description": "'Domain Members Security Group ID"}, "SeamlessDomainJoinProfileArn": {"Value": {"Ref": "SeamlessDomainJoinInstanceProfile"}, "Description": "ARN of the Instance Profile for Seamless Domain Join"}}}