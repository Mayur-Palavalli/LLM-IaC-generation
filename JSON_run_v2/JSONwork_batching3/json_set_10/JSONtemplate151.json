{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for an AD Connector to connect to an on-premises directory with optional resources.", "Parameters": {"CreateSeamlessDomainJoinResources": {"Type": "String", "Default": "false", "AllowedValues": ["true", "false"], "Description": "Option to create seamless domain join resources for Windows & Linux EC2 instances."}, "CreateDomainMembersSecurityGroup": {"Type": "String", "Default": "false", "AllowedValues": ["true", "false"], "Description": "Option to create a domain members security group that allows all PrivateIP communications inbound."}, "CreateDHCPOptionSet": {"Type": "String", "Default": "false", "AllowedValues": ["true", "false"], "Description": "Option to create a DHCPOptionSet pointing to Domain DNS servers."}, "DnsIpAddresses": {"Type": "CommaDelimitedList", "Description": "IP addresses of the Domain DNS servers.", "Default": ""}, "DirectoryName": {"Type": "String", "Description": "The fully qualified name of the on-premises directory, such as corp.example.com"}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC in which to create the AD Connector."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The subnets in which to create the AD Connector."}, "PasswordSecret": {"Type": "AWS::SSM::Parameter::Value<String>", "Description": "The SSM parameter name for the directory password."}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "DirectoryName"}, "Password": {"Fn::Sub": "{{resolve:ssm-secure:${PasswordSecret}}}"}, "ShortName": {"Fn::Select": [0, {"Fn::Split": [".", {"Ref": "DirectoryName"}]}]}, "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Ref": "SubnetIds"}}}}, "SeamlessDomainJoinRole": {"Condition": "CreateSeamlessDomainJoinResources", "Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ssm.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "DomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:DescribeDirectories", "ds:CreateComputer", "ds:DescribeSsoSessions", "ds:ListAuthorizedApplications", "ds:AuthorizeApplication"], "Resource": "*"}]}}]}}, "DomainMembersSecurityGroup": {"Condition": "CreateDomainMembersSecurityGroup", "Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for domain members allowing all PrivateIP communications inbound", "VpcId": {"Ref": "VpcId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "10.0.0.0/8"}, {"IpProtocol": "-1", "CidrIp": "172.16.0.0/12"}, {"IpProtocol": "-1", "CidrIp": "192.168.0.0/16"}]}}, "DHCPOptionSet": {"Condition": "CreateDHCPOptionSet", "Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Ref": "DnsIpAddresses"}}}, "VPCDHCPOptionsAssociation": {"Condition": "CreateDHCPOptionSet", "Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionSet"}, "VpcId": {"Ref": "VpcId"}}}}, "Conditions": {"CreateSeamlessDomainJoinResources": {"Fn::Equals": [{"Ref": "CreateSeamlessDomainJoinResources"}, "true"]}, "CreateDomainMembersSecurityGroup": {"Fn::Equals": [{"Ref": "CreateDomainMembersSecurityGroup"}, "true"]}, "CreateDHCPOptionSet": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "true"]}}}