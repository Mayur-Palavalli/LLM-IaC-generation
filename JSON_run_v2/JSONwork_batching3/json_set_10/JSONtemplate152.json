{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create AD Connector, seamless domain join, security group, and DHCP options.", "Parameters": {"VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "ID of the VPC where AD Connector and resources will be deployed."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "List of Subnet IDs for AD Connector."}, "ADConnectorName": {"Type": "String", "Description": "Name of the AD Connector."}, "ServerDNSIPs": {"Type": "List<String>", "Description": "A list of one or more IP addresses of DNS servers in the on-premises directory."}, "DomainDNSName": {"Type": "String", "Description": "Fully qualified domain name of the on-premises directory."}, "SeamlessDomainJoinEnabled": {"Type": "String", "Description": "Enable seamless domain join.", "AllowedValues": ["true", "false"], "Default": "false"}, "CreateSecurityGroup": {"Type": "String", "Description": "Specify whether to create a security group for domain members.", "AllowedValues": ["true", "false"], "Default": "true"}, "CreateDHCPOptionSet": {"Type": "String", "Description": "Specify whether to create DHCP options set.", "AllowedValues": ["true", "false"], "Default": "true"}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "ADConnectorName"}, "Password": "{{resolve:ssm-secure:/aws/service/dummyPassword}}", "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Ref": "SubnetIds"}}}}, "SeamlessDomainJoinWindows": {"Condition": "CreateSeamlessDomainJoin", "Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": [{"Ref": "ADConnector"}], "directoryName": [{"Ref": "DomainDNSName"}], "dnsIpAddresses": {"Ref": "ServerDNSIPs"}}, "Targets": [{"Key": "tag:Platform", "Values": ["Windows"]}]}}, "SeamlessDomainJoinLinux": {"Condition": "CreateSeamlessDomainJoin", "Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": [{"Ref": "ADConnector"}], "directoryName": [{"Ref": "DomainDNSName"}], "dnsIpAddresses": {"Ref": "ServerDNSIPs"}}, "Targets": [{"Key": "tag:Platform", "Values": ["Linux"]}]}}, "DomainMembersSecurityGroup": {"Condition": "CreateDomainMembersSecurityGroup", "Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VpcId"}, "GroupDescription": "Security group for domain members.", "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}], "Tags": [{"Key": "Name", "Value": "DomainMembersSecurityGroup"}]}}, "DHCPOptionSet": {"Condition": "CreateDHCPOptionSet", "Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainName": {"Ref": "DomainDNSName"}, "DomainNameServers": {"Fn::Join": [",", {"Fn::Split": [",", {"Ref": "ServerDNSIPs"}]}]}}}}, "Conditions": {"CreateSeamlessDomainJoin": {"Fn::Or": [{"Fn::Not": [{"Fn::Equals": [{"Ref": "SeamlessDomainJoinEnabled"}, ""]}]}, {"Fn::Equals": [{"Ref": "SeamlessDomainJoinEnabled"}, "true"]}]}, "CreateDomainMembersSecurityGroup": {"Fn::Equals": [{"Ref": "CreateSecurityGroup"}, "true"]}, "CreateDHCPOptionSet": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "true"]}}}