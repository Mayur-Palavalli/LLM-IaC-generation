{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation sample template for an EKS Cluster on EC2.", "Parameters": {"VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "ID of an existing VPC", "ConstraintDescription": "Must be the VPC Id of an existing Virtual Private Cloud."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "List of Subnet IDs for the EKS Cluster", "ConstraintDescription": "Must be the Subnet IDs of existing subnets."}, "ClusterName": {"Type": "String", "Description": "Name of the EKS Cluster", "Default": "MyEKSCluster"}, "InstanceType": {"Type": "String", "Description": "EC2 instance type for the worker nodes", "Default": "t3.medium", "AllowedValues": ["t2.small", "t2.medium", "t3.small", "t3.medium", "m5.large", "m5.xlarge"], "ConstraintDescription": "Must be a valid EC2 instance type."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances", "ConstraintDescription": "Must be the name of an existing EC2 KeyPair."}}, "Resources": {"EksCluster": {"Type": "AWS::EKS::Cluster", "Properties": {"Name": {"Ref": "ClusterName"}, "ResourcesVpcConfig": {"SubnetIds": {"Fn::Split": [",", {"Ref": "SubnetIds"}]}, "SecurityGroupIds": [{"Fn::GetAtt": ["EksClusterSecurityGroup", "GroupId"]}]}, "RoleArn": {"Fn::GetAtt": ["EksClusterRole", "Arn"]}}}, "EksClusterRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "eks.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSClusterPolicy", "arn:aws:iam::aws:policy/AmazonEKSServicePolicy"]}}, "EksClusterSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for EKS cluster control plane", "VpcId": {"Ref": "VpcId"}, "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 443, "ToPort": 443, "CidrIp": "0.0.0.0/0"}], "SecurityGroupEgress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}]}}, "NodeGroup": {"Type": "AWS::EKS::Nodegroup", "Properties": {"ClusterName": {"Ref": "ClusterName"}, "NodeRole": {"Fn::GetAtt": ["EksNodeRole", "Arn"]}, "Subnets": {"Fn::Split": [",", {"Ref": "SubnetIds"}]}, "ScalingConfig": {"DesiredSize": 2, "MaxSize": 3, "MinSize": 1}, "InstanceTypes": [{"Ref": "InstanceType"}], "AmiType": "AL2_x86_64", "RemoteAccess": {"Ec2SshKey": {"Ref": "KeyName"}}}}, "EksNodeRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy", "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"]}}}, "Outputs": {"ClusterName": {"Description": "Name of the EKS Cluster", "Value": {"Ref": "ClusterName"}}, "NodeGroupName": {"Description": "Name of the EKS Node Group", "Value": {"Ref": "NodeGroup"}}, "ClusterRoleArn": {"Description": "ARN of the Cluster IAM Role", "Value": {"Fn::GetAtt": ["EksClusterRole", "Arn"]}}, "NodeRoleArn": {"Description": "ARN of the Nodegroup IAM Role", "Value": {"Fn::GetAtt": ["EksNodeRole", "Arn"]}}}}