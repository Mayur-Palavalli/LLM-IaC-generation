{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using SSM document 'AWS-JoinDirectoryServiceDomain'.", "Parameters": {"DirectoryId": {"Description": "The ID of the AWS Managed AD or AD Connector", "Type": "String"}, "DnsServers": {"Description": "Comma-separated list of DNS server IPs to set on the instances (optional)", "Type": "CommaDelimitedList"}}, "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-12345678", "KeyName": "my-key-name", "SecurityGroupIds": ["sg-12345678"], "SubnetId": "subnet-12345678", "IamInstanceProfile": {"Ref": "EC2IAMInstanceProfile"}, "Tags": [{"Key": "Name", "Value": "LinuxInstance"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/bin/bash\n"]]}}}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-87654321", "KeyName": "my-key-name", "SecurityGroupIds": ["sg-12345678"], "SubnetId": "subnet-12345678", "IamInstanceProfile": {"Ref": "EC2IAMInstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n</powershell>"]]}}}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-87654321", "KeyName": "my-key-name", "SecurityGroupIds": ["sg-12345678"], "SubnetId": "subnet-12345678", "IamInstanceProfile": {"Ref": "EC2IAMInstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n</powershell>"]]}}}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-87654321", "KeyName": "my-key-name", "SecurityGroupIds": ["sg-12345678"], "SubnetId": "subnet-12345678", "IamInstanceProfile": {"Ref": "EC2IAMInstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n</powershell>"]]}}}}, "EC2IAMInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Path": "/", "Roles": [{"Ref": "EC2IAMRole"}]}}, "EC2IAMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"]}}, "SSMAssociationLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxEC2Instance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["DnsServersProvided", {"Fn::Split": [",", {"Ref": "DnsServers"}]}, {"Ref": "AWS::NoValue"}]}]}}}, "SSMAssociationWindows1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["DnsServersProvided", {"Fn::Split": [",", {"Ref": "DnsServers"}]}, {"Ref": "AWS::NoValue"}]}]}}}, "SSMAssociationWindows2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance2"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["DnsServersProvided", {"Fn::Split": [",", {"Ref": "DnsServers"}]}, {"Ref": "AWS::NoValue"}]}]}}}, "SSMAssociationWindows3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance3"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["DnsServersProvided", {"Fn::Split": [",", {"Ref": "DnsServers"}]}, {"Ref": "AWS::NoValue"}]}]}}}}, "Conditions": {"DnsServersProvided": {"Fn::Not": [{"Fn::Equals": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}, ""]}]}}}