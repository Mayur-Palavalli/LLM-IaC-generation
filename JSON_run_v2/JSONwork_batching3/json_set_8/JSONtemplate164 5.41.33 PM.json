{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Create a AWS CloudFormation template for one Linux and three Windows EC2 instances and joins them to Active Directory", "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0abcdef1234567890", "InstanceType": "t2.micro", "SubnetId": "subnet-1234abcd", "UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/bin/bash\n", "hostnamectl set-hostname linux-instance.localdomain\n", "yum install -y amazon-ssm-agent\n", "systemctl enable amazon-ssm-agent\n", "systemctl start amazon-ssm-agent\n"]]}}}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0abcdef1234567890", "InstanceType": "t2.nano", "SubnetId": "subnet-1234abcd", "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "$domain = 'AD-Domain.local'\n", "Install-WindowsFeature RSAT-AD-PowerShell\n", "Rename-Computer -NewName 'win-instance1'\n", "Restart-Computer\n", "</powershell>"]]}}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0abcdef1234567890", "InstanceType": "t2.nano", "SubnetId": "subnet-1234abcd", "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "$domain = 'AD-Domain.local'\n", "Install-WindowsFeature RSAT-AD-PowerShell\n", "Rename-Computer -NewName 'win-instance2'\n", "Restart-Computer\n", "</powershell>"]]}}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0abcdef1234567890", "InstanceType": "t2.nano", "SubnetId": "subnet-1234abcd", "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "$domain = 'AD-Domain.local'\n", "Install-WindowsFeature RSAT-AD-PowerShell\n", "Rename-Computer -NewName 'win-instance3'\n", "Restart-Computer\n", "</powershell>"]]}}}}, "WindowsDomainJoinInline": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": "d-1234567890", "directoryName": "AD-Domain.local", "dnsIpAddresses": ["192.0.2.10", "192.0.2.11"]}}}, "DomainJoinAssociationForLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Value": [{"Ref": "LinuxInstance"}]}], "Parameters": {"directoryId": "d-1234567890", "directoryName": "AD-Domain.local", "dnsIpAddresses": ["192.0.2.10", "192.0.2.11"]}}}, "DomainJoinAssociationForWindows": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsInstance2"}, {"Ref": "WindowsInstance3"}]}], "Parameters": {"directoryId": "d-1234567890", "directoryName": "AD-Domain.local", "dnsIpAddresses": ["192.0.2.10", "192.0.2.11"]}}}}}