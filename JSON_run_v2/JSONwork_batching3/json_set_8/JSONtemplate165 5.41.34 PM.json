{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Template to create one Linux and three Windows EC2 Instances and join them to Active Directory", "Parameters": {"ADDomainName": {"Type": "String", "Description": "The DNS name of the Active Directory Domain."}, "InstanceType": {"Type": "String", "Default": "t3.medium", "Description": "EC2 instance type"}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances"}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet ID to deploy the instances in."}, "LinuxAMI": {"Type": "AWS::EC2::Image::Id", "Description": "AMI ID for Linux Instance."}, "WindowsAMI": {"Type": "AWS::EC2::Image::Id", "Description": "AMI ID for Windows Instances."}, "ADDirectoryId": {"Type": "String", "Description": "Directory ID of the Active Directory"}, "dnsIPAddress": {"Type": "CommaDelimitedList", "Description": "Comma separated list of the DNS IP addresses"}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": {"Ref": "LinuxAMI"}, "InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "IamInstanceProfile": {"Ref": "InstanceProfile"}}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": {"Ref": "WindowsAMI"}, "InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "IamInstanceProfile": {"Ref": "InstanceProfile"}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": {"Ref": "WindowsAMI"}, "InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "IamInstanceProfile": {"Ref": "InstanceProfile"}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": {"Ref": "WindowsAMI"}, "InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "IamInstanceProfile": {"Ref": "InstanceProfile"}}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": ["SSMRole"]}}, "SSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Action": "sts:AssumeRole", "Principal": {"Service": ["ec2.amazonaws.com"]}, "Effect": "Allow"}]}, "Policies": [{"PolicyName": "SSMDomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Action": ["ssm:SendCommand"], "Effect": "Allow", "Resource": "*"}]}}]}}, "SSMAssociation1": {"Type": "AWS::SSM::Association", "Properties": {"DocumentVersion": "$DEFAULT", "InstanceId": {"Ref": "WindowsInstance1"}, "Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": {"Ref": "ADDirectoryId"}, "directoryName": {"Ref": "ADDomainName"}, "dnsIpAddresses": {"Fn::Split": [",", {"Ref": "dnsIPAddress"}]}}}}, "SSMAssociation2": {"Type": "AWS::SSM::Association", "Properties": {"Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsInstance2"}]}], "Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": {"Ref": "ADDirectoryId"}, "directoryName": {"Ref": "ADDomainName"}}}}, "SSMAssociation3": {"Type": "AWS::SSM::Association", "Properties": {"Targets": [{"Key": "tag:Role", "Values": ["DomainMember"]}], "Name": "AWS-JoinDirectoryServiceDomain", "Parameters": {"directoryId": {"Ref": "ADDirectoryId"}, "directoryName": {"Ref": "ADDomainName"}}}}}, "Outputs": {"LinuxInstanceId": {"Description": "Instance ID of the Linux instance", "Value": {"Ref": "LinuxInstance"}}, "WindowsInstanceId1": {"Description": "Instance ID of the first Windows instance", "Value": {"Ref": "WindowsInstance1"}}, "WindowsInstanceId2": {"Description": "Instance ID of the second Windows instance", "Value": {"Ref": "WindowsInstance2"}}, "WindowsInstanceId3": {"Description": "Instance ID of the third Windows instance", "Value": {"Ref": "WindowsInstance3"}}}}