{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using SSM.", "Parameters": {"DomainName": {"Description": "The domain name of the AD to join.", "Type": "String"}, "ADInstanceID": {"Description": "The instance ID of the AD Connector or AWS Managed AD directory.", "Type": "String"}, "DNS1": {"Description": "Primary DNS server IP address.", "Type": "String", "Default": ""}, "DNS2": {"Description": "Secondary DNS server IP address.", "Type": "String", "Default": ""}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.medium", "ImageId": "ami-0dc2d3e4c0f9ebd18", "Tags": [{"Key": "Name", "Value": "LinuxInstance"}], "IamInstanceProfile": {"Ref": "InstanceProfile"}}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.medium", "ImageId": "ami-0ac019f4fcb7cb7e6", "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}], "IamInstanceProfile": {"Ref": "InstanceProfile"}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.medium", "ImageId": "ami-0ac019f4fcb7cb7e6", "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}], "IamInstanceProfile": {"Ref": "InstanceProfile"}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t3.medium", "ImageId": "ami-0ac019f4fcb7cb7e6", "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}], "IamInstanceProfile": {"Ref": "InstanceProfile"}}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "InstanceRole"}]}}, "InstanceRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"]}}, "AssociationLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "ADInstanceID"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": [{"Fn::If": ["StringNotEquals", {"Ref": "DNS1"}, "", {"Ref": "DNS1"}, "0.0.0.0"]}, {"Fn::If": ["StringNotEquals", {"Ref": "DNS2"}, "", {"Ref": "DNS2"}, "0.0.0.0"]}]}}}, "AssociationWindows1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "ADInstanceID"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": [{"Fn::If": ["StringNotEquals", {"Ref": "DNS1"}, "", {"Ref": "DNS1"}, "0.0.0.0"]}, {"Fn::If": ["StringNotEquals", {"Ref": "DNS2"}, "", {"Ref": "DNS2"}, "0.0.0.0"]}]}}}, "AssociationWindows2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance2"}, "Parameters": {"directoryId": [{"Ref": "ADInstanceID"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": [{"Fn::If": ["StringNotEquals", {"Ref": "DNS1"}, "", {"Ref": "DNS1"}, "0.0.0.0"]}, {"Fn::If": ["StringNotEquals", {"Ref": "DNS2"}, "", {"Ref": "DNS2"}, "0.0.0.0"]}]}}}, "AssociationWindows3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance3"}, "Parameters": {"directoryId": [{"Ref": "ADInstanceID"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": [{"Fn::If": ["StringNotEquals", {"Ref": "DNS1"}, "", {"Ref": "DNS1"}, "0.0.0.0"]}, {"Fn::If": ["StringNotEquals", {"Ref": "DNS2"}, "", {"Ref": "DNS2"}, "0.0.0.0"]}]}}}}}