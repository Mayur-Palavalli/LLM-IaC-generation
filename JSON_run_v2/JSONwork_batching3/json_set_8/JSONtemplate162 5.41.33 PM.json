{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to deploy one Linux and three Windows EC2 instances and join them to an Active Directory.", "Parameters": {"InstanceType": {"Type": "String", "Default": "t2.medium", "Description": "EC2 instance type."}, "KeyPairName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances."}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet Id where EC2 instances will be launched."}, "DomainName": {"Type": "String", "Description": "The name of the domain to which the EC2 instances should be joined."}, "DNSIPAddress1": {"Type": "String", "Description": "Primary DNS IP address for AD resolution."}, "DNSIPAddress2": {"Type": "String", "Description": "Secondary DNS IP address for AD resolution."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-xxxxxxxx", "KeyName": {"Ref": "KeyPairName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "LinuxEC2Instance"}, {"Key": "JoinDomain", "Value": "yes"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-yyyyyyyy", "KeyName": {"Ref": "KeyPairName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance1"}, {"Key": "JoinDomain", "Value": "yes"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "Set-DNSClientServerAddress -InterfaceAlias (Get-NetAdapter).InterfaceAlias -ServerAddresses ('", {"Ref": "DNSIPAddress1"}, "','", {"Ref": "DNSIPAddress2"}, "')\n", "$cred = New-Object System.Management.Automation.PSCredential ('YourUserHere', (ConvertTo-SecureString 'YourPasswordHere' -AsPlainText -Force))\n", "Add-Computer -DomainName '", {"Ref": "DomainName"}, "' -Credential $cred -Force -Restart\n", "</powershell>\n"]]}}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-yyyyyyyy", "KeyName": {"Ref": "KeyPairName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance2"}, {"Key": "JoinDomain", "Value": "yes"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "Set-DNSClientServerAddress -InterfaceAlias (Get-NetAdapter).InterfaceAlias -ServerAddresses ('", {"Ref": "DNSIPAddress1"}, "','", {"Ref": "DNSIPAddress2"}, "')\n", "$cred = New-Object System.Management.Automation.PSCredential ('YourUserHere', (ConvertTo-SecureString 'YourPasswordHere' -AsPlainText -Force))\n", "Add-Computer -DomainName '", {"Ref": "DomainName"}, "' -Credential $cred -Force -Restart\n", "</powershell>\n"]]}}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-yyyyyyyy", "KeyName": {"Ref": "KeyPairName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsEC2Instance3"}, {"Key": "JoinDomain", "Value": "yes"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "Set-DNSClientServerAddress -InterfaceAlias (Get-NetAdapter).InterfaceAlias -ServerAddresses ('", {"Ref": "DNSIPAddress1"}, "','", {"Ref": "DNSIPAddress2"}, "')\n", "$cred = New-Object System.Management.Automation.PSCredential ('YourUserHere', (ConvertTo-SecureString 'YourPasswordHere' -AsPlainText -Force))\n", "Add-Computer -DomainName '", {"Ref": "DomainName"}, "' -Credential $cred -Force -Restart\n", "</powershell>\n"]]}}}}}}