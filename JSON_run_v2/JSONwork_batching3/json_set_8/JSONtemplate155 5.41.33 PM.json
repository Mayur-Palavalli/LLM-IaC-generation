{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create an AD Connector and associated resources for directory service.", "Parameters": {"DirectoryDNSIpAddresses": {"Type": "CommaDelimitedList", "Description": "Comma-separated list of IP addresses for the directory DNS servers."}, "DirectoryName": {"Type": "String", "Description": "The fully qualified name of the on-premises domain."}, "VPCId": {"Type": "String", "Description": "VPC Id where the resources will be deployed."}, "SubnetIds": {"Type": "CommaDelimitedList", "Description": "Comma-separated list of subnet ids where the AD Connector will be deployed."}, "CreateSeamlessDomainJoinResources": {"Type": "String", "Default": "No", "AllowedValues": ["Yes", "No"], "Description": "Specify 'Yes' to create resources for seamless domain join for both Windows & Linux EC2 instances."}, "CreateDomainMembersSecurityGroup": {"Type": "String", "Default": "No", "AllowedValues": ["Yes", "No"], "Description": "Specify 'Yes' to create a Security Group for domain members that allows all private IP communications inbound."}, "CreateDHCPOptionsSet": {"Type": "String", "Default": "No", "AllowedValues": ["Yes", "No"], "Description": "Specify 'Yes' to create a DHCP options set pointing to the Domain DNS servers."}}, "Resources": {"DirectoryServiceADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "DirectoryName"}, "Password": "{{resolve:ssm-secure:ADServiceAccountPassword:1}}", "VpcSettings": {"VpcId": {"Ref": "VPCId"}, "SubnetIds": {"Ref": "SubnetIds"}}}}, "SeamlessDomainJoinResources": {"Type": "AWS::EC2::Instance", "Condition": "CreateSeamlessDomainJoin", "Properties": {"ImageId": "ami-0c55b159cbfafe1f0", "InstanceType": "t3.micro", "SubnetId": {"Fn::Select": ["0", {"Ref": "SubnetIds"}]}}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Condition": "CreateDomainMembersSecurityGroup", "Properties": {"GroupDescription": "Allow all inbound traffic on private IPs within VPC", "VpcId": {"Ref": "VPCId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "10.0.0.0/8"}]}}, "DHCPOptionsSet": {"Type": "AWS::EC2::DHCPOptions", "Condition": "CreateDHCPOptionsSet", "Properties": {"DomainName": {"Ref": "DirectoryName"}, "DomainNameServers": {"Ref": "DirectoryDNSIpAddresses"}}}, "DHCPOptionsSetAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Condition": "CreateDHCPOptionsSet", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionsSet"}, "VpcId": {"Ref": "VPCId"}}}}, "Conditions": {"CreateSeamlessDomainJoin": {"Fn::Equals": [{"Ref": "CreateSeamlessDomainJoinResources"}, "Yes"]}, "CreateDomainMembersSecurityGroup": {"Fn::Equals": [{"Ref": "CreateDomainMembersSecurityGroup"}, "Yes"]}, "CreateDHCPOptionsSet": {"Fn::Equals": [{"Ref": "CreateDHCPOptionsSet"}, "Yes"]}}}