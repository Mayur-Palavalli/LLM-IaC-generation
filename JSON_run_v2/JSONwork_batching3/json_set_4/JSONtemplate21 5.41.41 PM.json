{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template: Load balanced and Auto Scaled website with scheduled scaling.", "Parameters": {"InstanceType": {"Description": "EC2 instance type", "Type": "String", "Default": "t2.micro", "AllowedValues": ["t2.micro", "t2.small", "t2.medium"], "ConstraintDescription": "must be a valid EC2 instance type."}, "KeyName": {"Description": "The EC2 Key Pair to allow SSH access to the instances", "Type": "AWS::EC2::KeyPair::KeyName", "ConstraintDescription": "must be the name of an existing EC2 KeyPair."}, "SSHLocation": {"Description": "The IP address range that can be used to SSH to the EC2 instances", "Type": "String", "MinLength": "9", "MaxLength": "18", "Default": "0.0.0.0/0", "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})", "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."}, "ScaleCapacityMin": {"Description": "The minimum scale size of the Auto Scaling group.", "Type": "Number", "Default": "1"}, "ScaleCapacityMax": {"Description": "The maximum scale size of the Auto Scaling group.", "Type": "Number", "Default": "4"}}, "Resources": {"WebAppLoadBalancer": {"Type": "AWS::ElasticLoadBalancingV2::LoadBalancer", "Properties": {"Subnets": ["subnet-0a334d9f", "subnet-bbb467fa"], "SecurityGroups": [{"Ref": "WebAppSecurityGroup"}], "Type": "application"}}, "WebAppListener": {"Type": "AWS::ElasticLoadBalancingV2::Listener", "Properties": {"DefaultActions": [{"Type": "forward", "TargetGroupArn": {"Ref": "WebAppTargetGroup"}}], "LoadBalancerArn": {"Ref": "WebAppLoadBalancer"}, "Port": 80, "Protocol": "HTTP"}}, "WebAppTargetGroup": {"Type": "AWS::ElasticLoadBalancingV2::TargetGroup", "Properties": {"HealthCheckIntervalSeconds": 30, "HealthCheckPath": "/", "HealthCheckProtocol": "HTTP", "HealthCheckTimeoutSeconds": 5, "HealthyThresholdCount": 3, "Matcher": {"HttpCode": "200-299"}, "Port": 80, "Protocol": "HTTP", "UnhealthyThresholdCount": 5, "VpcId": "vpc-1a2b3c4d"}}, "WebAppSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Enable HTTP access via port 80", "VpcId": "vpc-1a2b3c4d", "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 80, "ToPort": 80, "CidrIp": {"Ref": "SSHLocation"}}]}}, "WebAppAutoScalingGroup": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"LaunchConfigurationName": {"Ref": "WebAppLaunchConfig"}, "MinSize": {"Ref": "ScaleCapacityMin"}, "MaxSize": {"Ref": "ScaleCapacityMax"}, "TargetGroupARNs": [{"Ref": "WebAppTargetGroup"}], "VPCZoneIdentifier": ["subnet-0a334d9f", "subnet-bbb467fa"]}}, "WebAppLaunchConfig": {"Type": "AWS::AutoScaling::LaunchConfiguration", "Properties": {"ImageId": "ami-0c55b159cbfafe1f0", "InstanceType": {"Ref": "InstanceType"}, "SecurityGroups": [{"Ref": "WebAppSecurityGroup"}], "KeyName": {"Ref": "KeyName"}, "UserData": {"Fn::Base64": "#!/bin/bash\nyum install -y httpd\nservice httpd start\necho \"Hello World from $(hostname -f)\" > /var/www/html/index.html"}}}, "WebAppScalingPolicyUp": {"Type": "AWS::AutoScaling::ScalingPolicy", "Properties": {"AdjustmentType": "ChangeInCapacity", "AutoScalingGroupName": {"Ref": "WebAppAutoScalingGroup"}, "Cooldown": "300", "ScalingAdjustment": "1"}}, "WebAppScalingPolicyDown": {"Type": "AWS::AutoScaling::ScalingPolicy", "Properties": {"AdjustmentType": "ChangeInCapacity", "AutoScalingGroupName": {"Ref": "WebAppAutoScalingGroup"}, "Cooldown": "300", "ScalingAdjustment": "-1"}}}}