{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation Sample Template for Amazon EKS Cluster on EC2", "Parameters": {"ClusterName": {"Type": "String", "Description": "The name of the EKS cluster"}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id"}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "Subnet Ids"}, "NodeInstanceType": {"Type": "String", "Description": "EC2 instance type for the nodes", "Default": "t3.medium", "AllowedValues": ["t2.micro", "t3.micro", "t3.small", "t3.medium", "t3.large", "m5.large", "m5.xlarge"], "ConstraintDescription": "must be a valid EC2 instance type."}}, "Resources": {"EKSCluster": {"Type": "AWS::EKS::Cluster", "Properties": {"Name": {"Ref": "ClusterName"}, "ResourcesVpcConfig": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Fn::Split": [",", {"Ref": "SubnetIds"}]}}, "RoleArn": {"Fn::GetAtt": ["EKSClusterRole", "Arn"]}}}, "EKSClusterRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "eks.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "eks-cluster-policy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["eks:*", "ec2:Describe*", "ec2:AttachNetworkInterface", "ec2:DetachNetworkInterface", "ecr:BatchCheckLayerAvailability", "ecr:GetDownloadUrlForLayer", "ecr:GetAuthorizationToken", "ecr:BatchGetImage", "autoscaling:DescribeAutoScalingGroups", "autoscaling:UpdateAutoScalingGroup"], "Resource": "*"}]}}]}}, "EKSNodeGroupRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "eks-nodegroup-policy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["eks:DescribeNodegroup", "eks:ListNodegroups", "eks:AccessKubernetesApi", "ec2:DescribeInstances", "ec2:DescribeRegions", "ecr:GetDownloadUrlForLayer", "ecr:BatchCheckLayerAvailability", "ecr:GetAuthorizationToken", "logs:CreateLogGroup", "logs:CreateLogStream", "logs:PutLogEvents"], "Resource": "*"}]}}]}}, "EKSNodeGroup": {"Type": "AWS::EKS::Nodegroup", "Properties": {"ClusterName": {"Ref": "ClusterName"}, "NodegroupName": {"Fn::Sub": "${ClusterName}-node-group"}, "ScalingConfig": {"DesiredSize": 2, "MaxSize": 3, "MinSize": 1}, "NodeRole": {"Fn::GetAtt": ["EKSNodeGroupRole", "Arn"]}, "Subnets": {"Fn::Split": [",", {"Ref": "SubnetIds"}]}, "InstanceTypes": [{"Ref": "NodeInstanceType"}], "AmiType": "AL2_x86_64"}}}, "Outputs": {"EKSClusterName": {"Description": "The name of the EKS cluster", "Value": {"Ref": "EKSCluster"}, "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-EKSClusterName"}}}, "EKSClusterEndpoint": {"Description": "The endpoint for the EKS cluster", "Value": {"Fn::GetAtt": ["EKSCluster", "Endpoint"]}, "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-EKSClusterEndpoint"}}}}}