{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for an AD Connector to connect to an on-premises directory with options for seamless domain join, security group, and DHCPOptionSet.", "Parameters": {"DomainDNSName": {"Type": "String", "Description": "The fully qualified domain name (FQDN) of the on-premises directory."}, "DomainController1": {"Type": "String", "Description": "IP address of the primary domain controller."}, "DomainController2": {"Type": "String", "Description": "IP address of the secondary domain controller."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The subnets in which the AD Connector will reside."}, "VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC where the AD Connector and all related resources will be created."}, "CreateDomainMembersSGOption": {"Type": "String", "Default": "false", "Description": "Option to create Domain Members Security Group. Set to 'true' to create."}, "CreateDHCPOptionSetOption": {"Type": "String", "Default": "false", "Description": "Option to create DHCP Option Set. Set to 'true' to create."}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "DomainDNSName"}, "Password": {"Fn::Sub": "{{resolve:ssm-secure:${DomainDNSName}-admin-password:1}}"}, "VpcSettings": {"SubnetIds": {"Ref": "SubnetIds"}, "VpcId": {"Ref": "VPCId"}}, "Edition": "Standard"}}, "DomainMembersSG": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for domain members allowing all Private IP communications.", "VpcId": {"Ref": "VPCId"}, "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 0, "ToPort": 65535, "CidrIp": "10.0.0.0/8"}, {"IpProtocol": "udp", "FromPort": 0, "ToPort": 65535, "CidrIp": "10.0.0.0/8"}]}, "Condition": "CreateDomainMembersSG"}, "DHCPOptionSet": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainName": {"Ref": "DomainDNSName"}, "DomainNameServers": [{"Ref": "DomainController1"}, {"Ref": "DomainController2"}]}, "Condition": "CreateDHCPOptionSet"}, "DHCPOptionSetAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionSet"}, "VpcId": {"Ref": "VPCId"}}, "Condition": "CreateDHCPOptionSet"}}, "Conditions": {"CreateDomainMembersSG": {"Fn::Equals": [{"Ref": "CreateDomainMembersSGOption"}, "true"]}, "CreateDHCPOptionSet": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSetOption"}, "true"]}}, "Outputs": {"ADConnectorId": {"Description": "The ID of the created AD Connector", "Value": {"Ref": "ADConnector"}}, "DomainMembersSecurityGroupId": {"Description": "The ID of the domain members security group", "Value": {"Fn::If": ["CreateDomainMembersSG", {"Ref": "DomainMembersSG"}, "Not created"]}}, "DHCPOptionsId": {"Description": "The ID of the DHCP options set", "Value": {"Fn::If": ["CreateDHCPOptionSet", {"Ref": "DHCPOptionSet"}, "Not created"]}}}}