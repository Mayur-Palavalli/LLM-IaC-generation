{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template that creates Linux and Windows EC2 instances and joins them to an AD using SSM.", "Parameters": {"InstanceType": {"Type": "String", "Default": "t2.micro", "Description": "EC2 instance type"}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the EC2 instances"}, "DomainName": {"Type": "String", "Description": "The name of the domain to join the instances to."}, "DirectoryId": {"Type": "String", "Description": "The directory ID of the AD Connector or AWS Managed AD."}, "DNSServers": {"Type": "CommaDelimitedList", "Default": "", "Description": "A comma-separated list of DNS server IP addresses. Leave blank to use default DHCP options."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": "ami-0abcd1234abcd1234", "NetworkInterfaces": [{"AssociatePublicIpAddress": true, "DeviceIndex": "0"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["#!/bin/bash\nyum update -y\nyum install -y amazon-ssm-agent\n${DNSConfiguration}systemctl start amazon-ssm-agent\nsystemctl enable amazon-ssm-agent", {"DNSConfiguration": {"Fn::If": ["UseCustomDNS", "echo 'nameserver ${DNSServers}' > /etc/resolv.conf\n", ""]}}]}}}}, "WindowsInstance": {"Type": "AWS::EC2::Instance", "CreationPolicy": {"ResourceSignal": {"Timeout": "PT15M"}}, "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": "ami-0abcde1234d56f789", "NetworkInterfaces": [{"AssociatePublicIpAddress": true, "DeviceIndex": "0"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["<powershell>Install-WindowsFeature RSAT-AD-PowerShell; ${DNSConfiguration}Install-SSMAgent.ps1; Set-Service -Name AmazonSSMAgent -StartupType 'Automatically'; Start-Service -Name AmazonSSMAgent</powershell>", {"DNSConfiguration": {"Fn::If": ["UseCustomDNS", "Set-DNSClientServerAddress -InterfaceAlias 'Ethernet' -ServerAddresses ${DNSServers};", ""]}}]}}}}, "InstanceRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": ["ec2.amazonaws.com"]}, "Action": ["sts:AssumeRole"]}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"]}}, "LinuxJoinDomain": {"Type": "AWS::SSM::Association", "Properties": {"AssociationName": "JoinLinuxToAD", "DocumentVersion": "$LATEST", "Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "instanceids", "Values": [{"Ref": "LinuxInstance"}]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "DomainName"}]}}}, "WindowsJoinDomainInline": {"Type": "AWS::SSM::Association", "Properties": {"AssociationName": "JoinWindowsToADInline", "DocumentVersion": "$DEFAULT", "Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "DomainName"}]}}}}, "Conditions": {"UseCustomDNS": {"Fn::Not": [{"Fn::Equals": [{"Fn::Join": ["", {"Ref": "DNSServers"}]}, ""]}]}}, "Outputs": {"LinuxInstanceId": {"Description": "ID of the Linux instance", "Value": {"Ref": "LinuxInstance"}}, "WindowsInstanceId": {"Description": "ID of the Windows instance", "Value": {"Ref": "WindowsInstance"}}}}