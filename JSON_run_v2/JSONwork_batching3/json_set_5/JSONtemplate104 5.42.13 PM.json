{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for a load balanced, scalable sample website using Elastic Load Balancer attached to an Auto Scaling group with connection draining and access logs.", "Resources": {"WebAppSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Enable HTTP access via port 80 and SSH access", "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 80, "ToPort": 80, "CidrIp": "0.0.0.0/0"}, {"IpProtocol": "tcp", "FromPort": 22, "ToPort": 22, "CidrIp": "0.0.0.0/0"}]}}, "WebAppLoadBalancer": {"Type": "AWS::ElasticLoadBalancingV2::LoadBalancer", "Properties": {"Subnets": [{"Ref": "SubnetA"}, {"Ref": "SubnetB"}], "SecurityGroups": [{"Ref": "WebAppSecurityGroup"}]}}, "WebAppTargetGroup": {"Type": "AWS::ElasticLoadBalancingV2::TargetGroup", "Properties": {"VpcId": {"Ref": "VPCId"}, "Port": 80, "Protocol": "HTTP", "HealthCheckPath": "/", "TargetType": "instance"}}, "WebAppListener": {"Type": "AWS::ElasticLoadBalancingV2::Listener", "Properties": {"DefaultActions": [{"Type": "forward", "TargetGroupArn": {"Ref": "WebAppTargetGroup"}}], "LoadBalancerArn": {"Ref": "WebAppLoadBalancer"}, "Port": 80, "Protocol": "HTTP"}}, "WebAppLaunchConfiguration": {"Type": "AWS::AutoScaling::LaunchConfiguration", "Properties": {"ImageId": "ami-12345678", "InstanceType": "t2.micro", "SecurityGroups": [{"Ref": "WebAppSecurityGroup"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/bin/bash\n", "yum install -y httpd\n", "systemctl start httpd\n", "systemctl enable httpd\n", "echo \"Hello World from $(hostname -f)\" > /var/www/html/index.html\n"]]}}}}, "WebAppAutoScalingGroup": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"LaunchConfigurationName": {"Ref": "WebAppLaunchConfiguration"}, "MinSize": "2", "MaxSize": "5", "TargetGroupARNs": [{"Ref": "WebAppTargetGroup"}], "VPCZoneIdentifier": [{"Ref": "SubnetA"}, {"Ref": "SubnetB"}]}}, "WebAppAccessLogBucket": {"Type": "AWS::S3::Bucket", "Properties": {"BucketName": "webapp-access-logs"}}, "BucketPolicy": {"Type": "AWS::S3::BucketPolicy", "Properties": {"Bucket": {"Ref": "WebAppAccessLogBucket"}, "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Sid": "AddLogDeliveryPermissions", "Effect": "Allow", "Principal": {"Service": "s3.amazonaws.com"}, "Action": "s3:PutObject", "Resource": [{"Fn::GetAtt": ["WebAppAccessLogBucket", "Arn"]}], "Condition": {"StringEquals": {"s3:x-amz-acl": "log-delivery-write"}}}]}}}}, "Parameters": {"VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id where resources will be created"}, "SubnetA": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet A for the load balancer"}, "SubnetB": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet B for the load balancer"}}, "Outputs": {"LoadBalancerURL": {"Description": "URL of the load balancer", "Value": {"Fn::GetAtt": ["WebAppLoadBalancer", "DNSName"]}}}}