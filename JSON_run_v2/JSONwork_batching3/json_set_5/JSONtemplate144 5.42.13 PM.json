{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create a secure S3 bucket with replication and logging enabled.", "Resources": {"PrimaryBucket": {"Type": "AWS::S3::Bucket", "Properties": {"BucketEncryption": {"ServerSideEncryptionConfiguration": [{"ServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"}}]}, "PublicAccessBlockConfiguration": {"BlockPublicAcls": true, "IgnorePublicAcls": true, "BlockPublicPolicy": true, "RestrictPublicBuckets": true}, "LoggingConfiguration": {"DestinationBucketName": {"Ref": "LogBucket"}, "LogFilePrefix": "primary/"}, "VersioningConfiguration": {"Status": "Enabled"}, "ReplicationConfiguration": {"Role": {"Fn::GetAtt": ["ReplicationRole", "Arn"]}, "Rules": [{"Destination": {"Bucket": {"Fn::GetAtt": ["ReplicaBucket", "Arn"]}}, "Status": "Enabled"}]}}}, "ReplicaBucket": {"Type": "AWS::S3::Bucket", "Properties": {"BucketEncryption": {"ServerSideEncryptionConfiguration": [{"ServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"}}]}, "PublicAccessBlockConfiguration": {"BlockPublicAcls": true, "IgnorePublicAcls": true, "BlockPublicPolicy": true, "RestrictPublicBuckets": true}, "VersioningConfiguration": {"Status": "Enabled"}}}, "LogBucket": {"Type": "AWS::S3::Bucket", "Properties": {"PublicAccessBlockConfiguration": {"BlockPublicAcls": true, "IgnorePublicAcls": true, "BlockPublicPolicy": true, "RestrictPublicBuckets": true}}}, "BucketPolicy": {"Type": "AWS::S3::BucketPolicy", "Properties": {"Bucket": {"Ref": "PrimaryBucket"}, "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Deny", "Principal": "*", "Action": "s3:*", "Resource": [{"Fn::GetAtt": ["PrimaryBucket", "Arn"]}, {"Fn::Join": ["", [{"Fn::GetAtt": ["PrimaryBucket", "Arn"]}, "/*"]]}], "Condition": {"Bool": {"aws:SecureTransport": "false"}}}]}}}, "ReplicationRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "s3.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "ReplicationPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["s3:GetReplicationConfiguration", "s3:ListBucket"], "Resource": [{"Fn::GetAtt": ["PrimaryBucket", "Arn"]}]}, {"Effect": "Allow", "Action": ["s3:GetObjectVersion", "s3:GetObjectVersionAcl"], "Resource": [{"Fn::GetAtt": ["PrimaryBucket", "Arn"]}, {"Fn::Join": ["", [{"Fn::GetAtt": ["PrimaryBucket", "Arn"]}, "/*"]]}]}, {"Effect": "Allow", "Action": ["s3:ReplicateObject", "s3:ReplicateDelete", "s3:ReplicateTags", "s3:GetObjectRetention", "s3:GetObjectLegalHold"], "Resource": [{"Fn::GetAtt": ["ReplicaBucket", "Arn"]}, {"Fn::Join": ["", [{"Fn::GetAtt": ["ReplicaBucket", "Arn"]}, "/*"]]}]}]}}]}}}, "Outputs": {"PrimaryBucketName": {"Description": "Name of the primary bucket", "Value": {"Ref": "PrimaryBucket"}}, "ReplicaBucketName": {"Description": "Name of the replica bucket", "Value": {"Ref": "ReplicaBucket"}}, "LogBucketName": {"Description": "Name of the log bucket", "Value": {"Ref": "LogBucket"}}}}