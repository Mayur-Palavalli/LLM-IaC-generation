{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for a VPC including an Aurora RDS and DMS setup with S3 integration.", "Resources": {"VPC": {"Type": "AWS::EC2::VPC", "Properties": {"CidrBlock": "10.0.0.0/16", "EnableDnsSupport": true, "EnableDnsHostnames": true}}, "Subnet": {"Type": "AWS::EC2::Subnet", "Properties": {"VpcId": {"Ref": "VPC"}, "CidrBlock": "10.0.1.0/24", "MapPublicIpOnLaunch": true}}, "DBSubnetGroup": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"DBSubnetGroupDescription": "Subnet Group for Aurora RDS Instance", "SubnetIds": [{"Ref": "Subnet"}]}}, "RDSSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPC"}, "GroupDescription": "Security group for Aurora RDS instance", "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 3306, "ToPort": 3306, "CidrIp": "0.0.0.0/0"}]}}, "AuroraDBCluster": {"Type": "AWS::RDS::DBCluster", "Properties": {"Engine": "aurora-mysql", "DBSubnetGroupName": {"Ref": "DBSubnetGroup"}, "VpcSecurityGroupIds": [{"Ref": "RDSSecurityGroup"}], "MasterUsername": "adminuser", "MasterUserPassword": {"Ref": "DBPassword"}, "BackupRetentionPeriod": 7}}, "S3Bucket": {"Type": "AWS::S3::Bucket", "DeletionPolicy": "Retain", "UpdateReplacePolicy": "Retain", "Properties": {}}, "DMSSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPC"}, "GroupDescription": "Security group for DMS replication instance", "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 3306, "ToPort": 3306, "SourceSecurityGroupId": {"Ref": "RDSSecurityGroup"}}]}}, "DMSReplicationInstance": {"Type": "AWS::DMS::ReplicationInstance", "Properties": {"ReplicationInstanceClass": "dms.t2.small", "VpcSecurityGroupIds": [{"Ref": "DMSSecurityGroup"}], "PubliclyAccessible": true}}, "DMSSourceEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointType": "source", "EngineName": "aurora-mysql", "Username": "adminuser", "Password": {"Ref": "DBPassword"}, "ServerName": {"Fn::GetAtt": ["AuroraDBCluster", "Endpoint.Address"]}, "Port": 3306, "DatabaseName": ""}}, "DMSTargetEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointType": "target", "EngineName": "s3", "S3Settings": {"BucketName": {"Ref": "S3Bucket"}}}}, "DMSReplicationTask": {"Type": "AWS::DMS::ReplicationTask", "Properties": {"MigrationType": "full-load-and-cdc", "ReplicationInstanceArn": {"Ref": "DMSReplicationInstance"}, "SourceEndpointArn": {"Ref": "DMSSourceEndpoint"}, "TargetEndpointArn": {"Ref": "DMSTargetEndpoint"}, "TableMappings": "{\"rules\": [{\"rule-type\": \"selection\", \"rule-id\": \"1\", \"rule-name\": \"1\", \"object-locator\": {\"schema-name\": \"%\", \"table-name\": \"%\"}, \"rule-action\": \"include\"}]}"}}}, "Outputs": {"RDSInstanceEndpoint": {"Value": {"Fn::GetAtt": ["AuroraDBCluster", "Endpoint.Address"]}, "Description": "Connect to this endpoint with your database client"}, "S3BucketName": {"Value": {"Ref": "S3Bucket"}, "Description": "Name of the S3 Bucket used as a target for DMS"}, "ReplicationInstancePublicIP": {"Value": {"Fn::GetAtt": ["DMSReplicationInstance", "ReplicationInstancePublicIpAddresses"]}, "Description": "The public IP address of the replication instance"}}, "Parameters": {"DBPassword": {"Type": "AWS::SSM::Parameter::Value<String>", "Description": "The password for the RDS and DMS instances", "NoEcho": true}}}