{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using SSM.", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the AWS Directory Service directory to join."}, "VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id"}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet Id"}, "InstanceType": {"Type": "String", "Default": "t3.medium", "Description": "The instance type for the EC2 instances."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "The EC2 Key Pair to allow SSH access to the instances."}, "DNSServers": {"Type": "String", "Description": "Optional comma-separated list of DNS servers to be used for the instances.", "Default": ""}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-08f3d892de259504d", "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}], "Tags": [{"Key": "Name", "Value": "LinuxInstance"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["#!/bin/bash\nsudo yum update -y\nDNS_SERVERS=\"${DNSServers}\"\nif [ -n \"$DNS_SERVERS\" ]; then\n    sudo sed -i -e \"s/^PEERDNS=.*/PEERDNS=no/\" /etc/sysconfig/network-scripts/ifcfg-eth0\n    echo -e \"nameserver ${!Ref DNSServers}\" | sudo tee /etc/resolv.conf\nfi\n", {"DNSServers": {"Ref": "DNSServers"}}]}}}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-0c55b159cbfafe1f0", "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}], "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["<script>\n<powershell>\n$dnsServers = '${DNSServers}'\nif ($dnsServers) {\n    Set-DnsClientServerAddress -InterfaceAlias 'Ethernet' -ServerAddresses ($dnsServers -split ',')\n}\n</powershell>\n</script>", {"DNSServers": {"Ref": "DNSServers"}}]}}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-0c55b159cbfafe1f0", "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}], "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["<script>\n<powershell>\n$dnsServers = '${DNSServers}'\nif ($dnsServers) {\n    Set-DnsClientServerAddress -InterfaceAlias 'Ethernet' -ServerAddresses ($dnsServers -split ',')\n}\n</powershell>\n</script>", {"DNSServers": {"Ref": "DNSServers"}}]}}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-0c55b159cbfafe1f0", "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}], "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["<script>\n<powershell>\n$dnsServers = '${DNSServers}'\nif ($dnsServers) {\n    Set-DnsClientServerAddress -InterfaceAlias 'Ethernet' -ServerAddresses ($dnsServers -split ',')\n}\n</powershell>\n</script>", {"DNSServers": {"Ref": "DNSServers"}}]}}}}, "InstanceSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPCId"}, "GroupDescription": "Allow SSH and RDP access", "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 22, "ToPort": 22, "CidrIp": "0.0.0.0/0"}, {"IpProtocol": "tcp", "FromPort": 3389, "ToPort": 3389, "CidrIp": "0.0.0.0/0"}]}}, "ADJoinAssociationInstanceIdLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["HasDns", {"Ref": "DNSServers"}, {"Ref": "AWS::NoValue"}]}]}}}, "ADJoinAssociationInstanceIdWindows2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance2"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["HasDns", {"Ref": "DNSServers"}, {"Ref": "AWS::NoValue"}]}]}}}, "ADJoinAssociationInstanceIdWindows3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance3"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["HasDns", {"Ref": "DNSServers"}, {"Ref": "AWS::NoValue"}]}]}}}, "ADJoinAssociationTagWindows": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance1"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": [{"Fn::If": ["HasDns", {"Ref": "DNSServers"}, {"Ref": "AWS::NoValue"}]}]}}}}, "Conditions": {"HasDns": {"Fn::Not": [{"Fn::Equals": [{"Ref": "DNSServers"}, ""]}]}}, "Outputs": {"LinuxInstanceId": {"Value": {"Ref": "LinuxInstance"}}, "WindowsInstance1Id": {"Value": {"Ref": "WindowsInstance1"}}, "WindowsInstance2Id": {"Value": {"Ref": "WindowsInstance2"}}, "WindowsInstance3Id": {"Value": {"Ref": "WindowsInstance3"}}}}