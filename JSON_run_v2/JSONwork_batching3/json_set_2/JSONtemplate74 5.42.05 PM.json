{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template that creates a Multi-AZ EFS file system and configures instances in multiple AZs to automount the EFS.", "Resources": {"MyEFSFileSystem": {"Type": "AWS::EFS::FileSystem", "Properties": {"Encrypted": true, "PerformanceMode": "generalPurpose", "ThroughputMode": "bursting"}}, "MountTargetAZ1": {"Type": "AWS::EFS::MountTarget", "Properties": {"FileSystemId": {"Ref": "MyEFSFileSystem"}, "SubnetId": "subnet-abcde123", "SecurityGroups": ["sg-12345678"]}}, "MountTargetAZ2": {"Type": "AWS::EFS::MountTarget", "Properties": {"FileSystemId": {"Ref": "MyEFSFileSystem"}, "SubnetId": "subnet-abcd1234", "SecurityGroups": ["sg-12345678"]}}, "InstanceProfileRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": ["ec2.amazonaws.com"]}, "Action": ["sts:AssumeRole"]}]}, "Path": "/", "Policies": [{"PolicyName": "EFSAccess", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["elasticfilesystem:DescribeFileSystems", "elasticfilesystem:DescribeMountTargets", "elasticfilesystem:DescribeMountTargetSecurityGroups"], "Resource": "*"}]}}]}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Path": "/", "Roles": [{"Ref": "InstanceProfileRole"}]}}, "EC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-abcdefgh", "InstanceType": "t2.micro", "SubnetId": "subnet-abcde123", "SecurityGroupIds": ["sg-12345678"], "IamInstanceProfile": {"Ref": "InstanceProfile"}, "UserData": {"Fn::Base64": {"Fn::Sub": ["#!/bin/bash\nsudo mkdir /mnt/efs\nsudo mount -t nfs4 -o nfsvers=4.1 ${FileSystemDNSName}:/ /mnt/efs\nsudo echo '${FileSystemDNSName}:/ /mnt/efs nfs defaults,_netdev 0 0' >> /etc/fstab", {"FileSystemDNSName": {"Fn::GetAtt": ["MyEFSFileSystem", "DNSName"]}}]}}}}, "EC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-abcdefgh", "InstanceType": "t2.micro", "SubnetId": "subnet-abcd1234", "SecurityGroupIds": ["sg-12345678"], "IamInstanceProfile": {"Ref": "InstanceProfile"}, "UserData": {"Fn::Base64": {"Fn::Sub": ["#!/bin/bash\nsudo mkdir /mnt/efs\nsudo mount -t nfs4 -o nfsvers=4.1 ${FileSystemDNSName}:/ /mnt/efs\nsudo echo '${FileSystemDNSName}:/ /mnt/efs nfs defaults,_netdev 0 0' >> /etc/fstab", {"FileSystemDNSName": {"Fn::GetAtt": ["MyEFSFileSystem", "DNSName"]}}]}}}}}, "Outputs": {"EFSFileSystemId": {"Description": "ID of the EFS file system", "Value": {"Ref": "MyEFSFileSystem"}}, "EFSFileSystemDNSName": {"Description": "DNS Name of the Mounted EFS file system", "Value": {"Fn::GetAtt": ["MyEFSFileSystem", "DNSName"]}}}}