{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for one Linux and three Windows EC2 instances and joins them to Active Directory using SSM document AWS-JoinDirectoryServiceDomain", "Parameters": {"ADDomainName": {"Type": "String", "Description": "The domain name of the Active Directory."}, "ADDomainOU": {"Type": "String", "Description": "The OU within the AD Domain."}, "PrivateDNS1": {"Type": "String", "Description": "Primary private DNS server IP address", "Default": ""}, "PrivateDNS2": {"Type": "String", "Description": "Secondary private DNS server IP address", "Default": ""}, "InstanceType": {"Type": "String", "Default": "t2.micro", "Description": "EC2 instance type.", "AllowedValues": ["t2.micro", "t2.small", "t2.medium"], "ConstraintDescription": "Must be a valid EC2 instance type."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances"}, "VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id"}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet Id"}, "AdminPassword": {"Type": "String", "Description": "The password for the Active Directory admin.", "NoEcho": true}, "SubnetId1": {"Type": "AWS::EC2::Subnet::Id", "Description": "First Subnet Id"}, "SubnetId2": {"Type": "AWS::EC2::Subnet::Id", "Description": "Second Subnet Id"}, "LinuxAMI": {"Type": "String", "Description": "Linux AMI ID"}, "WindowsAMI": {"Type": "String", "Description": "Windows AMI ID"}}, "Resources": {"DirectoryService": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Edition": "Standard", "Name": {"Ref": "ADDomainName"}, "Password": {"Ref": "AdminPassword"}, "VpcSettings": {"SubnetIds": [{"Ref": "SubnetId1"}, {"Ref": "SubnetId2"}], "VpcId": {"Ref": "VPCId"}}}}, "LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "SSMInstanceProfile"}, "ImageId": {"Ref": "LinuxAMI"}, "NetworkInterfaces": [{"AssociatePublicIpAddress": "true", "DeleteOnTermination": "true", "DeviceIndex": 0, "SubnetId": {"Ref": "SubnetId"}}], "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "SSMInstanceProfile"}, "ImageId": {"Ref": "WindowsAMI"}, "NetworkInterfaces": [{"AssociatePublicIpAddress": "true", "DeleteOnTermination": "true", "DeviceIndex": 0, "SubnetId": {"Ref": "SubnetId"}}], "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "SSMInstanceProfile"}, "ImageId": {"Ref": "WindowsAMI"}, "NetworkInterfaces": [{"AssociatePublicIpAddress": "true", "DeleteOnTermination": "true", "DeviceIndex": 0, "SubnetId": {"Ref": "SubnetId"}}], "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "SSMInstanceProfile"}, "ImageId": {"Ref": "WindowsAMI"}, "NetworkInterfaces": [{"AssociatePublicIpAddress": "true", "DeleteOnTermination": "true", "DeviceIndex": 0, "SubnetId": {"Ref": "SubnetId"}}], "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "SSMInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "SSMRole"}]}}, "SSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "Policies": [{"PolicyName": "SSMPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:DescribeAssociation", "ssm:GetAutomationExecution", "ssm:GetDocument", "ssm:ListAssociations", "ssm:ListInstanceAssociations", "ssm:SendCommand", "ssm:StartAutomationExecution", "ec2:DescribeInstanceStatus", "ec2:DescribeInstances"], "Resource": "*"}]}}]}}, "SSMAssociationInline": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": {"Ref": "DirectoryService"}, "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Fn::If": ["IsEmptyPrivateDNS", {"Ref": "AWS::NoValue"}, [{"Ref": "PrivateDNS1"}, {"Ref": "PrivateDNS2"}]]}], "organizationalUnit": [{"Ref": "ADDomainOU"}]}}}, "SSMAssociationLinuxAndWindows": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "LinuxInstance"}, {"Ref": "WindowsInstance2"}]}], "Parameters": {"directoryId": {"Ref": "DirectoryService"}, "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Fn::If": ["IsEmptyPrivateDNS", {"Ref": "AWS::NoValue"}, [{"Ref": "PrivateDNS1"}, {"Ref": "PrivateDNS2"}]]}], "organizationalUnit": [{"Ref": "ADDomainOU"}]}}}, "SSMAssociationTags": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance3"]}], "Parameters": {"directoryId": {"Ref": "DirectoryService"}, "directoryName": [{"Ref": "ADDomainName"}], "dnsIpAddresses": [{"Fn::If": ["IsEmptyPrivateDNS", {"Ref": "AWS::NoValue"}, [{"Ref": "PrivateDNS1"}, {"Ref": "PrivateDNS2"}]]}], "organizationalUnit": [{"Ref": "ADDomainOU"}]}}}}, "Metadata": {"IsEmptyPrivateDNS": {"Fn::Equals": [{"Ref": "PrivateDNS1"}, ""]}}}