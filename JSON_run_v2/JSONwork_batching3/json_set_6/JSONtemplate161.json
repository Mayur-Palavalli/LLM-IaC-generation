{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for one Linux and three Windows EC2 instances joined to AD using AWS-JoinDirectoryServiceDomain SSM document", "Parameters": {"ADDomainName": {"Type": "String", "Description": "The domain name of the Active Directory"}, "DomainDNSIPAddress": {"Type": "String", "Description": "A comma-delimited list of DNS server IP addresses for the AD domain"}, "LinuxInstanceType": {"Type": "String", "Description": "Linux EC2 instance type", "Default": "t2.micro"}, "WindowsInstanceType": {"Type": "String", "Description": "Windows EC2 instance type", "Default": "t2.micro"}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "The EC2 Key Pair to allow SSH access to the instances"}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "LinuxInstanceType"}, "ImageId": "ami-0abcdef1234567890", "KeyName": {"Ref": "KeyName"}, "AvailabilityZone": {"Fn::Select": ["0", {"Fn::GetAZs": ""}]}, "Tags": [{"Key": "InstanceType", "Value": "Linux"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": "ami-0abcdef1234567890", "KeyName": {"Ref": "KeyName"}, "AvailabilityZone": {"Fn::Select": ["1", {"Fn::GetAZs": ""}]}, "Tags": [{"Key": "InstanceType", "Value": "Windows"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["<powershell>\nAdd-Computer -DomainName ${ADDomainName} -DomainCredential (New-Object System.Management.Automation.PSCredential('${ADDomainName}\\Administrator',(ConvertTo-SecureString 'PASSWORD_PLACEHOLDER' -AsPlainText -Force))) -Restart -Force\nSet-DnsClientServerAddress -InterfaceAlias \"Ethernet\" -ServerAddresses @(${DomainDNSIPAddress})\n</powershell>", {"ADDomainName": {"Ref": "ADDomainName"}, "DomainDNSIPAddress": {"Fn::Join": [",", {"Fn::Split": [",", {"Ref": "DomainDNSIPAddress"}]}]}}]}}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": "ami-0abcdef1234567890", "KeyName": {"Ref": "KeyName"}, "AvailabilityZone": {"Fn::Select": ["2", {"Fn::GetAZs": ""}]}, "Tags": [{"Key": "InstanceType", "Value": "Windows"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["<powershell>\nAdd-Computer -DomainName ${ADDomainName} -DomainCredential (New-Object System.Management.Automation.PSCredential('${ADDomainName}\\Administrator',(ConvertTo-SecureString 'PASSWORD_PLACEHOLDER' -AsPlainText -Force))) -Restart -Force\nSet-DnsClientServerAddress -InterfaceAlias \"Ethernet\" -ServerAddresses @(${DomainDNSIPAddress})\n</powershell>", {"ADDomainName": {"Ref": "ADDomainName"}, "DomainDNSIPAddress": {"Fn::Join": [",", {"Fn::Split": [",", {"Ref": "DomainDNSIPAddress"}]}]}}]}}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "WindowsInstanceType"}, "ImageId": "ami-0abcdef1234567890", "KeyName": {"Ref": "KeyName"}, "AvailabilityZone": {"Fn::Select": ["3", {"Fn::GetAZs": ""}]}, "Tags": [{"Key": "InstanceType", "Value": "Windows"}], "UserData": {"Fn::Base64": {"Fn::Sub": ["<powershell>\nAdd-Computer -DomainName ${ADDomainName} -DomainCredential (New-Object System.Management.Automation.PSCredential('${ADDomainName}\\Administrator',(ConvertTo-SecureString 'PASSWORD_PLACEHOLDER' -AsPlainText -Force))) -Restart -Force\nSet-DnsClientServerAddress -InterfaceAlias \"Ethernet\" -ServerAddresses @(${DomainDNSIPAddress})\n</powershell>", {"ADDomainName": {"Ref": "ADDomainName"}, "DomainDNSIPAddress": {"Fn::Join": [",", {"Fn::Split": [",", {"Ref": "DomainDNSIPAddress"}]}]}}]}}}}}}