{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create an AD Connector and related resources.", "Parameters": {"VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC ID for the AD Connector."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The list of subnet IDs for the AD Connector."}, "ADConnectorName": {"Type": "String", "Description": "The name of the AD Connector."}, "DirectoryDnsServers": {"Type": "CommaDelimitedList", "Description": "Comma-separated list of DNS servers for the on-premises domain."}, "Password": {"Type": "String", "Description": "The password for the AD Connector's service account."}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "ADConnectorName"}, "Password": {"Fn::Sub": "{{resolve:secretsmanager:${Password}::secretString}}"}, "VpcSettings": {"SubnetIds": {"Ref": "SubnetIds"}, "VpcId": {"Ref": "VpcId"}}, "Edition": "Standard"}}, "DHCPOptionSet": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Ref": "DirectoryDnsServers"}}}, "DHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionSet"}, "VpcId": {"Ref": "VpcId"}}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for domain member instances", "VpcId": {"Ref": "VpcId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}], "SecurityGroupEgress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}]}}, "SeamlessDomainJoinWindows": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-0c55b159cbfafe1f0", "SecurityGroupIds": [{"Ref": "DomainMembersSecurityGroup"}], "KeyName": "YourKeyName", "IamInstanceProfile": "SeamlessDomainJoin", "UserData": {"Fn::Base64": {"Fn::Sub": "\n<powershell>\n            # Join Domain Script for Windows\n            Add-Computer -DomainName 'yourdomain.com' -Credential (New-Object System.Management.Automation.PSCredential('domain\\user', (ConvertTo-SecureString -String '{{resolve:secretsmanager:${Password}::secretString}}' -AsPlainText -Force))) -Restart\n</powershell>\n"}}}}, "SeamlessDomainJoinLinux": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-0c55b159cbfafe1f0", "SecurityGroupIds": [{"Ref": "DomainMembersSecurityGroup"}], "KeyName": "YourKeyName", "IamInstanceProfile": "SeamlessDomainJoin", "UserData": {"Fn::Base64": {"Fn::Sub": "\n#!/bin/bash\n# Join Domain Script for Linux\necho -e 'user\n{{resolve:secretsmanager:${Password}::secretString}}' | realm join -U domain_user domain.com\n"}}}}}, "Outputs": {"ADConnectorId": {"Description": "ID of the created AD Connector", "Value": {"Ref": "ADConnector"}}, "DHCPOptionSetId": {"Description": "ID of the created DHCP Option Set", "Value": {"Ref": "DHCPOptionSet"}}, "DomainMembersSGId": {"Description": "ID of the created Security Group for domain members", "Value": {"Ref": "DomainMembersSecurityGroup"}}}}