{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template that provisions one Linux and three Windows EC2 instances and joins them to an AD domain.", "Parameters": {"KeyPairName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances"}, "InstanceType": {"Type": "String", "Default": "t2.micro", "Description": "EC2 instance type"}, "DomainName": {"Type": "String", "Description": "The fully qualified domain name (FQDN) of the directory to join."}, "DirectoryId": {"Type": "String", "Description": "The directory ID of the Active Directory."}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "The subnet ID in which the instances will be launched."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "SubnetId": {"Ref": "SubnetId"}, "KeyName": {"Ref": "KeyPairName"}, "ImageId": "ami-0c55b159cbfafe1f0", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "UserData": {"Fn::Base64": "#!/bin/bash\nsudo yum install -y aws-cli"}, "Tags": [{"Key": "Role", "Value": "LinuxDomainMember"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "SubnetId": {"Ref": "SubnetId"}, "KeyName": {"Ref": "KeyPairName"}, "ImageId": "ami-0d8f6eb4f641ef691", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "UserData": {"Fn::Base64": "<script>\n<powershell>\ncd C:\\\n</powershell>\n</script>"}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "SubnetId": {"Ref": "SubnetId"}, "KeyName": {"Ref": "KeyPairName"}, "ImageId": "ami-0d8f6eb4f641ef691", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "UserData": {"Fn::Base64": "<script>\n<powershell>\ncd C:\\\n</powershell>\n</script>"}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "SubnetId": {"Ref": "SubnetId"}, "KeyName": {"Ref": "KeyPairName"}, "ImageId": "ami-0d8f6eb4f641ef691", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "UserData": {"Fn::Base64": "<script>\n<powershell>\ncd C:\\\n</powershell>\n</script>"}, "Tags": [{"Key": "Role", "Value": "WindowsDomainMember"}]}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "SSMRole"}]}}, "SSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": ["ec2.amazonaws.com"]}, "Action": ["sts:AssumeRole"]}]}, "Policies": [{"PolicyName": "SSMandCWPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:DescribeAssociation", "ssm:GetDocument", "ssm:ListAssociations", "ssm:UpdateAssociationStatus", "ssm:UpdateInstanceInformation", "ds:CreateComputer", "ds:AuthenticateUser"], "Resource": "*"}]}}]}}, "SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": {"Ref": "DirectoryId"}, "directoryName": {"Ref": "DomainName"}, "dnsIpAddresses": ["10.0.0.11", "10.0.0.12"]}}}}, "Outputs": {"LinuxInstanceId": {"Description": "ID of the Linux instance", "Value": {"Ref": "LinuxInstance"}}, "WindowsInstance1Id": {"Description": "ID of the first Windows instance", "Value": {"Ref": "WindowsInstance1"}}, "WindowsInstance2Id": {"Description": "ID of the second Windows instance", "Value": {"Ref": "WindowsInstance2"}}, "WindowsInstance3Id": {"Description": "ID of the third Windows instance", "Value": {"Ref": "WindowsInstance3"}}}}