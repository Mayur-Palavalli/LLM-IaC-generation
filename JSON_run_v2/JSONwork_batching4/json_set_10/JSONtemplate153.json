{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to create an AD Connector with options for seamless domain join resources, security group, and DHCP Option Set.", "Parameters": {"DirectoryName": {"Type": "String", "Description": "The fully qualified name (FQDN) of the on-premises directory."}, "DomainDNSIP1": {"Type": "String", "Description": "The IP address of the primary DNS server for the on-premises directory."}, "DomainDNSIP2": {"Type": "String", "Description": "The IP address of the secondary DNS server for the on-premises directory."}, "SubnetId1": {"Type": "String", "Description": "The ID of the first subnet in your VPC in which to create the directory."}, "SubnetId2": {"Type": "String", "Description": "The ID of the second subnet in your VPC in which to create the directory."}, "CreateSecurityGroup": {"Type": "String", "AllowedValues": ["Yes", "No"], "Default": "No", "Description": "Whether to create a domain members security group that allows all PrivateIP communications inbound."}, "CreateDHCPOptionSet": {"Type": "String", "AllowedValues": ["Yes", "No"], "Default": "No", "Description": "Whether to create a DHCPOptionSet pointing to Domain DNS servers."}, "VpcId": {"Type": "String", "Description": "The ID of the VPC to associate the resources with."}, "SecretManagerArn": {"Type": "String", "Description": "The ARN of the Secrets Manager secret containing the directory password."}}, "Resources": {"SimpleAD": {"Type": "AWS::DirectoryService::SimpleAD", "Properties": {"Name": {"Ref": "DirectoryName"}, "Password": {"Fn::Sub": "{{resolve:secretsmanager:${SecretManagerArn}:SecretString:Password}}"}, "Size": "Small", "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": [{"Ref": "SubnetId1"}, {"Ref": "SubnetId2"}]}}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Condition": "CreateSecurityGroupCondition", "Properties": {"GroupDescription": "Security group for domain members allowing all PrivateIP communications inbound.", "VpcId": {"Ref": "VpcId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "10.0.0.0/8"}]}}, "DHCPOptionSet": {"Type": "AWS::EC2::DHCPOptions", "Condition": "CreateDHCPOptionSetCondition", "Properties": {"DomainNameServers": [{"Ref": "DomainDNSIP1"}, {"Ref": "DomainDNSIP2"}], "DomainName": {"Ref": "DirectoryName"}}}, "DHCPOptionSetAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Condition": "CreateDHCPOptionSetCondition", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionSet"}, "VpcId": {"Ref": "VpcId"}}}}, "Conditions": {"CreateSecurityGroupCondition": {"Fn::Equals": [{"Ref": "CreateSecurityGroup"}, "Yes"]}, "CreateDHCPOptionSetCondition": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "Yes"]}}}