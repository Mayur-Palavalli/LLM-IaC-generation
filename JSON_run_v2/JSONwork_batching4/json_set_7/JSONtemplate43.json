{"AWSTemplateFormatVersion": "2010-09-09", "Resources": {"MyVPC": {"Type": "AWS::EC2::VPC", "Properties": {"CidrBlock": "10.0.0.0/16"}}, "MySubnet1": {"Type": "AWS::EC2::Subnet", "Properties": {"VpcId": {"Ref": "MyVPC"}, "CidrBlock": "10.0.1.0/24", "AvailabilityZone": {"Fn::Select": ["0", {"Fn::GetAZs": ""}]}}}, "MySubnet2": {"Type": "AWS::EC2::Subnet", "Properties": {"VpcId": {"Ref": "MyVPC"}, "CidrBlock": "10.0.2.0/24", "AvailabilityZone": {"Fn::Select": ["1", {"Fn::GetAZs": ""}]}}}, "AuroraDBCluster": {"Type": "AWS::RDS::DBCluster", "Properties": {"Engine": "aurora-mysql", "MasterUsername": "admin", "MasterUserPassword": "{{resolve:secretsmanager:MySecret:SecretString:DBMasterUserPassword}}", "DBSubnetGroupName": {"Ref": "DBSubnetGroup"}, "VpcSecurityGroupIds": [{"Ref": "DBSecurityGroup"}]}}, "MyDBInstance1": {"Type": "AWS::RDS::DBInstance", "Properties": {"DBClusterIdentifier": {"Ref": "AuroraDBCluster"}, "Engine": "aurora-mysql", "DBInstanceClass": "db.r5.large", "DBSubnetGroupName": {"Ref": "DBSubnetGroup"}}}, "MyDBInstance2": {"Type": "AWS::RDS::DBInstance", "Properties": {"DBClusterIdentifier": {"Ref": "AuroraDBCluster"}, "Engine": "aurora-mysql", "DBInstanceClass": "db.r5.large", "DBSubnetGroupName": {"Ref": "DBSubnetGroup"}}}, "DBSubnetGroup": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"DBSubnetGroupDescription": "Subnet group for Aurora RDS", "SubnetIds": [{"Ref": "MySubnet1"}, {"Ref": "MySubnet2"}]}}, "DBSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "MyVPC"}, "GroupDescription": "Allow access to Aurora RDS"}}, "S3Bucket": {"Type": "AWS::S3::Bucket", "Properties": {}}, "MyDMSInstance": {"Type": "AWS::DMS::ReplicationInstance", "Properties": {"ReplicationInstanceClass": "dms.t2.medium", "VpcSecurityGroupIds": [{"Ref": "DMSSecurityGroup"}], "ReplicationSubnetGroupIdentifier": {"Ref": "DMSSubnetGroup"}}}, "DMSSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "MyVPC"}, "GroupDescription": "Allow access to DMS"}}, "DMSSubnetGroup": {"Type": "AWS::DMS::ReplicationSubnetGroup", "Properties": {"ReplicationSubnetGroupDescription": "Subnet group for DMS", "SubnetIds": [{"Ref": "MySubnet1"}, {"Ref": "MySubnet2"}]}}, "DMSSourceEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointIdentifier": "aurora-source", "EndpointType": "source", "EngineName": "aurora-mysql", "Username": "admin", "Password": "{{resolve:secretsmanager:MySecret:SecretString:DMSSourceEndpointPassword}}", "ServerName": {"Fn::GetAtt": ["AuroraDBCluster", "Endpoint.Address"]}, "Port": 3306, "DatabaseName": "mydatabase"}}, "DMSTargetEndpoint": {"Type": "AWS::DMS::Endpoint", "Properties": {"EndpointIdentifier": "s3-target", "EndpointType": "target", "EngineName": "s3", "S3Settings": {"BucketName": {"Ref": "S3Bucket"}, "ServiceAccessRoleArn": "arn:aws:iam::YOUR_ACCOUNT_ID:role/dms-s3-access-role"}}}, "DMSTask": {"Type": "AWS::DMS::ReplicationTask", "Properties": {"MigrationType": "full-load-and-cdc", "ReplicationInstanceArn": {"Ref": "MyDMSInstance"}, "SourceEndpointArn": {"Ref": "DMSSourceEndpoint"}, "TargetEndpointArn": {"Ref": "DMSTargetEndpoint"}, "TableMappings": "{\"rules\":[{\"rule-type\":\"selection\",\"rule-id\":\"1\",\"rule-name\":\"1\",\"object-locator\":{\"schema-name\":\"%\",\"table-name\":\"%\"},\"rule-action\":\"include\"}]}", "ReplicationTaskSettings": "{}"}}}, "Parameters": {}}