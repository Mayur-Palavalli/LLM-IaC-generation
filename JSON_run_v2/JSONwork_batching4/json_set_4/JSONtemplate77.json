{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation Sample Template to create an EKS Cluster on EC2", "Parameters": {"ClusterName": {"Type": "String", "Default": "eks-cluster", "Description": "The name of the EKS cluster"}, "NodeInstanceType": {"Type": "String", "Default": "t3.medium", "AllowedValues": ["t2.small", "t2.medium", "t2.large", "t3.small", "t3.medium", "t3.large"], "Description": "EC2 instance type for the EKS nodes"}, "NodeAutoScalingGroupMinSize": {"Default": "1", "Description": "Minimum size for the Node Group Auto Scaling Group", "Type": "Number"}, "NodeAutoScalingGroupMaxSize": {"Default": "3", "Description": "Maximum size for the Node Group Auto Scaling Group", "Type": "Number"}, "NodeVolumeSize": {"Default": "20", "Description": "Size of the EBS volume (GiB) for the EKS nodes", "Type": "Number"}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "ID of your existing VPC"}, "Subnets": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The subnets to use for the Auto Scaling group"}}, "Resources": {"EKSCluster": {"Type": "AWS::EKS::Cluster", "Properties": {"Name": {"Ref": "ClusterName"}, "ResourcesVpcConfig": {"SecurityGroupIds": [], "SubnetIds": {"Ref": "Subnets"}}, "RoleArn": {"Fn::GetAtt": ["NodeInstanceRole", "Arn"]}}}, "NodeInstanceRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy", "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy", "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"]}}, "NodeSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "EKS worker nodes security group", "VpcId": {"Ref": "VpcId"}}}, "NodeAutoScalingGroup": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"VPCZoneIdentifier": {"Ref": "Subnets"}, "LaunchConfigurationName": {"Ref": "NodeLaunchConfiguration"}, "MinSize": {"Ref": "NodeAutoScalingGroupMinSize"}, "MaxSize": {"Ref": "NodeAutoScalingGroupMaxSize"}, "DesiredCapacity": {"Ref": "NodeAutoScalingGroupMinSize"}}}, "NodeLaunchConfiguration": {"Type": "AWS::AutoScaling::LaunchConfiguration", "Properties": {"ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "AMI"]}, "InstanceType": {"Ref": "NodeInstanceType"}, "IamInstanceProfile": {"Ref": "NodeInstanceProfile"}, "SecurityGroups": [{"Ref": "NodeSecurityGroup"}], "BlockDeviceMappings": [{"DeviceName": "/dev/xvda", "Ebs": {"VolumeSize": {"Ref": "NodeVolumeSize"}}}], "UserData": {"Fn::Base64": {"Fn::Sub": ["#!/bin/bash\nset -o xtrace\n/etc/eks/bootstrap.sh ${ClusterName}", {"ClusterName": {"Ref": "ClusterName"}}]}}}}, "NodeInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "NodeInstanceRole"}]}}}, "Mappings": {"RegionMap": {"us-east-1": {"AMI": "ami-0ed9277fb7eb570c9"}, "us-west-2": {"AMI": "ami-0ed9277fb7eb570c9"}}}}