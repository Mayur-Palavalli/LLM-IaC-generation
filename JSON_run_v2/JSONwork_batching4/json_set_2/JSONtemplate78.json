{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation Template to create an EKS Cluster on EC2", "Parameters": {"ClusterName": {"Type": "String", "Description": "The name of the EKS Cluster"}, "NodeInstanceType": {"Type": "String", "Description": "EC2 instance type for the EKS node group", "Default": "t3.medium", "AllowedValues": ["t2.micro", "t2.small", "t3.medium", "m5.large"]}, "NodeGroupName": {"Type": "String", "Description": "The name of the node group"}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances"}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC Id for the EKS Cluster"}, "Subnets": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "Subnets for the EKS Cluster"}}, "Resources": {"EksCluster": {"Type": "AWS::EKS::Cluster", "Properties": {"Name": {"Ref": "ClusterName"}, "ResourcesVpcConfig": {"SubnetIds": {"Ref": "Subnets"}, "VpcId": {"Ref": "VpcId"}}, "RoleArn": {"Fn::GetAtt": ["EksClusterRole", "Arn"]}}}, "EksClusterRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "eks.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSClusterPolicy", "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy", "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"]}}, "NodeInstanceRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy", "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly", "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"]}}, "NodeGroup": {"Type": "AWS::EKS::Nodegroup", "Properties": {"ClusterName": {"Ref": "ClusterName"}, "NodeRole": {"Fn::GetAtt": ["NodeInstanceRole", "Arn"]}, "Subnets": {"Ref": "Subnets"}, "ScalingConfig": {"DesiredSize": 2, "MinSize": 1, "MaxSize": 3}, "InstanceTypes": [{"Ref": "NodeInstanceType"}], "AmiType": "AL2_x86_64", "NodegroupName": {"Ref": "NodeGroupName"}, "RemoteAccess": {"Ec2SshKey": {"Ref": "KeyName"}}}}}, "Outputs": {"EksClusterName": {"Description": "Name of the EKS Cluster", "Value": {"Ref": "ClusterName"}}, "NodeGroupRoleArn": {"Description": "ARN of the Node Group Role", "Value": {"Fn::GetAtt": ["NodeInstanceRole", "Arn"]}}}}