{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document via AD Connector or AWS Managed AD directory.", "Parameters": {"ADDomainName": {"Type": "String", "Description": "The name of the AD domain to join"}, "DNS1": {"Type": "String", "Description": "Primary DNS server IP (Optional)", "Default": "", "AllowedPattern": "^(\\b25[0-5]|\\b2[0-4][0-9]|\\b[01]?[0-9][0-9]?)\\.(\\b25[0-5]|\\b2[0-4][0-9]|\\b[01]?[0-9][0-9]?)\\.(\\b25[0-5]|\\b2[0-4][0-9]|\\b[01]?[0-9][0-9]?)\\.(\\b25[0-5]|\\b2[0-4][0-9]|\\b[01]?[0-9][0-9]?)$", "ConstraintDescription": "Optional primary DNS server IP must be a valid IP address."}, "DNS2": {"Type": "String", "Description": "Secondary DNS server IP (Optional)", "Default": "", "AllowedPattern": "^(\\b25[0-5]|\\b2[0-4][0-9]|\\b[01]?[0-9][0-9]?)\\.(\\b25[0-5]|\\b2[0-4][0-9]|\\b[01]?[0-9][0-9]?)\\.(\\b25[0-5]|\\b2[0-4][0-9]|\\b[01]?[0-9][0-9]?)\\.(\\b25[0-5]|\\b2[0-4][0-9]|\\b[01]?[0-9][0-9]?)$", "ConstraintDescription": "Optional secondary DNS server IP must be a valid IP address."}, "InstanceType": {"Type": "String", "Default": "t2.micro", "AllowedValues": ["t2.micro", "t2.small", "t2.medium"], "Description": "EC2 instance type"}, "KeyName": {"Description": "Name of an existing EC2 KeyPair to enable SSH access to the Linux instance", "Type": "AWS::EC2::KeyPair::KeyName"}, "SubnetId": {"Description": "Subnet ID for the instances", "Type": "AWS::EC2::Subnet::Id"}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Fn::FindInMap": ["AWSRegionArch2AMI", {"Ref": "AWS::Region"}, "HVM64"]}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Fn::FindInMap": ["AWSRegionArch2AMI", {"Ref": "AWS::Region"}, "Windows"]}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Fn::FindInMap": ["AWSRegionArch2AMI", {"Ref": "AWS::Region"}, "Windows"]}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Fn::FindInMap": ["AWSRegionArch2AMI", {"Ref": "AWS::Region"}, "Windows"]}, "SubnetId": {"Ref": "SubnetId"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "LinuxInstanceSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "ADDomainName"}]}, "OutputLocation": {"S3Location": {"OutputS3BucketName": "your-s3-bucket-name"}}}}, "WindowsInstance1SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "ADDomainName"}]}}}, "WindowsInstance2SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance2"}, "Parameters": {"directoryId": [{"Ref": "ADDomainName"}]}}}, "WindowsInstance3SSMAssociationByTag": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance3"]}], "Parameters": {"directoryId": [{"Ref": "ADDomainName"}]}}}}, "Mappings": {"AWSRegionArch2AMI": {"us-east-1": {"HVM64": "ami-0c55b159cbfafe1f0", "Windows": "ami-0abcdef12345abcde"}, "us-west-2": {"HVM64": "ami-0abcdef12345abcde", "Windows": "ami-0c55b159cbfafe1f0"}}}, "Outputs": {"LinuxInstanceId": {"Description": "InstanceId of the Linux EC2 instance", "Value": {"Ref": "LinuxInstance"}}, "WindowsInstance1Id": {"Description": "InstanceId of the Windows EC2 instance 1", "Value": {"Ref": "WindowsInstance1"}}, "WindowsInstance2Id": {"Description": "InstanceId of the Windows EC2 instance 2", "Value": {"Ref": "WindowsInstance2"}}, "WindowsInstance3Id": {"Description": "InstanceId of the Windows EC2 instance 3", "Value": {"Ref": "WindowsInstance3"}}}}