{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation Template to create an AD Connector with associated resources for Windows & Linux EC2 instances", "Parameters": {"VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC ID for the AD Connector"}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "Subnet IDs for the AD Connector"}, "OnPremDirectoryDnsIpAddresses": {"Type": "CommaDelimitedList", "Description": "DNS IP Addresses for the on-premises directory"}, "DomainDnsName": {"Type": "String", "Description": "The fully qualified domain name (FQDN) for your on-premises directory"}, "NetBiosName": {"Type": "String", "Description": "NetBIOS name for your on-premises directory", "AllowedPattern": "^[a-zA-Z0-9._-]{1,15}$"}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "DomainDnsName"}, "Password": {"Fn::Join": ["", ["{{resolve:secretsmanager:ARN_OF_YOUR_SECRET}}"]]}, "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Ref": "SubnetIds"}}, "Edition": "Standard", "ShortName": {"Ref": "NetBiosName"}}}, "SeamlessDomainJoinRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "SeamlessDomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:DescribeDirectories", "ds:CreateComputer", "ds:DeleteComputer"], "Resource": "*"}]}}]}}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VpcId"}, "GroupDescription": "Security group for domain members that allows all PrivateIP communications.", "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "10.0.0.0/8"}]}}, "DHCPOptionsSet": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainName": {"Ref": "DomainDnsName"}, "DomainNameServers": {"Ref": "OnPremDirectoryDnsIpAddresses"}}}, "VPCDHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"VpcId": {"Ref": "VpcId"}, "DhcpOptionsId": {"Ref": "DHCPOptionsSet"}}}}, "Outputs": {"ADConnectorId": {"Description": "AD Connector ID", "Value": {"Ref": "ADConnector"}}, "DomainMembersSecurityGroupId": {"Description": "Security Group ID for domain members", "Value": {"Ref": "DomainMembersSecurityGroup"}}, "SeamlessDomainJoinRoleArn": {"Description": "IAM Role ARN for seamless domain join", "Value": {"Fn::GetAtt": ["SeamlessDomainJoinRole", "Arn"]}}}}