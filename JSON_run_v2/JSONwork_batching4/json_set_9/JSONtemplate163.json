{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template for one Linux and three Windows EC2 instances that join an Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document.", "Parameters": {"ADDomainId": {"Type": "String", "Description": "The AWS Directory Service Domain ID."}, "InstanceType": {"Type": "String", "Default": "t3.medium", "Description": "EC2 instance type."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "The EC2 Key Pair to allow SSH/RDP access to the instances."}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "The Subnet ID."}, "DNS1": {"Type": "String", "Default": "", "Description": "Optional DNS server 1."}, "DNS2": {"Type": "String", "Default": "", "Description": "Optional DNS server 2."}, "VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC ID."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": "ami-0dc2d3e4c0f9ebd18", "SecurityGroupIds": [{"Ref": "SecurityGroupLinux"}], "BlockDeviceMappings": [{"DeviceName": "/dev/sda1", "Ebs": {"VolumeSize": 30, "VolumeType": "gp2"}}], "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": "ami-0c55b159cbfafe1f0", "SecurityGroupIds": [{"Ref": "SecurityGroupWindows"}], "BlockDeviceMappings": [{"DeviceName": "/dev/sda1", "Ebs": {"VolumeSize": 30, "VolumeType": "gp2"}}], "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": "ami-0c55b159cbfafe1f0", "SecurityGroupIds": [{"Ref": "SecurityGroupWindows"}], "BlockDeviceMappings": [{"DeviceName": "/dev/sda1", "Ebs": {"VolumeSize": 30, "VolumeType": "gp2"}}], "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": "ami-0c55b159cbfafe1f0", "SecurityGroupIds": [{"Ref": "SecurityGroupWindows"}], "BlockDeviceMappings": [{"DeviceName": "/dev/sda1", "Ebs": {"VolumeSize": 30, "VolumeType": "gp2"}}], "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "JoinDomainInlineSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "ADDomainId"}], "dnsIpAddresses": [{"Ref": "DNS1"}, {"Ref": "DNS2"}]}}}, "JoinDomainEC2IdsSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "LinuxInstance"}, {"Ref": "WindowsInstance2"}]}], "Parameters": {"directoryId": [{"Ref": "ADDomainId"}], "dnsIpAddresses": [{"Ref": "DNS1"}, {"Ref": "DNS2"}]}}}, "JoinDomainTagsSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance3"]}], "Parameters": {"directoryId": [{"Ref": "ADDomainId"}], "dnsIpAddresses": [{"Ref": "DNS1"}, {"Ref": "DNS2"}]}}}, "SecurityGroupLinux": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for Linux instance", "VpcId": {"Ref": "VpcId"}}}, "SecurityGroupWindows": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for Windows instances", "VpcId": {"Ref": "VpcId"}}}}, "Outputs": {"LinuxInstanceID": {"Description": "ID of the Linux instance", "Value": {"Ref": "LinuxInstance"}}, "WindowsInstance1ID": {"Description": "ID of the first Windows instance", "Value": {"Ref": "WindowsInstance1"}}, "WindowsInstance2ID": {"Description": "ID of the second Windows instance", "Value": {"Ref": "WindowsInstance2"}}, "WindowsInstance3ID": {"Description": "ID of the third Windows instance", "Value": {"Ref": "WindowsInstance3"}}}}