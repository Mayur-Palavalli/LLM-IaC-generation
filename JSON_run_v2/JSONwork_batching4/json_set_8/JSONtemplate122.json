{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to provision AWS Neptune Graph Database with CI/CD using CodePipeline, CodeBuild, and integration with CloudWatch and SNS.", "Parameters": {"NeptuneClusterName": {"Type": "String", "Description": "The name of the Neptune DB Cluster."}, "NotificationEmail": {"Type": "String", "Description": "Email address to receive SNS notifications."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The list of Subnet IDs for the Neptune DB Cluster."}, "CodeCommitRepoName": {"Type": "String", "Description": "The name of the CodeCommit repository."}, "CodeBuildProject": {"Type": "String", "Description": "The name of the CodeBuild project."}, "ArtifactStoreS3Bucket": {"Type": "String", "Description": "The name of the S3 bucket for artifact storage."}}, "Resources": {"NeptuneSubnetGroup": {"Type": "AWS::Neptune::DBSubnetGroup", "Properties": {"DBSubnetGroupDescription": "Subnet group for Neptune DB cluster.", "SubnetIds": {"Ref": "SubnetIds"}}}, "NeptuneDBCluster": {"Type": "AWS::Neptune::DBCluster", "Properties": {"DBClusterIdentifier": {"Ref": "NeptuneClusterName"}, "DBSubnetGroupName": {"Ref": "NeptuneSubnetGroup"}, "BackupRetentionPeriod": 1, "PreferredBackupWindow": "07:00-09:00", "PreferredMaintenanceWindow": "Mon:03:00-Mon:04:00"}}, "NeptuneDBInstance": {"Type": "AWS::Neptune::DBInstance", "Properties": {"DBInstanceClass": "db.r5.large", "DBClusterIdentifier": {"Ref": "NeptuneDBCluster"}}}, "CICDPipeline": {"Type": "AWS::CodePipeline::Pipeline", "Properties": {"RoleArn": {"Fn::GetAtt": ["PipelineRole", "Arn"]}, "ArtifactStore": {"Type": "S3", "Location": {"Ref": "ArtifactStoreS3Bucket"}}, "Stages": [{"Name": "Source", "Actions": [{"Name": "SourceAction", "ActionTypeId": {"Category": "Source", "Owner": "AWS", "Provider": "CodeCommit", "Version": "1"}, "OutputArtifacts": [{"Name": "SourceOutput"}], "Configuration": {"RepositoryName": {"Ref": "CodeCommitRepoName"}, "BranchName": "main"}}]}, {"Name": "Build", "Actions": [{"Name": "BuildAction", "ActionTypeId": {"Category": "Build", "Owner": "AWS", "Provider": "CodeBuild", "Version": "1"}, "InputArtifacts": [{"Name": "SourceOutput"}], "OutputArtifacts": [{"Name": "BuildOutput"}], "Configuration": {"ProjectName": {"Ref": "CodeBuildProject"}}}]}, {"Name": "Deploy", "Actions": [{"Name": "DeployAction", "ActionTypeId": {"Category": "Deploy", "Owner": "AWS", "Provider": "CloudFormation", "Version": "1"}, "InputArtifacts": [{"Name": "BuildOutput"}], "Configuration": {"ActionMode": "CHANGE_SET_REPLACE", "StackName": "NeptuneStack", "TemplatePath": "BuildOutput::template.yaml", "Capabilities": ["CAPABILITY_NAMED_IAM", "CAPABILITY_AUTO_EXPAND"]}}]}]}}, "PipelineRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": ["codepipeline.amazonaws.com", "codebuild.amazonaws.com"]}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "PipelinePolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["cloudformation:*", "codebuild:*", "codecommit:*", "s3:*", "iam:PassRole", "neptune:*"], "Resource": "*"}]}}]}}, "ArtifactStoreS3Bucket": {"Type": "AWS::S3::Bucket"}, "CloudWatchLogGroup": {"Type": "AWS::Logs::LogGroup", "Properties": {"LogGroupName": "/aws/neptune/logs", "RetentionInDays": 7}}, "SNSTopic": {"Type": "AWS::SNS::Topic", "Properties": {"Subscription": [{"Endpoint": {"Ref": "NotificationEmail"}, "Protocol": "email"}]}}, "CloudWatchAlarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"AlarmDescription": "Alarm if any error occurs in Neptune DB Cluster", "MetricName": "HealthyDBInstances", "Namespace": "AWS/Neptune", "Statistic": "Minimum", "Period": 60, "EvaluationPeriods": 5, "Threshold": 1, "ComparisonOperator": "LessThanThreshold", "AlarmActions": [{"Ref": "SNSTopic"}], "Dimensions": [{"Name": "DBClusterIdentifier", "Value": {"Ref": "NeptuneDBCluster"}}]}}}, "Outputs": {"NeptuneClusterEndpoint": {"Description": "The endpoint of the Neptune DB Cluster", "Value": {"Fn::GetAtt": ["NeptuneDBCluster", "Endpoint"]}}, "NeptuneReadEndpoint": {"Description": "The read endpoint of the Neptune DB Cluster", "Value": {"Fn::GetAtt": ["NeptuneDBCluster", "ReadEndpoint"]}}}}