{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create an AD Connector to connect to an on-premises directory.", "Parameters": {"VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "VPC ID for the resources"}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "Subnets for the AD Connector"}, "DnsIpAddresses": {"Type": "List<String>", "Description": "IP addresses of the DNS servers"}, "OnPremDomainName": {"Type": "String", "Description": "Fully Qualified Domain Name of the on-premises directory"}, "SeamlessDomainJoin": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Create the Seamless Domain Join resources"}, "CreateDomainMembersSecurityGroup": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Create the Domain Members Security Group"}, "CreateDHCPOptionSet": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Create the DHCP Options Set"}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "OnPremDomainName"}, "Password": {"Fn::Sub": "{{resolve:ssm-secure:AdminPassword}}"}, "VpcSettings": {"VpcId": {"Ref": "VPCId"}, "SubnetIds": {"Ref": "SubnetIds"}}}}, "SeamlessDomainJoinInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "SeamlessDomainJoinRole"}]}, "Condition": "CreateSeamlessDomainJoin"}, "SeamlessDomainJoinRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "SeamlessDomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:DescribeDirectories", "ec2:DescribeInstances", "ec2:DescribeRegions", "ssm:*"], "Resource": "*"}]}}]}, "Condition": "CreateSeamlessDomainJoin"}, "DomainMembersSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security Group for domain members", "VpcId": {"Ref": "VPCId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "10.0.0.0/8"}], "SecurityGroupEgress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}]}, "Condition": "CreateDomainMembersSecurityGroup"}, "DHCPOptionsSet": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Ref": "DnsIpAddresses"}, "DomainName": {"Ref": "OnPremDomainName"}}, "Condition": "CreateDHCPOptionSet"}, "DHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionsSet"}, "VpcId": {"Ref": "VPCId"}}, "Condition": "CreateDHCPOptionSet"}}, "Conditions": {"CreateSeamlessDomainJoin": {"Fn::Equals": [{"Ref": "SeamlessDomainJoin"}, "true"]}, "CreateDomainMembersSecurityGroup": {"Fn::Equals": [{"Ref": "CreateDomainMembersSecurityGroup"}, "true"]}, "CreateDHCPOptionSet": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "true"]}}, "Metadata": {"AWS::CloudFormation::Interface": {"ParameterGroups": [{"Label": {"default": "AD Connector Configuration"}, "Parameters": ["VPCId", "SubnetIds", "DnsIpAddresses", "OnPremDomainName", "SeamlessDomainJoin", "CreateDomainMembersSecurityGroup", "CreateDHCPOptionSet"]}], "ParameterLabels": {"VPCId": {"default": "VPC ID"}, "SubnetIds": {"default": "Subnet IDs"}, "DnsIpAddresses": {"default": "DNS IP Addresses"}, "OnPremDomainName": {"default": "On-Premises Domain Name"}, "SeamlessDomainJoin": {"default": "Seamless Domain Join"}, "CreateDomainMembersSecurityGroup": {"default": "Create Domain Members Security Group"}, "CreateDHCPOptionSet": {"default": "Create DHCP Option Set"}}}}}