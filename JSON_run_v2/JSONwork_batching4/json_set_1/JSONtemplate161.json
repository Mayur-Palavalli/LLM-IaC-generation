{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to create one Linux and three Windows EC2 instances and join them to Active Directory using AWS Systems Manager.", "Parameters": {"ADDomainName": {"Type": "String", "Description": "The fully qualified domain name of the Active Directory"}, "ADDirectoryId": {"Type": "String", "Description": "The directory ID of the AWS Managed Microsoft AD or AD Connector"}, "SSHDKeyPair": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the Linux instance"}, "InstanceType": {"Type": "String", "Default": "t2.micro", "Description": "EC2 instance type", "AllowedValues": ["t2.micro", "t2.small", "t2.medium"], "ConstraintDescription": "Must be a valid EC2 instance type."}, "ManualDnsServers": {"Type": "CommaDelimitedList", "Description": "Optional DNS servers to set on the instances (leave empty to use default route)"}}, "Resources": {"LinuxEC2Instance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "SSHDKeyPair"}, "ImageId": "ami-xxxxxxxx", "SecurityGroupIds": ["sg-xxxxxxxx"], "SubnetId": "subnet-xxxxxxxx", "IamInstanceProfile": "SSMInstanceProfile", "Tags": [{"Key": "Name", "Value": "LinuxInstance"}, {"Key": "Environment", "Value": "PROD"}]}}, "WindowsEC2Instance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-yyyyyyyy", "SecurityGroupIds": ["sg-yyyyyyyy"], "SubnetId": "subnet-yyyyyyyy", "IamInstanceProfile": "SSMInstanceProfile", "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}, {"Key": "Environment", "Value": "PROD"}]}}, "WindowsEC2Instance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-yyyyyyyy", "SecurityGroupIds": ["sg-yyyyyyyy"], "SubnetId": "subnet-yyyyyyyy", "IamInstanceProfile": "SSMInstanceProfile", "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}, {"Key": "Environment", "Value": "PROD"}]}}, "WindowsEC2Instance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": "ami-yyyyyyyy", "SecurityGroupIds": ["sg-yyyyyyyy"], "SubnetId": "subnet-yyyyyyyy", "IamInstanceProfile": "SSMInstanceProfile", "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}, {"Key": "Environment", "Value": "PROD"}]}}, "SSMInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Path": "/", "Roles": ["SSMRole"]}}, "SSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "Policies": [{"PolicyName": "SSMPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:*", "ec2messages:*", "ec2:DescribeInstanceStatus"], "Resource": "*"}]}}]}}, "ADJoinAssociationLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxEC2Instance"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}]}}}, "ADJoinAssociationWindows1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance1"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}]}}}, "ADJoinAssociationWindows2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance2"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}]}}}, "ADJoinAssociationWindows3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsEC2Instance3"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}]}}}}}