{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to provision AWS Neptune Graph Database with CI/CD, CloudWatch, and SNS.", "Resources": {"NeptuneClusterParameterGroup": {"Type": "AWS::Neptune::DBClusterParameterGroup", "Properties": {"Description": "Cluster parameter group for Neptune", "Family": "neptune1", "Parameters": {"neptune_enable_audit_log": "1"}}}, "NeptuneDBCluster": {"Type": "AWS::Neptune::DBCluster", "Properties": {"DBClusterParameterGroupName": {"Ref": "NeptuneClusterParameterGroup"}, "BackupRetentionPeriod": 7, "DBSubnetGroupName": {"Ref": "NeptuneDBSubnetGroup"}, "VpcSecurityGroupIds": [{"Ref": "NeptuneSecurityGroup"}], "StorageEncrypted": true}}, "NeptuneInstance": {"Type": "AWS::Neptune::DBInstance", "Properties": {"DBInstanceClass": "db.r5.large", "DBClusterIdentifier": {"Ref": "NeptuneDBCluster"}}}, "NeptuneDBSubnetGroup": {"Type": "AWS::Neptune::DBSubnetGroup", "Properties": {"DBSubnetGroupDescription": "Subnet group for Neptune", "SubnetIds": ["subnet-xxxxxx", "subnet-yyyyyy"]}}, "NeptuneSecurityGroup": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for Neptune", "VpcId": "vpc-xxxxxx", "SecurityGroupIngress": [{"IpProtocol": "tcp", "FromPort": 8182, "ToPort": 8182, "CidrIp": "0.0.0.0/0"}]}}, "CloudWatchMonitorNeptune": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"AlarmDescription": "CloudWatch Alarm to monitor Neptune", "Namespace": "AWS/Neptune", "MetricName": "CPUUtilization", "Dimensions": [{"Name": "DBInstanceIdentifier", "Value": {"Ref": "NeptuneInstance"}}], "Statistic": "Average", "Period": 300, "EvaluationPeriods": 1, "Threshold": 80, "ComparisonOperator": "GreaterThanThreshold", "AlarmActions": [{"Ref": "SnsTopic"}]}}, "SnsTopic": {"Type": "AWS::SNS::Topic", "Properties": {"TopicName": "NeptuneAlarmTopic"}}, "SnsSubscription": {"Type": "AWS::SNS::Subscription", "Properties": {"TopicArn": {"Ref": "SnsTopic"}, "Protocol": "email", "Endpoint": "user@example.com"}}, "CodePipelineRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "codepipeline.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "CodePipelinePolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["neptune:*", "cloudwatch:*", "sns:*", "ec2:*", "iam:PassRole"], "Resource": "*"}]}}]}}, "CodePipeline": {"Type": "AWS::CodePipeline::Pipeline", "Properties": {"RoleArn": {"Fn::GetAtt": ["CodePipelineRole", "Arn"]}, "Stages": [{"Name": "Source", "Actions": [{"Name": "SourceAction", "ActionTypeId": {"Category": "Source", "Owner": "AWS", "Provider": "S3", "Version": "1"}, "OutputArtifacts": [{"Name": "SourceOutput"}], "Configuration": {"S3Bucket": "my-source-bucket", "S3ObjectKey": "source.zip"}}]}, {"Name": "Deploy", "Actions": [{"Name": "DeployAction", "ActionTypeId": {"Category": "Deploy", "Owner": "AWS", "Provider": "CloudFormation", "Version": "1"}, "InputArtifacts": [{"Name": "SourceOutput"}], "Configuration": {"StackName": "MyNeptuneStack", "ActionMode": "CREATE_UPDATE", "TemplatePath": "SourceOutput::template.yml", "Capabilities": "CAPABILITY_IAM"}}]}], "ArtifactStore": {"Type": "S3", "Location": "my-artifact-store"}}}}, "Outputs": {"NeptuneDBClusterEndpoint": {"Value": {"Fn::GetAtt": ["NeptuneDBCluster", "Endpoint"]}, "Description": "Endpoint for the Neptune DB Cluster"}}}