{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create one Linux and three Windows EC2 instances and join them to an Active Directory domain using AWS Systems Manager Document 'AWS-JoinDirectoryServiceDomain'.", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The Directory ID of the AWS Managed Microsoft AD or AD Connector."}, "DnsServers": {"Type": "CommaDelimitedList", "Description": "Comma-delimited list of DNS servers. Leave empty to use default DNS servers."}}, "Resources": {"Ec2InstanceLinux": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-053b0d53c279acc90", "KeyName": "ec2-key-pair", "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "Ec2InstanceWindows01": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-0c55b159cbfafe1f0", "KeyName": "ec2-key-pair", "Tags": [{"Key": "Name", "Value": "WindowsInstance01"}]}}, "Ec2InstanceWindows02": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-0c55b159cbfafe1f0", "KeyName": "ec2-key-pair", "Tags": [{"Key": "Name", "Value": "WindowsInstance02"}]}}, "Ec2InstanceWindows03": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": "t2.micro", "ImageId": "ami-0c55b159cbfafe1f0", "KeyName": "ec2-key-pair", "Tags": [{"Key": "Name", "Value": "WindowsInstance03"}]}}, "SSMAssociationInline": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "Ec2InstanceWindows01"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": {"Fn::If": ["HasDnsServers", {"Ref": "DnsServers"}, {"Ref": "AWS::NoValue"}]}}}}, "SSMAssociationInstanceIds": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Fn::Join": [",", [{"Ref": "Ec2InstanceLinux"}, {"Ref": "Ec2InstanceWindows02"}]]}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": {"Fn::If": ["HasDnsServers", {"Ref": "DnsServers"}, {"Ref": "AWS::NoValue"}]}}}}, "SSMAssociationTags": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance02", "WindowsInstance03"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "dnsIpAddresses": {"Fn::If": ["HasDnsServers", {"Ref": "DnsServers"}, {"Ref": "AWS::NoValue"}]}}}}}, "Conditions": {"HasDnsServers": {"Fn::Not": [{"Fn::Equals": [{"Ref": "DnsServers"}, ""]}]}}}