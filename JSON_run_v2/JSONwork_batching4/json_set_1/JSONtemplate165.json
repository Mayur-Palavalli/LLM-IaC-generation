{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create EC2 instances and join them to Active Directory using AWS-JoinDirectoryServiceDomain SSM document.", "Parameters": {"DirectoryId": {"Type": "String", "Description": "ID of the AWS Managed Microsoft AD or AD Connector."}, "DomainName": {"Type": "String", "Description": "The fully qualified name of the Active Directory domain."}, "InstanceType": {"Type": "String", "Default": "t2.medium", "AllowedValues": ["t2.micro", "t2.small", "t2.medium", "t2.large"], "Description": "EC2 instance type"}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances"}, "DnsServers": {"Type": "CommaDelimitedList", "Description": "List of DNS servers (optional). Leave blank to use default DNS settings."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": "ami-0abcdef1234567890", "SSH Key AMI ID for Linux instances (Replace with appropriate value)": "", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": "ami-0abcdef1234567890", "SSH Key AMI ID for Windows instances (Replace with appropriate value)": "", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": "ami-0abcdef1234567890", "SSH Key AMI ID for Windows instances (Replace with appropriate value)": "", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": "ami-0abcdef1234567890", "SSH Key AMI ID for Windows instances (Replace with appropriate value)": "", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "SSMRole"}]}}, "SSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Path": "/", "Policies": [{"PolicyName": "SSMPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:DescribeAssociation", "ssm:GetDeployablePatchSnapshotForInstance", "ssm:GetDocument", "ssm:DescribeDocument", "ssm:GetParameters", "ssm:ListAssociations", "ssm:ListInstanceAssociations", "ssm:PutInventory", "ssm:PutComplianceItems", "ssm:PutConfigurePackageResult", "ssm:UpdateAssociationStatus", "ssm:UpdateInstanceAssociationStatus", "ssm:UpdateInstanceInformation"], "Resource": "*"}, {"Effect": "Allow", "Action": ["ec2messages:AcknowledgeMessage", "ec2messages:DeleteMessage", "ec2messages:FailMessage", "ec2messages:GetEndpoint", "ec2messages:GetMessages", "ec2messages:SendReply"], "Resource": "*"}, {"Effect": "Allow", "Action": "s3:*", "Resource": "*"}]}}]}}, "SSMAssociationById": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "DocumentVersion": "$DEFAULT", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": {"Ref": "DnsServers"}}}}, "SSMAssociationByTag": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "DocumentVersion": "$DEFAULT", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance3"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": [{"Ref": "DomainName"}], "dnsIpAddresses": {"Ref": "DnsServers"}}}}, "SSMAssociationInline": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": "ami-0abcdef1234567890", "IamInstanceProfile": {"Ref": "InstanceProfile"}, "Tags": [{"Key": "Name", "Value": "WindowsInstanceWithInlineSSM"}]}, "Metadata": {"AWS::CloudFormation::Init": {"configSets": {"domainJoin": ["joinDomain"]}, "joinDomain": {"commands": {"domainJoinCommand": {"command": {"fn::Join": ["", ["aws ssm send-command --document-name 'AWS-JoinDirectoryServiceDomain' --targets 'Key=instanceids,Values=", {"Ref": "WindowsInstanceWithInlineSSM"}, "' --parameters 'directoryId=", {"Ref": "DirectoryId"}, ",directoryName=", {"Ref": "DomainName"}, "'"]]}}}}}}}}}