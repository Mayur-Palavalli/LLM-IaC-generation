{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create Linux and Windows EC2 instances and join them to Active Directory using 'AWS-JoinDirectoryServiceDomain' SSM document", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the AWS Managed AD directory to join"}, "DnsIpAddresses": {"Type": "CommaDelimitedList", "Description": "Optional DNS IP addresses for the EC2 instances"}, "VpcId": {"Type": "String", "Description": "The ID of the VPC to associate DHCP options"}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-0c55b159cbfafe1f0", "InstanceType": "t2.micro", "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-04ad2567c9e3d7893", "InstanceType": "t2.micro", "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-04ad2567c9e3d7893", "InstanceType": "t2.micro", "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"ImageId": "ami-04ad2567c9e3d7893", "InstanceType": "t2.micro", "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "DnsOptions": {"Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Fn::Join": [",", {"Ref": "DnsIpAddresses"}]}}}, "DHCPOptionsAssociation": {"Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"VpcId": {"Ref": "VpcId"}, "DhcpOptionsId": {"Ref": "DnsOptions"}}}, "LinuxDomainJoinSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "WindowsDomainJoinSSMAssociation1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "WindowsDomainJoinSSMAssociation2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance2"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}, "WindowsDomainJoinSSMAssociationForTags": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance3"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}]}}}}}