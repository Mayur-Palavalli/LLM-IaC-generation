{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create an AD Connector to connect to an on-premises directory.", "Parameters": {"VpcId": {"Description": "VPC ID", "Type": "AWS::EC2::VPC::Id"}, "SubnetIds": {"Description": "Subnets for AD Connector", "Type": "List<AWS::EC2::Subnet::Id>"}, "DomainDNSName": {"Description": "The fully qualified name of the on-premises directory", "Type": "String"}, "CreateSeamlessDomainJoinResources": {"Description": "Create resources for seamless domain join", "Type": "String", "AllowedValues": ["Yes", "No"], "Default": "No"}, "CreateDomainMembersSecurityGroup": {"Description": "Create a security group for domain member instances", "Type": "String", "AllowedValues": ["Yes", "No"], "Default": "No"}, "CreateDHCPOptionSet": {"Description": "Create a DHCP Option Set pointing to the Domain DNS servers", "Type": "String", "AllowedValues": ["Yes", "No"], "Default": "No"}, "DomainDNS": {"Description": "DNS Servers for the domain", "Type": "CommaDelimitedList", "Default": "10.0.0.1,10.0.0.2"}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "DomainDNSName"}, "Password": "{{resolve:secretsmanager:ADPassword:SecretString}}", "VpcSettings": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Ref": "SubnetIds"}}}}, "SeamlessDomainJoinRole": {"Condition": "CreateSeamlessDomainJoinResourcesCondition", "Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ssm.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"], "Path": "/"}}, "DomainMembersSecurityGroup": {"Condition": "CreateDomainMembersSecurityGroupCondition", "Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VpcId"}, "GroupDescription": "Security group for domain member instances", "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}]}}, "DHCPOptionsSet": {"Condition": "CreateDHCPOptionSetCondition", "Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Fn::Split": [",", {"Fn::Join": [",", {"Ref": "DomainDNS"}]}]}, "DomainName": {"Ref": "DomainDNSName"}}}, "DHCPOptionsSetAssociation": {"Condition": "CreateDHCPOptionSetCondition", "Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"VpcId": {"Ref": "VpcId"}, "DhcpOptionsId": {"Ref": "DHCPOptionsSet"}}}}, "Conditions": {"CreateSeamlessDomainJoinResourcesCondition": {"Fn::Equals": [{"Ref": "CreateSeamlessDomainJoinResources"}, "Yes"]}, "CreateDomainMembersSecurityGroupCondition": {"Fn::Equals": [{"Ref": "CreateDomainMembersSecurityGroup"}, "Yes"]}, "CreateDHCPOptionSetCondition": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "Yes"]}}}