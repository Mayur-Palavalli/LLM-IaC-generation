{"AWSTemplateFormatVersion": "2010-09-09", "Description": "Create Linux and Windows EC2 instances and join them to Active Directory using AWS-JoinDirectoryServiceDomain SSM document.", "Parameters": {"ADDirectoryId": {"Type": "String", "Description": "The ID of the Directory to join."}, "InstanceType": {"Type": "String", "Default": "t3.medium", "Description": "EC2 instance type."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances."}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "Subnet ID for the EC2 instances."}, "DnsServers": {"Type": "CommaDelimitedList", "Description": "Comma separated DNS server IP addresses (optional)."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": "ami-0dc2d3e4c0f9ebd18", "Tags": [{"Key": "OS", "Value": "Linux"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/bin/bash\n", "yum install -y aws-cli\n"]]}}}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": "ami-0de53d8956e8dcf80", "Tags": [{"Key": "OS", "Value": "Windows"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Scope CurrentUser\n", "Install-Module -Name AWSPowerShell -Scope CurrentUser -Force\n", "Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force -Scope Process\n", "Import-Module -Name AWSPowerShell\n", "</powershell>\n"]]}}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": "ami-0de53d8956e8dcf80", "Tags": [{"Key": "OS", "Value": "Windows"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Scope CurrentUser\n", "Install-Module -Name AWSPowerShell -Scope CurrentUser -Force\n", "Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force -Scope Process\n", "Import-Module -Name AWSPowerShell\n", "</powershell>\n"]]}}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": "ami-0de53d8956e8dcf80", "Tags": [{"Key": "OS", "Value": "Windows"}], "UserData": {"Fn::Base64": {"Fn::Join": ["", ["<powershell>\n", "Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Scope CurrentUser\n", "Install-Module -Name AWSPowerShell -Scope CurrentUser -Force\n", "Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force -Scope Process\n", "Import-Module -Name AWSPowerShell\n", "</powershell>\n"]]}}}}, "LinuxInstanceSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}]}}}, "WindowsInstance1SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}]}}}, "WindowsInstance2SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance2"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}]}}}, "WindowsInstance3SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:OS", "Values": ["Windows"]}], "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "dnsIpAddresses": [{"Fn::Join": [",", {"Ref": "DnsServers"}]}]}}}}}