{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation template to create one Linux and three Windows EC2 instances, joining them to Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document.", "Parameters": {"DirectoryId": {"Type": "String", "Description": "The ID of the AWS Managed AD or AD Connector."}, "InstanceType": {"Type": "String", "Default": "t3.micro", "Description": "EC2 instance type."}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "The name of the key pair to use for SSH access to the Linux instance."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyName"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "AMI"]}}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}}}, "InstanceSSMRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "Policies": [{"PolicyName": "SSMPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ssm:SendCommand", "ssm:ListCommandInvocations", "ssm:ListCommands"], "Resource": "*"}]}}]}}, "InstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "InstanceSSMRole"}]}}, "SSMAssociationLinux": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "LinuxInstance"}]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": ["yourdomain.example.com"]}}}, "SSMAssociationWindows1": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": ["yourdomain.example.com"]}}}, "SSMAssociationWindows2": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "InstanceIds", "Values": [{"Ref": "WindowsInstance2"}]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": ["yourdomain.example.com"]}}}, "SSMAssociationWindows3": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Environment", "Values": ["Production"]}], "Parameters": {"directoryId": [{"Ref": "DirectoryId"}], "directoryName": ["yourdomain.example.com"]}}}}, "Mappings": {"RegionMap": {"us-east-1": {"AMI": "ami-0123456789abcdef0", "WindowsAMI": "ami-0abcdef1234567890"}, "us-west-2": {"AMI": "ami-0123456789abcdef1", "WindowsAMI": "ami-0abcdef1234567891"}, "eu-west-1": {"AMI": "ami-0123456789abcdef2", "WindowsAMI": "ami-0abcdef1234567892"}}}, "Outputs": {"LinuxInstanceID": {"Description": "ID of the Linux EC2 Instance", "Value": {"Ref": "LinuxInstance"}}, "WindowsInstance1ID": {"Description": "ID of the first Windows EC2 Instance", "Value": {"Ref": "WindowsInstance1"}}, "WindowsInstance2ID": {"Description": "ID of the second Windows EC2 Instance", "Value": {"Ref": "WindowsInstance2"}}, "WindowsInstance3ID": {"Description": "ID of the third Windows EC2 Instance", "Value": {"Ref": "WindowsInstance3"}}}}