{"AWSTemplateFormatVersion": "2010-09-09", "Description": "CloudFormation template to launch one Linux and three Windows EC2 instances and join them to Active Directory using the 'AWS-JoinDirectoryServiceDomain' SSM document.", "Parameters": {"ADDomainName": {"Type": "String", "Description": "The Active Directory domain name."}, "ADDirectoryId": {"Type": "String", "Description": "The ID of the Active Directory."}, "InstanceType": {"Type": "String", "Default": "t2.micro", "AllowedValues": ["t2.micro", "t2.small", "t2.medium"], "Description": "EC2 instance type."}, "KeyPairName": {"Type": "String", "Description": "The EC2 Key Pair to allow SSH access to the instances."}, "SubnetId": {"Type": "AWS::EC2::Subnet::Id", "Description": "The Subnet ID where the instances will be deployed."}}, "Resources": {"LinuxInstance": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyPairName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "LinuxAMI"]}, "Tags": [{"Key": "Name", "Value": "LinuxInstance"}]}}, "WindowsInstance1": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyPairName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}, "Tags": [{"Key": "Name", "Value": "WindowsInstance1"}]}}, "WindowsInstance2": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyPairName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}, "Tags": [{"Key": "Name", "Value": "WindowsInstance2"}]}}, "WindowsInstance3": {"Type": "AWS::EC2::Instance", "Properties": {"InstanceType": {"Ref": "InstanceType"}, "KeyName": {"Ref": "KeyPairName"}, "SubnetId": {"Ref": "SubnetId"}, "ImageId": {"Fn::FindInMap": ["RegionMap", {"Ref": "AWS::Region"}, "WindowsAMI"]}, "Tags": [{"Key": "Name", "Value": "WindowsInstance3"}]}}, "LinuxInstanceSSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "LinuxInstance"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}]}}}, "WindowsInstance1SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance1"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}]}}}, "WindowsInstance2SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "InstanceId": {"Ref": "WindowsInstance2"}, "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}]}}}, "WindowsInstance3SSMAssociation": {"Type": "AWS::SSM::Association", "Properties": {"Name": "AWS-JoinDirectoryServiceDomain", "Targets": [{"Key": "tag:Name", "Values": ["WindowsInstance3"]}], "Parameters": {"directoryId": [{"Ref": "ADDirectoryId"}], "directoryName": [{"Ref": "ADDomainName"}]}}}}, "Mappings": {"RegionMap": {"us-east-1": {"LinuxAMI": "ami-0abcdef1234567890", "WindowsAMI": "ami-0abcdef1234567890"}, "us-west-2": {"LinuxAMI": "ami-0abcdef1234567890", "WindowsAMI": "ami-0abcdef1234567890"}}}}