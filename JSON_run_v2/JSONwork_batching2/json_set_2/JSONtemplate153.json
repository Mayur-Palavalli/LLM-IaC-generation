{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation Template to create an AD Connector to connect to an on-premises directory with options for seamless domain join, security group, and DHCP option set.", "Parameters": {"VPCId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC ID where the AD Connector will be deployed."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The subnet IDs where the AD Connector instances will be deployed."}, "DomainDNSIPs": {"Type": "List<String>", "Description": "Comma-separated list of IP addresses for the on-premises DNS servers."}, "OnPremDomainName": {"Type": "String", "Description": "The fully qualified domain name (FQDN) of the on-premises directory."}, "ServiceAccountUsername": {"Type": "String", "Description": "Username of the service account that AD Connector will use to connect to the on-premises directory."}, "ServiceAccountPassword": {"Type": "String", "Description": "Password of the service account that AD Connector will use to connect to the on-premises directory.", "NoEcho": true}, "CreateSeamlessDomainJoin": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Option to create seamless domain join resources for Windows & Linux EC2 instances."}, "CreateSecurityGroup": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Option to create a domain members security group that allows all PrivateIP communications inbound."}, "CreateDHCPOptionSet": {"Type": "String", "AllowedValues": ["true", "false"], "Default": "false", "Description": "Option to create a DHCPOptionSet pointing to Domain DNS servers."}}, "Resources": {"ADConnector": {"Type": "AWS::DirectoryService::MicrosoftAD", "Properties": {"Name": {"Ref": "OnPremDomainName"}, "Password": {"Fn::Sub": "{{resolve:ssm-secure:${ServiceAccountPassword}}}"}, "VpcSettings": {"SubnetIds": {"Ref": "SubnetIds"}, "VpcId": {"Ref": "VPCId"}}, "ShortName": {"Fn::Select": [0, {"Fn::Split": [".", {"Ref": "OnPremDomainName"}]}]}, "Edition": "Standard"}}, "SeamlessDomainJoinRole": {"Condition": "CreateSeamlessDomainJoinCondition", "Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"], "Policies": [{"PolicyName": "SeamlessDomainJoinPolicy", "PolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Action": ["ds:DescribeDirectories", "ds:CreateComputer", "ds:CreateInstance", "ds:JoinDomain"], "Resource": "*"}]}}]}}, "DomainMembersSecurityGroup": {"Condition": "CreateSecurityGroupCondition", "Type": "AWS::EC2::SecurityGroup", "Properties": {"GroupDescription": "Security group for AD domain joined instances", "VpcId": {"Ref": "VPCId"}, "SecurityGroupIngress": [{"IpProtocol": "-1", "CidrIp": "10.0.0.0/8"}]}}, "DHCPOptionsSet": {"Condition": "CreateDHCPOptionSetCondition", "Type": "AWS::EC2::DHCPOptions", "Properties": {"DomainNameServers": {"Ref": "DomainDNSIPs"}, "DomainName": {"Ref": "OnPremDomainName"}}}, "DHCPOptionsAssociation": {"Condition": "CreateDHCPOptionSetCondition", "Type": "AWS::EC2::VPCDHCPOptionsAssociation", "Properties": {"DhcpOptionsId": {"Ref": "DHCPOptionsSet"}, "VpcId": {"Ref": "VPCId"}}}}, "Conditions": {"CreateSeamlessDomainJoinCondition": {"Fn::Equals": [{"Ref": "CreateSeamlessDomainJoin"}, "true"]}, "CreateSecurityGroupCondition": {"Fn::Equals": [{"Ref": "CreateSecurityGroup"}, "true"]}, "CreateDHCPOptionSetCondition": {"Fn::Equals": [{"Ref": "CreateDHCPOptionSet"}, "true"]}}}