{"AWSTemplateFormatVersion": "2010-09-09", "Description": "AWS CloudFormation Sample Template for EKS Cluster on EC2", "Parameters": {"VpcId": {"Type": "AWS::EC2::VPC::Id", "Description": "The VPC ID to launch the EKS cluster into."}, "SubnetIds": {"Type": "List<AWS::EC2::Subnet::Id>", "Description": "The subnets to launch the EKS cluster into."}, "ClusterName": {"Type": "String", "Description": "The name of the EKS cluster", "Default": "MyEKSCluster"}, "NodeInstanceType": {"Type": "String", "Default": "t3.medium", "Description": "EC2 instance type for the EKS worker nodes"}, "KeyName": {"Type": "AWS::EC2::KeyPair::KeyName", "Description": "The EC2 Key Pair to allow SSH access to the instances"}}, "Resources": {"EKSCluster": {"Type": "AWS::EKS::Cluster", "Properties": {"Name": {"Ref": "ClusterName"}, "ResourcesVpcConfig": {"VpcId": {"Ref": "VpcId"}, "SubnetIds": {"Ref": "SubnetIds"}}, "RoleArn": {"Fn::GetAtt": ["NodeGroupRole", "Arn"]}}}, "NodeGroupRole": {"Type": "AWS::IAM::Role", "Properties": {"AssumeRolePolicyDocument": {"Version": "2012-10-17", "Statement": [{"Effect": "Allow", "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole"}]}, "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy", "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy", "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"]}}, "NodeLaunchConfiguration": {"Type": "AWS::AutoScaling::LaunchConfiguration", "Properties": {"InstanceType": {"Ref": "NodeInstanceType"}, "KeyName": {"Ref": "KeyName"}, "IamInstanceProfile": {"Ref": "NodeInstanceProfile"}, "ImageId": "ami-0c7a4976cb6fafd3a", "UserData": {"Fn::Base64": {"Fn::Join": ["", ["#!/bin/bash\n", "set -o xtrace\n", "export CLUSTER_NAME=", {"Ref": "ClusterName"}, "\n", "/etc/eks/bootstrap.sh ${CLUSTER_NAME} --kubelet-extra-args '--node-labels=node.kubernetes.io/lifecycle=on-demand --register-with-taints=node.kubernetes.io/lifecycle=on-demand:NoSchedule'\n"]]}}}}, "NodeAutoScalingGroup": {"Type": "AWS::AutoScaling::AutoScalingGroup", "Properties": {"LaunchConfigurationName": {"Ref": "NodeLaunchConfiguration"}, "MinSize": "1", "MaxSize": "3", "DesiredCapacity": "1", "VPCZoneIdentifier": {"Ref": "SubnetIds"}, "Tags": [{"Key": "Name", "Value": {"Ref": "ClusterName"}, "PropagateAtLaunch": "true"}]}}, "NodeInstanceProfile": {"Type": "AWS::IAM::InstanceProfile", "Properties": {"Roles": [{"Ref": "NodeGroupRole"}]}}}, "Outputs": {"ClusterName": {"Description": "The name of the EKS Cluster", "Value": {"Ref": "ClusterName"}}, "ClusterEndpoint": {"Description": "The endpoint for the EKS control plane", "Value": {"Fn::GetAtt": ["EKSCluster", "Endpoint"]}}, "ClusterArn": {"Description": "The ARN of the EKS cluster", "Value": {"Fn::GetAtt": ["EKSCluster", "Arn"]}}}}